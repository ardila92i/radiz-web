// === CONFIGURACIÓN BÁSICA ===
const SHEET_NAMES = {
  contratos: 'CONTRATOS',
  pagos: 'PAGOS',
  mantenimientos: 'MANTENIMIENTOS',
  pagosPortal: 'PAGOS_PORTAL',
  afiliados: 'AFILIADOS',
  vehiculos: 'VEHÍCULOS'
};

// Función principal: se llama con ?id=ID_CONTRATO
function doGet(e) {
  e = e || { parameter: {} };
  const idContrato = (e.parameter.id || '').trim();

  if (!idContrato) {
    return jsonResponse({
      ok: false,
      error: 'Falta el parámetro id (ID CONTRATO).'
    });
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // Hojas base
  const contratos = getSheetAsObjects(ss.getSheetByName(SHEET_NAMES.contratos));
  const pagos = getSheetAsObjects(ss.getSheetByName(SHEET_NAMES.pagos));
  const mantenimientos = getSheetAsObjects(ss.getSheetByName(SHEET_NAMES.mantenimientos));
  const afiliados = getSheetAsObjects(ss.getSheetByName(SHEET_NAMES.afiliados));
  const vehiculos = getSheetAsObjects(ss.getSheetByName(SHEET_NAMES.vehiculos));

  // Buscar contrato
  const contrato = contratos.find(function (r) {
    return String(r['ID CONTRATO']).trim() === idContrato;
  });

  if (!contrato) {
    return jsonResponse({
      ok: false,
      error: 'Contrato no encontrado.',
      idContrato: idContrato
    });
  }

  // Datos comunes
  const pagosContrato = pagos.filter(function (r) {
    return String(r['ID CONTRATO']).trim() === idContrato;
  });

  const mantenimientosContrato = mantenimientos.filter(function (r) {
    return String(r['ID CONTRATO']).trim() === idContrato;
  });

  // Resultado base: devolvemos también TODA la tabla de afiliados y vehículos
  var resultado = {
    ok: true,
    idContrato: idContrato,
    contrato: contrato,
    pagos: pagosContrato,
    mantenimientos: mantenimientosContrato,
    afiliados: afiliados,
    vehiculos: vehiculos
  };

  return jsonResponse(resultado);
}

// Registrar pagos y otras acciones desde el portal (POST)
function doPost(e) {
  e = e || { parameter: {} };
  const accion = (e.parameter.accion || '').toString();

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  if (accion === 'registrar_pago' || accion === 'registrar_pago_portal') {
    const referencia = (e.parameter.referencia || '').toString();
    const idContrato = (e.parameter.idContrato || '').toString();
    const monto = Number(e.parameter.monto || 0);

    // Nuevos parámetros opcionales desde el portal
    const statusWompiRaw = (e.parameter.statusWompi || '').toString().toUpperCase();
    const estadoParamRaw = (e.parameter.estado || '').toString().toUpperCase();

    // Clasificación final: APROBADA / DECLINADA / PENDIENTE
    let estadoFinal = 'PENDIENTE';

    if (estadoParamRaw === 'APROBADA' || estadoParamRaw === 'DECLINADA' || estadoParamRaw === 'PENDIENTE') {
      estadoFinal = estadoParamRaw;
    } else {
      if (statusWompiRaw === 'APPROVED') {
        estadoFinal = 'APROBADA';
      } else if (statusWompiRaw === 'DECLINED') {
        estadoFinal = 'DECLINADA';
      } else {
        estadoFinal = 'PENDIENTE';
      }
    }

    const hoja = ss.getSheetByName(SHEET_NAMES.pagosPortal);
    if (!hoja) {
      return jsonResponse({ ok: false, error: 'Hoja PAGOS_PORTAL no encontrada.' });
    }

    hoja.appendRow([
      new Date(),
      referencia,
      idContrato,
      monto,
      estadoFinal,
      'PORTAL_WEB'
    ]);

    return jsonResponse({ ok: true });
  }

  // --- NUEVO: actualizar kilometraje en hoja VEHÍCULOS, columna G (KILOMETRAJE) ---
  if (accion === 'actualizar_kilometraje') {
    const idContrato = (e.parameter.idContrato || '').toString().trim();
    const idVehiculo = (e.parameter.idVehiculo || '').toString().trim();
    const kilometraje = Number(e.parameter.kilometraje || 0);

    if (!idContrato || !kilometraje) {
      return jsonResponse({
        ok: false,
        error: 'Faltan datos para actualizar el kilometraje.'
      });
    }

    const hojaVeh = ss.getSheetByName(SHEET_NAMES.vehiculos);
    if (!hojaVeh) {
      return jsonResponse({ ok: false, error: 'Hoja VEHÍCULOS no encontrada.' });
    }

    const registros = getSheetAsObjects(hojaVeh);
    let index = registros.findIndex(function (r) {
      const idC = String(r['ID CONTRATO'] || '').trim();
      const idV = String(r['ID VEHÍCULO'] || r['ID VEHICULO'] || '').trim();
      return idC === idContrato || (idVehiculo && idV === idVehiculo);
    });

    if (index === -1) {
      return jsonResponse({
        ok: false,
        error: 'No se encontró el vehículo para ese contrato.'
      });
    }

    // +2 porque en getSheetAsObjects se omite la fila de encabezados
    const fila = index + 2;
    const headers = hojaVeh.getDataRange().getValues()[0];
    const colKm = headers.indexOf('KILOMETRAJE') + 1;

    if (colKm <= 0) {
      return jsonResponse({
        ok: false,
        error: 'No se encontró la columna KILOMETRAJE en VEHÍCULOS.'
      });
    }

    hojaVeh.getRange(fila, colKm).setValue(kilometraje);

    return jsonResponse({ ok: true });
  }

  // --- NUEVO: notificar incidente -> hoja VEHÍCULOS, columna I (OBSERVACIONES) ---
  if (accion === 'notificar_incidente') {
    const idContrato = (e.parameter.idContrato || '').toString().trim();
    const idVehiculo = (e.parameter.idVehiculo || '').toString().trim();
    const descripcion = (e.parameter.descripcion || '').toString().trim();
    const fecha = (e.parameter.fecha || '').toString().trim();

    if (!idContrato || !descripcion) {
      return jsonResponse({
        ok: false,
        error: 'Faltan datos para registrar el incidente.'
      });
    }

    const hojaVeh = ss.getSheetByName(SHEET_NAMES.vehiculos);
    if (!hojaVeh) {
      return jsonResponse({ ok: false, error: 'Hoja VEHÍCULOS no encontrada.' });
    }

    const registros = getSheetAsObjects(hojaVeh);
    let index = registros.findIndex(function (r) {
      const idC = String(r['ID CONTRATO'] || '').trim();
      const idV = String(r['ID VEHÍCULO'] || r['ID VEHICULO'] || '').trim();
      return idC === idContrato || (idVehiculo && idV === idVehiculo);
    });

    if (index === -1) {
      return jsonResponse({
        ok: false,
        error: 'No se encontró el vehículo para registrar el incidente.'
      });
    }

    const fila = index + 2;
    const headers = hojaVeh.getDataRange().getValues()[0];
    const colObs = headers.indexOf('OBSERVACIONES') + 1;

    if (colObs <= 0) {
      return jsonResponse({
        ok: false,
        error: 'No se encontró la columna OBSERVACIONES en VEHÍCULOS.'
      });
    }

    const rangoObs = hojaVeh.getRange(fila, colObs);
    const anterior = String(rangoObs.getValue() || '').trim();
    const textoFecha = fecha ? '[' + fecha + '] ' : '';
    const nuevoTexto = textoFecha + descripcion;
    const finalTexto = anterior ? (anterior + '\n' + nuevoTexto) : nuevoTexto;

    rangoObs.setValue(finalTexto);

    return jsonResponse({ ok: true });
  }

  return jsonResponse({ ok: false, error: 'Acción no válida.' });
}

// === UTILIDADES ===

function getSheetAsObjects(sheet) {
  if (!sheet) return [];

  const values = sheet.getDataRange().getValues();
  if (values.length < 2) return [];

  const headers = values[0].map(function (h) {
    return String(h).trim();
  });
  const rows = values.slice(1);

  return rows
    .filter(function (row) {
      return row.some(function (cell) {
        return cell !== '' && cell !== null;
      });
    })
    .map(function (row) {
      const obj = {};
      headers.forEach(function (h, i) {
        obj[h] = row[i];
      });
      return obj;
    });
}

function jsonResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
