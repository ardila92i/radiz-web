<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PORTAL CLIENTES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://checkout.wompi.co/widget.js" async></script>
  <style>
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f3f4f6;
      margin:0;
      padding:0;
    }
    .container{
      max-width:900px;
      margin:40px auto;
      background:#fff;
      border-radius:16px;
      box-shadow:0 18px 45px rgba(15,23,42,.16);
      padding:24px 28px 32px;
      position:relative;
    }
    h1{
      margin-top:0;
      font-size:1.8rem;
      color:#111827;
    }
    .subtitle{
      color:#6b7280;
      font-size:.95rem;
      margin-bottom:20px;
    }
    .form-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:20px;
      align-items:flex-end;
    }
    label{
      font-size:.9rem;
      color:#374151;
      font-weight:600;
    }
    input[type=text],input[type=number],input[type=email]{
      flex:1;
      min-width:200px;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid:#d1d5db;
      font-size:.95rem;
      outline:none;
      box-sizing:border-box;
    }
    input[type=text]:focus,input[type=number]:focus,input[type=email]:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.15);
    }
    button{
      padding:10px 18px;
      border-radius:999px;
      border:none;
      font-size:.95rem;
      font-weight:600;
      cursor:pointer;
      background:#2563eb;
      color:#fff;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    button:disabled{
      opacity:.6;
      cursor:default;
    }
    .status{
      font-size:.9rem;
      margin-bottom:16px;
      min-height:1.2em;
    }
    .status.error{color:#b91c1c}
    .status.ok{color:#065f46}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:16px;
      margin-top:16px;
    }
    .card{
      border-radius:10px;
      border:1px solid #e5e7eb;
      padding:14px 16px;
      background:#f9fafb;
      font-size:.9rem;
    }
    .card h2{
      margin:0 0 8px;
      font-size:1.05rem;
      color:#111827;
    }
    .card p{
      margin:3px 0;
      color:#111827; /* texto de información en negro */
      font-size:.9rem;
    }
    .card p strong{
      font-weight:600;
      color:#111827;
    }
    ul{
      padding-left:18px;
      margin:6px 0;
    }
    li{
      margin-bottom:4px;
    }
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:600;
      text-transform:uppercase;
    }
    .badge-activo{
      background:#dcfce7;
      color:#166534;
    }
    .badge-inactivo{
      background:#fee2e2;
      color:#b91c1c;
    }
    footer{
      margin-top:24px;
      font-size:.75rem;
      color:#9ca3af;
      text-align:center;
    }
    .logo-top{
      text-align:center;
      margin-bottom:12px;
    }
    .logo-top img{
      max-width:260px;
      max-height:120px;
      object-fit:contain;
    }
    /* sección pago */
    #seccionPago{
      margin-top:24px;
    }
    #seccionPago h2{
      font-size:1rem;
      margin:0 0 4px;
      color:#111827;
    }
    #seccionPago p{
      font-size:.9rem;
      color:#6b7280;
      margin:4px 0 12px;
    }
    .pago-row{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    /* input de monto tamaño pequeño como antes */
    #montoPago{
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      width:200px;
      box-sizing:border-box;
    }

    /* botón menú flotante */
    .menu-button{
      position:absolute;
      top:22px;
      right:22px;
      width:48px;
      height:48px;
      border-radius:999px;
      background:#2563eb;
      box-shadow:0 12px 25px rgba(37,99,235,.4);
      display:none;          /* se muestra sólo con contrato cargado */
      align-items:center;
      justify-content:center;
      cursor:pointer;
      border:none;
      color:#fff;
    }
    .menu-icon-line{
      width:22px;
      height:2px;
      background:#fff;
      border-radius:999px;
      margin:3px 0;
    }

    /* modal genérico */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.5);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal{
      background:#fff;
      border-radius:16px;
      padding:20px 22px 18px;
      max-width:420px;
      width:90%;
      box-shadow:0 20px 50px rgba(15,23,42,.25);
      font-size:.95rem;
      color:#111827;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .modal-title{
      font-size:1.05rem;
      font-weight:700;
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size:1.1rem;
      cursor:pointer;
      color:#6b7280;
    }
    .modal-body p{
      margin:6px 0;
    }
    /* opciones dentro del modal del menú como botones, no links subrayados */
    .menu-option-btn{
      width:100%;
      text-align:left;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      margin-top:8px;
      font-size:.9rem;
      cursor:pointer;
      color:#111827;
    }
    .menu-option-btn:hover{
      background:#eff6ff;
      border-color:#2563eb;
    }

    @media(max-width:600px){
      .container{
        margin:16px;
        padding:18px 16px 22px;
      }
      .menu-button{
        top:16px;
        right:16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <button id="btnMenu" class="menu-button" type="button" aria-label="Menú">
      <div class="menu-icon-line"></div>
      <div class="menu-icon-line"></div>
      <div class="menu-icon-line"></div>
    </button>

    <div class="logo-top">
      <img src="logoradiz.png" alt="Logo RADIZ" id="logo-radiz" />
    </div>

    <h1>PORTAL CLIENTES</h1>
    <p class="subtitle">
      Ingresa el <strong>ID del contrato</strong> para consultar el estado, pagos y mantenimientos.
    </p>

    <div class="form-row">
      <div style="flex:1">
        <label for="idContrato">ID CONTRATO</label><br />
        <input type="text" id="idContrato" placeholder="Ejemplo: R-0001" />
      </div>
      <div>
        <button id="btnConsultar" type="button" onclick="consultar()">Consultar</button>
      </div>
    </div>

    <div id="status" class="status"></div>

    <div class="grid" id="resultados" style="display:none;">
      <div class="card" id="cardContrato"></div>
      <div class="card" id="cardPagos"></div>
      <div class="card" id="cardMantenimientos"></div>
    </div>

    <div id="seccionPago">
      <h2>Realizar pago</h2>
      <p>Ingresa el monto a pagar y completa el proceso con Wompi.</p>
      <label for="montoPago" style="display:block;margin-bottom:6px;">Monto a pagar (COP)</label>
      <div class="pago-row">
        <input id="montoPago" type="number" min="100000" step="1000" placeholder="Ej: 170000" />
        <button type="button" onclick="crearPagoWompi()">Pagar con Wompi</button>
      </div>
      <p id="pagoError" style="color:#dc2626;margin-top:8px;display:none;font-size:.85rem;">Ingresa un monto válido (mínimo 100.000).</p>
    </div>

    <footer>Versión interna • RADIZ Suministro Vehicular</footer>
  </div>

  <!-- Modal genérico -->
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Título</div>
        <button class="modal-close" type="button" onclick="cerrarModal()">×</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    // ====== CONSTANTES ======
    const API_URL='https://script.google.com/macros/s/AKfycbxNiAZCMVvaagzFjYQgIsQkGEWJPui9baIHcO_-JjeJ6HvDYdDU5BdH8R6zzD3zDUw/exec';
    const WOMPI_PUBLIC_KEY='pub_test_3dus3DoqOnuXmuGDbXVVVZEbhUNsHVfI';
    const WOMPI_REDIRECT_URL='https://portal.radizco.com/';

    // estado actual para el menú / modales
    let ultimoContratoData=null;
    let ultimoTipoUsuario=null;
    let ultimoResumenAfiliado=null;   // datos de hoja AFILIADOS
    let ultimoVehiculosAfiliado=0;    // cantidad vehículos
    let ultimoDiasCorteAfiliado=null; // fecha de pagos

    const btnMenu=document.getElementById('btnMenu');

    // ====== CONSULTA PRINCIPAL ======
    async function consultar(){
      const id=document.getElementById('idContrato').value.trim();
      const status=document.getElementById('status');
      const btn=document.getElementById('btnConsultar');
      const resultados=document.getElementById('resultados');
      const cardContrato=document.getElementById('cardContrato');
      const cardPagos=document.getElementById('cardPagos');
      const cardMantenimientos=document.getElementById('cardMantenimientos');

      status.className='status';
      status.textContent='';
      resultados.style.display='none';
      btnMenu.style.display='none';  // menú oculto hasta que cargue

      if(!id){
        status.classList.add('error');
        status.textContent='Por favor ingresa un ID de contrato.';
        return;
      }

      btn.disabled=true;
      status.textContent='Consultando información...';

      try{
        const resp=await fetch(API_URL+'?id='+encodeURIComponent(id));
        const data=await resp.json();

        if(!data.ok){
          status.className='status error';
          status.textContent=data.error||'No se encontró información para ese contrato.';
          btn.disabled=false;
          ultimoContratoData=null;
          return;
        }

        ultimoContratoData=data;

        const c=data.contrato||{};
        const tipo=(c['TIPO USUARIO']||'').toString().toUpperCase();
        ultimoTipoUsuario=tipo;

        // ----- RENDER PARA RENTING -----
        if(tipo.startsWith('RENTING')){
          // tarjeta contrato
          const estado=(c['ESTADO']||'').toString().toUpperCase();
          cardContrato.innerHTML=
            '<h2>Contrato</h2>'+
            '<p><strong>ID contrato:</strong> '+(c['ID CONTRATO']||'')+'</p>'+
            '<p><strong>Tipo usuario:</strong> '+(c['TIPO USUARIO']||'')+'</p>'+
            '<p><strong>Vehículo:</strong> '+(c['ID VEHÍCULO']||'')+'</p>'+
            '<p><strong>Inicio:</strong> '+formatearFecha(c['INICIO'])+'</p>'+
            '<p><strong>Fin:</strong> '+formatearFecha(c['FIN'])+'</p>'+
            '<p><strong>Tarifa semanal:</strong> '+formatearNumero(c['TARIFA SEMANAL'])+'</p>'+
            '<p><strong>Beneficios:</strong> '+(c['BENEFICIOS']||'')+'</p>'+
            '<p><span class="badge '+(estado==='ACTIVO'?'badge-activo':'badge-inactivo')+'">'+(estado||'SIN ESTADO')+'</span></p>';

          // pagos (hoja PAGOS)
          const pagos=data.pagos||[];
          if(pagos.length===0){
            cardPagos.innerHTML='<h2>Pagos</h2><p>No hay pagos registrados para este contrato.</p>';
          }else{
            const items=pagos.map(p=>
              '<li>'+
              '<strong>ID pago:</strong> '+(p['ID PAGO']||'')+'<br>'+
              '<strong>Días de corte:</strong> '+(p['DÍAS DE CORTE']||p['DIAS DE CORTE']||'')+'<br>'+
              '<strong>Gasto mantenimientos:</strong> '+formatearNumero(p['GASTO MANTENIMIENTOS'])+'<br>'+
              '<strong>Tarifas completadas:</strong> '+(p['TARIFAS COMPLETADAS']||'')+'<br>'+
              '<strong>Tarifas vencidas:</strong> '+(p['TARIFAS VENCIDAS']||'')+
              '</li>'
            ).join('');
            cardPagos.innerHTML='<h2>Pagos</h2><ul>'+items+'</ul>';
          }

          // mantenimientos (títulos nuevos)
          const mts = Array.isArray(data.mantenimientos)?data.mantenimientos:[];
          if(mts.length===0){
            cardMantenimientos.innerHTML='<h2>Mantenimientos</h2><p>No hay mantenimientos registrados para este contrato.</p>';
          }else{
            const totalM = mts.reduce((s,m)=>s+(Number(m['VALOR MTOS'])||0),0);
            const itemsM=mts.map(m=>
              '<li>'+
              '<strong>Último mantenimiento:</strong> '+formatearFecha(m['FECHA ULT. MANTENIMIENTO'])+'<br>'+
              '<strong>Tipo:</strong> '+(m['TIPO ULT. MANTENIMIENTO']||'')+'<br>'+
              '<strong>Realizados:</strong> '+(m['MTOS REALIZADOS']||'')+'<br>'+
              '<strong>Valor general:</strong> '+formatearNumero(m['VALOR MTOS'])+
              '</li>'
            ).join('');
            cardMantenimientos.innerHTML=
              '<h2>Mantenimientos</h2>'+
              '<p><strong>Valor total mantenimientos:</strong> '+formatearNumero(totalM)+'</p>'+
              '<ul>'+itemsM+'</ul>';
          }

          // menú visible sólo cuando hay contrato
          btnMenu.style.display='flex';
        }
        // ----- RENDER PARA AFILIADO -----
        else if(tipo==='AFILIADO'){
          // datos desde hoja AFILIADOS
          const afiliado = data.afiliado || data.afiliadoInfo || null;
          ultimoResumenAfiliado = afiliado;

          const nombreAfiliado = afiliado ? (afiliado['NOMBRE']||'') : (c['ID CLIENTE']||'');
          const documento = afiliado ? (afiliado['NO DOCUMENTO']||'') : '';
          const numLiqui = afiliado ? (afiliado['NO LIQUIDACIONES']||'') : '';
          const valorLiqui = afiliado ? afiliado['VALOR LIQUIDADO'] : '';

          cardContrato.innerHTML =
            '<h2>Afiliado</h2>'+
            '<p><strong>ID contrato:</strong> '+(c['ID CONTRATO']||'')+'</p>'+
            '<p><strong>Nombre:</strong> '+(nombreAfiliado||'Dato no disponible')+'</p>'+
            '<p><strong>Documento:</strong> '+(documento||'Dato no disponible')+'</p>'+
            '<p><strong>No. liquidaciones:</strong> '+(numLiqui||'Dato no disponible')+'</p>'+
            '<p><strong>Valor liquidado:</strong> '+(valorLiqui?valorLiqui:'Dato no disponible')+'</p>';

          // pagos: sólo título "Pagos" y fecha de inicio
          const pagos=data.pagos||[];
          const diasCorte = pagos.length>0 ? (pagos[0]['DÍAS DE CORTE']||pagos[0]['DIAS DE CORTE']||'') : '';
          ultimoDiasCorteAfiliado = diasCorte || null;

          cardPagos.innerHTML =
            '<h2>Pagos</h2>'+
            '<p><strong>Días de corte:</strong> '+(diasCorte||'Dato no disponible')+'</p>'+
            '<p><strong>Inicio contrato:</strong> '+formatearFecha(c['INICIO'])+'</p>';

          // vehículos & mantenimientos
          const vehiculosArr = data.vehiculosAfiliado || data.vehiculos || [];
          const vehiculosCount = Array.isArray(vehiculosArr)
            ? vehiculosArr.filter(v => String(v['ID CONTRATO']||'').trim() === String(c['ID CONTRATO']||'').trim()).length
            : 0;
          ultimoVehiculosAfiliado = vehiculosCount;

          const mtsAf = Array.isArray(data.mantenimientos)?data.mantenimientos:[];
          const numMtsAf = mtsAf.length;

          cardMantenimientos.innerHTML =
            '<h2>Vehículos y mantenimientos</h2>'+
            '<p><strong>Cantidad de vehículos afiliados:</strong> '+
              (vehiculosCount || vehiculosCount===0 ? vehiculosCount : 'Dato no disponible')+'</p>'+
            '<p><strong>Mantenimientos registrados:</strong> '+numMtsAf+'</p>';

          // menú visible sólo con contrato
          btnMenu.style.display='flex';
        }
        else{
          // tipo de usuario desconocido
          cardContrato.innerHTML='<h2>Contrato</h2><p>Tipo de usuario no reconocido.</p>';
          cardPagos.innerHTML='';
          cardMantenimientos.innerHTML='';
          btnMenu.style.display='none';
        }

        resultados.style.display='grid';
        status.className='status ok';
        status.textContent='Información cargada correctamente.';
      }catch(e){
        console.error(e);
        status.className='status error';
        status.textContent='Error al consultar la información. Intenta de nuevo.';
        ultimoContratoData=null;
        btnMenu.style.display='none';
      }finally{
        btn.disabled=false;
      }
    }

    function formatearNumero(n){
      const num=Number(
        typeof n==='string'
          ? n.replace(/[^0-9.-]/g,'')
          : n
      );
      if(isNaN(num))return n||'';
      return num.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
    }

    function formatearFecha(v){
      if(!v)return'';
      const d=new Date(v);
      if(isNaN(d.getTime()))return v;
      return d.toLocaleDateString('es-CO');
    }

    // ====== WOMPI ======
    function crearPagoWompi(){
      const montoInput=document.getElementById('montoPago');
      const errorLabel=document.getElementById('pagoError');
      const valor=parseInt(montoInput.value,10);

      errorLabel.style.display='none';
      if(!valor||valor<100000){
        errorLabel.style.display='block';
        return;
      }

      if(typeof WidgetCheckout==='undefined'){
        alert('No se pudo cargar el checkout de Wompi. Por favor recarga la página.');
        return;
      }

      const idContrato=(document.getElementById('idContrato').value||'').trim();
      const reference='PAGO_'+(idContrato||'SIN_CONTRATO')+'_'+Date.now();

      // (opcional) registrar intento de pago en hoja PAGOS_PORTAL
      try{
        fetch(API_URL,{
          method:'POST',
          body:new URLSearchParams({
            accion:'registrar_pago',
            referencia:reference,
            idContrato:idContrato,
            monto:String(valor)
          })
        }).catch(()=>{});
      }catch(_e){}

      const checkout=new WidgetCheckout({
        currency:'COP',
        amountInCents:valor*100,
        reference:reference,
        publicKey:WOMPI_PUBLIC_KEY,
        redirectUrl:WOMPI_REDIRECT_URL
      });

      checkout.open(function(result){
        const transaction=result.transaction;
        console.log('Transacción Wompi:', transaction && transaction.id, transaction && transaction.status);
      });
    }

    // ====== MODALES Y MENÚ ======
    btnMenu.addEventListener('click', abrirMenu);

    function abrirMenu(){
      if(!ultimoContratoData || !ultimoTipoUsuario)return;

      if(ultimoTipoUsuario.startsWith('RENTING')){
        // menú para renting: Beneficios / Historial de pagos / Taller asignado
        abrirModal('Opciones del cliente', `
          <p>Selecciona una opción:</p>
          <button class="menu-option-btn" type="button" onclick="mostrarBeneficios()">
            Beneficios
          </button>
          <button class="menu-option-btn" type="button" onclick="mostrarHistorialPagos()">
            Historial de pagos
          </button>
          <button class="menu-option-btn" type="button" onclick="mostrarTallerAsignado()">
            Taller asignado
          </button>
        `);
      }else if(ultimoTipoUsuario==='AFILIADO'){
        // menú para afiliados: Fecha de pagos / Cantidad de vehículos / Liquidaciones
        abrirModal('Opciones del afiliado', `
          <p>Selecciona una opción:</p>
          <button class="menu-option-btn" type="button" onclick="mostrarFechaPagosAfiliado()">
            Fecha de pagos
          </button>
          <button class="menu-option-btn" type="button" onclick="mostrarCantidadVehiculosAfiliado()">
            Cantidad de vehículos
          </button>
          <button class="menu-option-btn" type="button" onclick="mostrarLiquidacionesAfiliado()">
            Liquidaciones
          </button>
        `);
      }
    }

    function abrirModal(titulo,html){
      document.getElementById('modalTitle').textContent=titulo;
      document.getElementById('modalBody').innerHTML=html;
      document.getElementById('modalOverlay').style.display='flex';
    }

    function cerrarModal(){
      document.getElementById('modalOverlay').style.display='none';
    }

    // --- opciones RENTING ---
    function mostrarBeneficios(){
      if(!ultimoContratoData)return;
      const c=ultimoContratoData.contrato||{};
      const beneficios=c['BENEFICIOS']||'Dato no disponible';
      abrirModal('Beneficios del contrato', `
        <p><strong>Plan / beneficios:</strong></p>
        <p>${beneficios}</p>
      `);
    }

    function mostrarHistorialPagos(){
      // sólo formulario (lógica de envío ya existente en backend si se decide usar)
      const idActual=(ultimoContratoData && ultimoContratoData.contrato && ultimoContratoData.contrato['ID CONTRATO'])||'';
      abrirModal('Historial de pagos', `
        <p>Ingresa tu correo electrónico y tu ID de contrato para solicitar el historial en PDF.</p>
        <div style="margin-top:8px;">
          <label style="font-size:.85rem;font-weight:600;">Correo electrónico</label><br/>
          <input type="email" id="histEmail" placeholder="ejemplo@correo.com" style="width:100%;margin-bottom:8px;"/>
          <label style="font-size:.85rem;font-weight:600;">ID contrato</label><br/>
          <input type="text" id="histIdContrato" value="${idActual}" style="width:100%;margin-bottom:12px;"/>
          <button type="button" onclick="enviarSolicitudHistorialPagos()">Enviar solicitud</button>
        </div>
      `);
    }

    function enviarSolicitudHistorialPagos(){
      const email=document.getElementById('histEmail').value.trim();
      const id=document.getElementById('histIdContrato').value.trim();
      if(!email||!id){
        alert('Por favor completa correo e ID de contrato.');
        return;
      }
      // Por ahora sólo mostramos confirmación local sin tocar backend
      alert('Solicitud registrada. En breve recibirás tu historial en el correo indicado.');
      cerrarModal();
    }

    function mostrarTallerAsignado(){
      const mts = Array.isArray(ultimoContratoData && ultimoContratoData.mantenimientos)
        ? ultimoContratoData.mantenimientos : [];
      let taller = 'Dato no disponible';
      if(mts.length>0){
        const ultimo = mts[mts.length-1];
        if(ultimo['TALLER ASIGNADO']) taller = ultimo['TALLER ASIGNADO'];
      }
      abrirModal('Taller asignado', `
        <p><strong>Taller asignado actual:</strong></p>
        <p>${taller}</p>
      `);
    }

    // --- opciones AFILIADO ---
    function mostrarFechaPagosAfiliado(){
      const dias = ultimoDiasCorteAfiliado || 'Dato no disponible';
      abrirModal('Fecha de pagos', `
        <p><strong>Días de corte / pagos:</strong> ${dias}</p>
      `);
    }

    function mostrarCantidadVehiculosAfiliado(){
      const num = (ultimoVehiculosAfiliado || ultimoVehiculosAfiliado===0)
        ? ultimoVehiculosAfiliado : 'Dato no disponible';
      abrirModal('Cantidad de vehículos afiliados', `
        <p><strong>Número de vehículos:</strong> ${num}</p>
      `);
    }

    function mostrarLiquidacionesAfiliado(){
      const af = ultimoResumenAfiliado;
      const numLiqui = af ? (af['NO LIQUIDACIONES']||'Dato no disponible') : 'Dato no disponible';
      const valorLiqui = af ? (af['VALOR LIQUIDADO']||'Dato no disponible') : 'Dato no disponible';
      abrirModal('Resumen de liquidaciones', `
        <p><strong>Número de liquidaciones:</strong> ${numLiqui}</p>
        <p><strong>Valor total liquidado:</strong> ${valorLiqui}</p>
      `);
    }
  </script>
</body>
</html>
