<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Colores PWA / navegador -->
  <meta name="theme-color" content="#0f172a">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- Manifest e √≠conos -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-512.png">

  <!-- Wompi -->
  <script src="https://checkout.wompi.co/widget.js" async></script>

  <style>
    *{box-sizing:border-box}

    /* ‚úÖ CORRECCI√ìN: pantalla est√°tica (sin scroll / sin ‚Äúbajar‚Äù al dise√±o anterior) */
    html, body{
      height:100%;
      overflow:hidden;
      overscroll-behavior:none;
    }

    body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#0f172a;
      color:#111827;
    }

    /* =========================
       NUEVA PANTALLA PRINCIPAL
       Estilo tipo Lulo (login)
       ========================= */
    .login-screen{
      position:relative;
      min-height:100vh;
      width:100%;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 16px;
      background:#0f172a;
    }
    .login-bg{
      position:absolute;
      inset:0;
      background-image:url('radiz-driver.jpg.jpg');
      background-size:cover;
      background-position:center;
      transform:scale(1.02);
      filter:saturate(1.02) contrast(1.02);
    }
    .login-overlay{
      position:absolute;
      inset:0;
      background:linear-gradient(
        180deg,
        rgba(15,23,42,.35) 0%,
        rgba(15,23,42,.65) 55%,
        rgba(15,23,42,.85) 100%
      );
    }
    .login-content{
      position:relative;
      z-index:2;
      width:100%;
      max-width:460px;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap:14px;
      padding:18px 14px 16px;
    }
    .login-logo{
  margin-top:-10px;     /* s√∫belo un poco */
  margin-bottom:0;
  display:flex;
  justify-content:center;
}

.login-logo img{
  width:72px;
  height:72px;
  object-fit:contain;
  border-radius:18px;      /* üëà puntas redondas */
  overflow:hidden;
}
    .login-content .login-welcome{
  margin:-6px 0 0;       /* s√∫bela un poco */
  font-size:1.55rem;     /* mantiene tama√±o del login */
  line-height:1.15;
  font-weight:800;
  color:#ffffff;         /* evita que quede negra */
  letter-spacing:.02em;
  text-shadow:0 10px 26px rgba(0,0,0,.35);
}
   .login-form{
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
  margin-top:clamp(90px, 24vh, 140px);    /* baja los campos */
}

    /* ‚úÖ CORRECCI√ìN: Campos m√°s angostos (no a todo el ancho del tel√©fono) */
    .login-input{
      width:min(310px, 78vw);
      border:0 !important;
      outline:0 !important;
      -webkit-appearance:none;
      appearance:none;
      border-radius:14px;
      padding:12px 14px;
      font-size:1rem;
      color:#0f172a;
      box-shadow:0 18px 45px rgba(0,0,0,.22);
      background-clip:padding-box;
    }
    .login-input::placeholder{
      color:rgba(15,23,42,.6);
    }

    /* Usuario (AZUL) */
    #loginId{
      background:rgba(37,99,235,.92);
      color:#ffffff;
    }
    #loginId::placeholder{ color:rgba(255,255,255,.8); }

    /* Contrase√±a (NARANJA) */
    #loginPassword{
      background:rgba(249,115,22,.92);
      color:#ffffff;
    }
    #loginPassword::placeholder{ color:rgba(255,255,255,.85); }

    .login-btn{
      width:min(310px, 78vw);
      border:none;
      border-radius:16px;
      padding:12px 14px;
      font-size:1rem;
      font-weight:800;
      cursor:pointer;
      background:rgba(255,255,255,.88);
      color:#0f172a;
      box-shadow:0 18px 45px rgba(0,0,0,.25);
      transition:transform .1s, box-shadow .1s, background .1s;
    }
    .login-btn:hover{
      transform:translateY(-1px);
      background:#ffffff;
      box-shadow:0 22px 55px rgba(0,0,0,.28);
    }

    .login-msg{
      width:min(310px, 78vw);
      min-height:1.2em;
      font-size:.92rem;
      color:#ffffff;
      text-shadow:0 10px 26px rgba(0,0,0,.35);
      opacity:.95;
    }
    .login-msg.error{ color:#fecaca; }
    .login-msg.ok{ color:#bbf7d0; }

    /* =========================
       PORTAL EXISTENTE (se conserva)
       ‚úÖ CORRECCI√ìN: oculto para que no exista ‚Äúsegunda pantalla‚Äù al deslizar
       ========================= */
    .page{
      display:none; /* <-- clave para que no ‚Äúbaje‚Äù al dise√±o anterior */
      min-height:100vh;
      align-items:flex-start;
      justify-content:center;
      padding:32px 16px;
    }

    .container{
      position:relative;
      width:100%;
      max-width:960px;
      background:#ffffff;
      border-radius:24px;
      box-shadow:0 18px 45px rgba(15,23,42,.14);
      padding:28px 32px 32px;
      overflow:visible;
    }

    /* Logo Radiz */
    .logo-top{
      text-align:center;
      margin-bottom:12px;
    }
    .logo-top img{
      max-width:260px;
      max-height:120px;
      object-fit:contain;
    }

    /* GRID PRINCIPAL DOS COLUMNAS */
    .main-grid{
      display:grid;
      grid-template-columns:minmax(0,1.05fr) minmax(0,1.15fr);
      gap:24px;
      margin-top:8px;
    }

    .brand-card{
      position:relative;
      border-radius:22px;
      overflow:hidden;
      background:#0f172a;
      min-height:380px;
      box-shadow:0 18px 40px rgba(15,23,42,.32);
      color:#f9fafb;
    }
    .brand-image{
      position:absolute;
      inset:0;
    }
    .brand-image img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .brand-overlay{
      position:absolute;
      inset:0;
      background:linear-gradient(180deg,rgba(15,23,42,.15) 10%,rgba(15,23,42,.78) 80%);
    }
    .brand-copy{
      position:absolute;
      left:18px;
      right:18px;
      bottom:18px;
    }
    .brand-kicker{
      margin:0 0 4px;
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#bfdbfe;
      font-weight:600;
    }
    .brand-copy h2{
      margin:0;
      font-size:1.45rem;
      line-height:1.25;
      font-weight:700;
    }

    .panel-main{
      display:flex;
      flex-direction:column;
    }

    /* Banner bienvenida */
    .welcome-banner{
      display:flex;
      align-items:flex-start;
      gap:10px;
      background:#e0f2fe;
      border-radius:16px;
      padding:10px 14px;
      margin-bottom:18px;
      border:1px solid #bfdbfe;
    }
    .welcome-icon{
      position:relative;
      width:32px;
      height:32px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#2563eb;
      color:transparent;
      flex-shrink:0;
    }
    .welcome-icon::before{
      content:"";
      position:absolute;
      width:3px;
      height:10px;
      border-radius:999px;
      background:#ffffff;
      top:11px;
      left:50%;
      transform:translateX(-50%);
    }
    .welcome-icon::after{
      content:"";
      position:absolute;
      width:3px;
      height:3px;
      border-radius:999px;
      background:#ffffff;
      top:7px;
      left:50%;
      transform:translateX(-50%);
    }
    .welcome-text-title{
      font-size:.95rem;
      font-weight:600;
      margin:0 0 2px;
      color:#0f172a;
    }
    .welcome-text-sub{
      margin:0;
      font-size:.85rem;
      color:#4b5563;
    }

    .portal-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:12px;
    }
    h1{
      margin:0 0 4px;
      font-size:1.9rem;
      letter-spacing:.03em;
    }

    .card{
      position:relative;
      border-radius:18px;
      border:1px solid #e5e7eb;
      padding:16px 18px 16px;
      background:#ffffff;
      font-size:.9rem;
      transition:border-color .15s,box-shadow .15s,transform .1s,background .15s;
    }
    .card h2{
      margin:0 0 8px;
      font-size:1.05rem;
      font-weight:700;
      color:#111827;
    }
    .card p{
      margin:3px 0;
      color:#111827;
      font-size:.9rem;
    }
    .card p strong{
      font-weight:600;
    }
    .card:hover{
      border-color:#2563eb;
      box-shadow:0 16px 34px rgba(37,99,235,.18);
      background:#f9fbff;
      transform:translateY(-1px);
    }

    .card-consulta{ margin-bottom:18px; }
    .card-pago{ margin-bottom:18px; }

    /* Iconos SVG para tarjetas de resultados */
    .card-contrato::before,
    .card-pagos::before,
    .card-mantenimientos::before{
      content:"";
      position:absolute;
      top:18px;
      left:18px;
      width:26px;
      height:26px;
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
    }
    .card-contrato::before{ background-image:url('√≠cono_contrato1.svg'); }
    .card-pagos::before{ background-image:url('√≠cono_pagos.svg'); }
    .card-mantenimientos::before{ background-image:url('√≠cono_mantenimientos.svg'); }
    .card-contrato h2,
    .card-pagos h2,
    .card-mantenimientos h2{ margin-left:40px; }
    .card-mantenimientos:hover{
      background:#fff7ed;
      border-color:#f97316;
      box-shadow:0 18px 38px rgba(249,115,22,.22);
    }

    /* T√≠tulos de secci√≥n (consulta / pago) */
    .section-title{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
    }
    .section-title span{
      font-size:1.05rem;
      font-weight:700;
      color:#111827;
    }
    .section-icon{
      position:relative;
      width:28px;
      height:28px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#eff6ff;
      flex-shrink:0;
    }
    .section-icon-search::before{
      content:"";
      position:absolute;
      width:13px;
      height:13px;
      border-radius:999px;
      border:2px solid #2563eb;
      top:6px;
      left:7px;
      box-sizing:border-box;
    }
    .section-icon-search::after{
      content:"";
      position:absolute;
      width:8px;
      height:2px;
      border-radius:999px;
      background:#2563eb;
      bottom:7px;
      right:6px;
      transform:rotate(45deg);
    }
    .section-icon-money::before{
      content:"$";
      position:absolute;
      font-size:16px;
      font-weight:700;
      color:#2563eb;
    }

    label{
      font-size:.9rem;
      font-weight:600;
      color:#374151;
    }
    .form-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-top:6px;
      margin-bottom:10px;
      align-items:flex-end;
    }
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="date"],
    input[type="password"]{
      width:100%;
      padding:10px 12px;
      border-radius:9px;
      border:1px solid #d1d5db;
      font-size:.95rem;
      outline:none;
      transition:border-color .15s,box-shadow .15s,background .15s;
      background:#f9fafb;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="email"]:focus,
    input[type="date"]:focus,
    input[type="password"]:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.18);
      background:#ffffff;
    }

    button{
      padding:11px 22px;
      border-radius:999px;
      border:none;
      font-size:.95rem;
      font-weight:600;
      cursor:pointer;
      background:#2563eb;
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      box-shadow:0 12px 26px rgba(37,99,235,.45);
      transition:transform .1s,box-shadow .1s,background .1s;
      white-space:nowrap;
    }
    button:hover{
      transform:translateY(-1px);
      background:#1d4ed8;
      box-shadow:0 16px 32px rgba(37,99,235,.55);
    }
    button:disabled{
      opacity:.65;
      cursor:default;
      box-shadow:none;
      transform:none;
    }

    .btn-main{
      min-width:190px;
      justify-content:center;
    }

    .btn-afiliado{
      background:#f97316;
      box-shadow:0 12px 26px rgba(249,115,22,.45);
    }
    .btn-afiliado:hover{
      background:#ea580c;
      box-shadow:0 16px 32px rgba(249,115,22,.6);
    }

    .btn-app{
      padding:0;
      border:none;
      background:transparent;
      color:#1d4ed8;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow:none;
      white-space:nowrap;
      min-width:0;
    }
    .btn-app:hover{
      background:transparent;
      border:none;
      color:#1d4ed8;
      box-shadow:none;
      transform:none;
      text-decoration:underline;
    }

    .status{
      font-size:.9rem;
      margin-top:4px;
      min-height:1.2em;
    }
    .status.error{color:#b91c1c}
    .status.ok{color:#065f46}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:16px;
      margin-top:6px;
      margin-bottom:18px;
    }

    ul{padding-left:18px;margin:6px 0}
    li{margin-bottom:4px}

    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:600;
      text-transform:uppercase;
    }
    .badge-activo{background:#dcfce7;color:#166534}
    .badge-inactivo{background:#fee2e2;color:#b91c1c}

    footer{
      margin-top:10px;
      font-size:.75rem;
      color:#9ca3af;
      text-align:center;
    }

    #seccionPago h2{
      font-size:1.05rem;
      margin:0 0 4px;
      color:#111827;
    }
    #seccionPago p{
      font-size:.9rem;
      color:#4b5563;
      margin:4px 0 10px;
    }
    #seccionPago .row-pago{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .row-pago-botones{
      justify-content:space-between;
      margin-top:10px;
    }
    .btn-pago,
    .btn-qr{
      flex:1;
      min-width:0;
      background:#60a5fa;
      box-shadow:0 8px 18px rgba(96,165,250,.5);
    }
    .btn-pago:hover,
    .btn-qr:hover{
      background:#3b82f6;
      box-shadow:0 10px 22px rgba(59,130,246,.6);
    }
    #montoPago{ width:220px; }
    #pagoError{
      color:#dc2626;
      margin-top:6px;
      font-size:.85rem;
      display:none;
    }
    #pagoContratoError{
      color:#dc2626;
      margin-top:4px;
      font-size:.85rem;
      display:none;
    }

    .row-consulta{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:6px;
      margin-bottom:10px;
    }
    #idContrato{ width:220px; }

    .affiliate-row{
      margin-top:18px;
      display:flex;
      justify-content:center;
    }

    .fab-menu{
      position:absolute;
      top:24px;
      right:24px;
      z-index:20;
      display:none;
    }
    .fab-btn{
      width:54px;
      height:54px;
      border-radius:999px;
      background:#2563eb;
      border:none;
      box-shadow:0 10px 24px rgba(37,99,235,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:transform .12s,box-shadow .12s,background .12s;
    }
    .fab-btn:hover{
      transform:translateY(-1px);
      background:#1d4ed8;
      box-shadow:0 14px 32px rgba(37,99,235,.55);
    }
    .fab-btn span{
      display:block;
      width:22px;
      height:2px;
      border-radius:999px;
      background:#fff;
      position:relative;
    }
    .fab-btn span::before,
    .fab-btn span::after{
      content:"";
      position:absolute;
      left:0;
      width:22px;
      height:2px;
      border-radius:999px;
      background:#fff;
    }
    .fab-btn span::before{top:-6px}
    .fab-btn span::after{top:6px}

    .menu-panel{
      position:absolute;
      top:86px;
      right:28px;
      background:#ffffff;
      border-radius:14px;
      box-shadow:0 12px 30px rgba(15,23,42,.22);
      padding:8px 0;
      width:260px;
      display:none;
      z-index:25;
    }
    .menu-title{
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-weight:600;
      color:#6b7280;
      padding:6px 14px 4px;
    }
    .menu-item{
      padding:7px 14px;
      font-size:.9rem;
      cursor:pointer;
      color:#111827;
    }
    .menu-item:hover{
      background:#eff6ff;
      color:#1d4ed8;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal{
      background:#fff;
      border-radius:18px;
      max-width:480px;
      width:90%;
      padding:18px 20px 18px;
      box-shadow:0 20px 45px rgba(15,23,42,.4);
      font-size:.9rem;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .modal-header h3{
      margin:0;
      font-size:1.05rem;
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size:1.3rem;
      cursor:pointer;
      color:#6b7280;
    }
    .modal p{margin:4px 0;color:#111827}
    .modal label{display:block;margin-top:8px;margin-bottom:3px}
    .modal-actions{
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .link-copy-row{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:4px;
    }
    .link-copy-row input{ flex:1; }
    .copy-msg{
      font-size:.8rem;
      margin-top:6px;
      color:#6b7280;
    }

    .img-beneficios-renting{
      max-width:100%;
      height:auto;
      border-radius:12px;
      display:block;
      margin:4px auto;
    }

    @media(max-width:900px){
      .main-grid{ grid-template-columns:1fr; }
      .brand-card{ min-height:260px; }
    }

    @media(max-width:640px){
      .container{
        padding:22px 18px 24px;
        border-radius:18px;
      }
      .portal-header{
        flex-direction:column;
        align-items:flex-start;
      }
      .fab-menu{
        top:16px;
        right:16px;
      }
      #montoPago{ width:100%; }
      #idContrato{ width:100%; }
    }
  </style>
</head>
<body>

<!-- PANTALLA PRINCIPAL TIPO LULO (RADIZ) -->
<section class="login-screen">
  <div class="login-bg"></div>
  <div class="login-overlay"></div>

  <div class="login-content">
    <!-- ‚úÖ CORRECCI√ìN: Logo peque√±o (√≠cono) usando icon-512.png -->
    <div class="login-logo">
      <img src="icon-512.png" alt="RADIZ">
    </div>

    <h1 class="login-welcome">¬°Buenas buenas!</h1>

    <form class="login-form" onsubmit="event.preventDefault(); loginInversiones('login');">
      <input class="login-input" type="text" id="loginId" placeholder="Usuario (Ej: R7467)" autocomplete="username">
      <input class="login-input" type="password" id="loginPassword" placeholder="Contrase√±a" autocomplete="current-password">
      <button type="submit" class="login-btn">Entrar</button>
      <div id="loginMsg" class="login-msg"></div>
    </form>
  </div>
</section>

<!-- ===============================
     PORTAL EXISTENTE (SE CONSERVA)
     (queda oculto por CSS para que no haya scroll)
     =============================== -->
<div class="page">
  <div class="container">
    <div class="logo-top">
      <img src="logoradiz.png" alt="Logo RADIZ" id="logo-radiz">
    </div>

    <!-- Bot√≥n men√∫ flotante -->
    <div class="fab-menu" id="fabMenu">
      <button class="fab-btn" type="button" onclick="toggleMenu()">
        <span></span>
      </button>
      <div class="menu-panel" id="menuPanel">
        <div class="menu-title" id="menuTitle">Opciones</div>

        <div id="menuInicial">
          <div class="menu-item" onclick="abrirModal('modalInversiones')">Ir a inversiones</div>
          <div class="menu-item" onclick="manejarDescargaApp()">Descarga la App</div>
        </div>

        <div id="menuRenting" style="display:none;">
          <div class="menu-item" onclick="abrirModal('modalBeneficios')">Beneficios</div>
          <div class="menu-item" onclick="solicitarGrua()">Solicitar gr√∫a</div>
          <div class="menu-item" onclick="abrirModal('modalActualizarKm')">Actualizar kilometraje</div>
          <div class="menu-item">Se√±ales</div>
          <div class="menu-item" onclick="abrirModal('modalHistorialPagos')">Historial de pagos</div>
          <div class="menu-item">Historial de mantenimientos</div>
          <div class="menu-item" onclick="abrirModal('modalSaldoFavor')">Mi saldo a favor</div>
          <div class="menu-item" onclick="abrirModal('modalAfiliado')">Link de referidos</div>
          <div class="menu-item" onclick="abrirModal('modalIncidente')">Notificar incidente</div>
          <div class="menu-item" onclick="abrirModal('modalTaller')">Taller asignado</div>
        </div>

        <div id="menuAfiliado" style="display:none;">
          <div class="menu-item">Beneficios</div>
          <div class="menu-item" onclick="abrirModal('modalHistorialPagos')">Historial de pagos</div>
          <div class="menu-item">Mapa vehicular</div>
          <div class="menu-item">Oportunidades</div>
          <div class="menu-item" onclick="abrirModal('modalMisContratosAfiliado')">Mis contratos</div>
          <div class="menu-item" onclick="abrirModal('modalActualizarDatosAfiliado')">Actualizar datos</div>
          <div class="menu-item" onclick="abrirModal('modalMiFlotaAfiliado')">Mi flota</div>
          <div class="menu-item" onclick="abrirModal('modalInvertirAfiliado')">Invertir</div>
        </div>
      </div>
    </div>

    <div class="main-grid">
      <div class="brand-card">
        <div class="brand-image">
          <img src="radiz-driver.jpg.jpg" alt="Conductor Radiz frente a veh√≠culos de carga">
        </div>
        <div class="brand-overlay"></div>
        <div class="brand-copy">
          <p class="brand-kicker">Una marca de Proyecto I45 S.A.S.</p>
          <h2>Veh√≠culos que dignifican</h2>
        </div>
      </div>

      <div class="panel-main">
        <div class="welcome-banner">
          <div class="welcome-icon"></div>
          <div>
            <p class="welcome-text-title">¬°Bienvenido a Radiz Vehicular!</p>
            <p class="welcome-text-sub">Consulte su contrato, realice pagos y descargue su historial.</p>
          </div>
        </div>

        <header class="portal-header">
          <div>
            <h1></h1>
          </div>
        </header>

        <div class="card card-consulta">
          <div class="section-title">
            <div class="section-icon section-icon-search"></div>
            <span>Consulta de contrato</span>
          </div>

          <label for="idContrato">ID</label>
          <div class="row-consulta">
            <input type="text" id="idContrato" placeholder="Ejemplo: R4523">
            <button id="btnConsultar" class="btn-main" onclick="consultar()">Consultar</button>
          </div>
          <div id="status" class="status"></div>
        </div>

        <div class="card card-pago" id="seccionPago">
          <div class="section-title">
            <div class="section-icon section-icon-money"></div>
            <span>Realizar pago</span>
          </div>
          <p>Ingresa el monto a pagar y completa el proceso con Wompi.</p>
          <label for="montoPago">Monto a pagar (COP)</label>
          <div class="row-pago">
            <input id="montoPago" type="number" min="170000" step="1000" placeholder="Ej: 170000">
          </div>

          <div class="row-pago row-pago-botones">
            <button type="button" class="btn-main btn-pago" onclick="crearPagoWompi()">Pagar con Wompi</button>
            <button type="button" class="btn-main btn-qr" onclick="abrirModal('modalQR')">Ver QR</button>
          </div>
          <p id="pagoError">Ingresa un monto v√°lido (m√≠nimo 170.000).</p>
          <p id="pagoContratoError">Digita tu ID antes de pagar.</p>
        </div>

        <div class="affiliate-row">
          <button type="button" class="btn-app" onclick="abrirModal('modalInversiones')">
            Iniciar sesi√≥n
          </button>
        </div>

        <div class="grid" id="resultados" style="display:none;">
          <div class="card card-contrato" id="cardContrato"></div>
          <div class="card card-pagos" id="cardPagos"></div>
          <div class="card card-mantenimientos" id="cardMantenimientos"></div>
        </div>

        <footer>Versi√≥n interna ‚Ä¢ RADIZ Suministro Vehicular</footer>
      </div>
    </div>
  </div>
</div>

<!-- MODALES RENTING -->
<div class="modal-backdrop" id="modalBeneficios">
  <div class="modal">
    <div class="modal-header">
      <h3>Beneficios del plan</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalBeneficios')">&times;</button>
    </div>
    <p id="modalBeneficiosTexto">Informaci√≥n no disponible.</p>
  </div>
</div>

<div class="modal-backdrop" id="modalHistorialPagos">
  <div class="modal">
    <div class="modal-header">
      <h3>Historial de pagos</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalHistorialPagos')">&times;</button>
    </div>
    <p id="historialIntro" style="margin-bottom:6px;">
      Ingresa tu correo electr√≥nico y el ID para solicitar tu historial en PDF.
    </p>
    <label for="correoHistorial">Correo electr√≥nico</label>
    <input type="email" id="correoHistorial" placeholder="ejemplo@correo.com">
    <label for="idHistorial">ID</label>
    <input type="text" id="idHistorial" placeholder="Ej: R7467">
    <p id="historialMsg" style="font-size:.85rem;margin-top:6px;color:#6b7280;"></p>
    <div class="modal-actions">
      <button type="button" onclick="cerrarModal('modalHistorialPagos')">Cerrar</button>
      <button type="button" id="btnHistorialEnviar" onclick="enviarSolicitudHistorial()">Enviar</button>
      <button type="button" id="btnHistorialDescargar" style="display:none;" onclick="descargarHistorialPdf()">Descargar PDF</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalTaller">
  <div class="modal">
    <div class="modal-header">
      <h3>Taller asignado</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalTaller')">&times;</button>
    </div>
    <p id="modalTallerTexto">Informaci√≥n no disponible.</p>
  </div>
</div>

<div class="modal-backdrop" id="modalActualizarKm">
  <div class="modal">
    <div class="modal-header">
      <h3>Actualizar kilometraje</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalActualizarKm')">&times;</button>
    </div>
    <p>Ingresa el nuevo kilometraje y la placa del veh√≠culo.</p>
    <label for="kmValor">Kilometraje actual</label>
    <input type="number" id="kmValor" placeholder="Ej: 2500">
    <label for="kmIdVehiculo">Placa / ID veh√≠culo</label>
    <input type="text" id="kmIdVehiculo" placeholder="Ej: WRG02H">
    <p id="kmMsg" class="status"></p>
    <div class="modal-actions">
      <button type="button" onclick="cerrarModal('modalActualizarKm')">Cerrar</button>
      <button type="button" onclick="enviarActualizacionKilometraje()">Enviar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalSaldoFavor">
  <div class="modal">
    <div class="modal-header">
      <h3>Mi saldo a favor</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalSaldoFavor')">&times;</button>
    </div>
    <p>Tienes un saldo a favor por concepto de referidos: <strong>$0.00</strong>.</p>
    <div class="modal-actions">
      <button type="button" onclick="cerrarModal('modalSaldoFavor')">Cerrar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalQR">
  <div class="modal">
    <div class="modal-header">
      <h3>Pagar con c√≥digo QR</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalQR')">&times;</button>
    </div>
    <p>Escanea este c√≥digo con la app de tu banco o billetera para realizar el pago:</p>
    <img src="QRRADIZ-38.png"
         alt="C√≥digo QR de pago RADIZ"
         style="max-width:100%;height:auto;border-radius:12px;display:block;margin:8px auto;">
    <p style="font-size:.8rem;color:#6b7280;margin-top:4px;">
      Recuerda incluir tu ID de contrato en la referencia del pago.
    </p>
    <div class="modal-actions">
      <button type="button" onclick="cerrarModal('modalQR')">Cerrar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalIncidente">
  <div class="modal">
    <div class="modal-header">
      <h3>Notificar incidente</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalIncidente')">&times;</button>
    </div>
    <p>Cu√©ntanos qu√© sucedi√≥ con el veh√≠culo.</p>
    <label for="incidenteDescripcion">Descripci√≥n del incidente</label>
    <textarea id="incidenteDescripcion" rows="4" style="width:100%;border-radius:9px;border:1px solid #d1d5db;padding:10px 12px;font-family:inherit;font-size:.95rem;"></textarea>
    <label for="incidenteIdVehiculo">Placa / ID veh√≠culo</label>
    <input type="text" id="incidenteIdVehiculo" placeholder="Ej: WRC01H">
    <label for="incidenteFecha">Fecha del incidente</label>
    <input type="date" id="incidenteFecha">
    <p id="incidenteMsg" class="status"></p>
    <div class="modal-actions">
      <button type="button" onclick="cerrarModal('modalIncidente')">Cerrar</button>
      <button type="button" onclick="enviarIncidente()">Enviar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalInversiones">
  <div class="modal">
    <div class="modal-header">
      <h3>Iniciar sesi√≥n</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalInversiones')">&times;</button>
    </div>
    <p>Ingrese su ID y contrase√±a para acceder a su portal.</p>
    <label for="invId">ID</label>
    <input type="text" id="invId" placeholder="Ej: R4523">
    <label for="invPassword">Contrase√±a</label>
    <input type="password" id="invPassword" placeholder="Tu contrase√±a">
    <p id="invLoginMsg" class="status"></p>
    <div class="modal-actions">
      <button type="button" onclick="cerrarModal('modalInversiones')">Cerrar</button>
      <button type="button" onclick="loginInversiones()">Entrar</button>
    </div>
    <p style="font-size:.8rem;margin-top:8px;color:#6b7280;">
      ¬øOlvid√≥ su contrase√±a? Escr√≠banos a
      <a href="mailto:notificacionespi45@gmail.com">notificacionespi45@gmail.com</a>
      con el asunto "Reasignar contrase√±a".
    </p>
  </div>
</div>

<div class="modal-backdrop" id="modalFechaPagosAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Fecha de pagos al afiliado</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalFechaPagosAfiliado')">&times;</button>
    </div>
    <p id="modalFechaPagosTexto">Dato no disponible.</p>
  </div>
</div>

<div class="modal-backdrop" id="modalVehiculosAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Cantidad de veh√≠culos afiliados</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalVehiculosAfiliado')">&times;</button>
    </div>
    <p id="modalVehiculosTexto">N√∫mero de veh√≠culos: Dato no disponible.</p>
  </div>
</div>

<div class="modal-backdrop" id="modalLiquidacionesAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Resumen de liquidaciones</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalLiquidacionesAfiliado')">&times;</button>
    </div>
    <p id="modalLiquidacionesTexto1">N√∫mero de liquidaciones: Dato no disponible.</p>
    <p id="modalLiquidacionesTexto2">Valor total liquidado: Dato no disponible.</p>
  </div>
</div>

<div class="modal-backdrop" id="modalMisContratosAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Mis contratos</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalMisContratosAfiliado')">&times;</button>
    </div>
    <p>Solicita copia de tus contratos.</p>
    <label for="misContratosCorreo">Correo electr√≥nico</label>
    <input type="email" id="misContratosCorreo" placeholder="ejemplo@correo.com">
    <label for="misContratosId">ID</label>
    <input type="text" id="misContratosId" placeholder="Ej: A0016">
    <p id="misContratosMsg" class="status"></p>
    <div class="modal-actions">
      <button type="button" onclick="cerrarModal('modalMisContratosAfiliado')">Cerrar</button>
      <button type="button" onclick="enviarSolicitudMisContratos()">Solicitar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalActualizarDatosAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Actualizar datos</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalActualizarDatosAfiliado')">&times;</button>
    </div>
    <p>Actualiza tus datos de pago y contacto.</p>
    <label for="actualizarCuenta">Cuenta bancaria</label>
    <input type="text" id="actualizarCuenta" placeholder="Ej: 1234567890">
    <label for="actualizarCertificado">Certificado bancario (adj√∫ntalo al responder el correo de confirmaci√≥n)</label>
    <input type="file" id="actualizarCertificado">
    <label for="actualizarCorreo">Correo electr√≥nico</label>
    <input type="email" id="actualizarCorreo" placeholder="ejemplo@correo.com">
    <label for="actualizarCelular">N√∫mero de celular</label>
    <input type="text" id="actualizarCelular" placeholder="Ej: 3001234567">
    <label for="actualizarId">ID</label>
    <input type="text" id="actualizarId" placeholder="Ej: A0016">
    <p id="actualizarDatosMsg" class="status"></p>
    <div class="modal-actions">
      <button type="button" onclick="cerrarModal('modalActualizarDatosAfiliado')">Cerrar</button>
      <button type="button" onclick="enviarActualizacionDatosAfiliado()">Enviar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalMiFlotaAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Mi flota</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalMiFlotaAfiliado')">&times;</button>
    </div>
    <p id="miFlotaTexto">Informaci√≥n no disponible.</p>
  </div>
</div>

<div class="modal-backdrop" id="modalInvertirAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Invertir</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalInvertirAfiliado')">&times;</button>
    </div>
    <p>Pronto podr√°s conocer nuevas oportunidades de inversi√≥n con Radiz.</p>
    <img src="invertir_afiliado.png" alt="Oportunidades de inversi√≥n Radiz" style="max-width:100%;border-radius:12px;margin-top:8px;">
  </div>
</div>

<div class="modal-backdrop" id="modalAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Link de afiliado</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalAfiliado')">&times;</button>
    </div>
    <p>
      Comparte nuestro link de referidos con tu ID (ejemplo: R7467) y gana hasta
      $70.000 pesos por cada referido aprobado.
    </p>
    <label for="linkAfiliadoInput">Link del formulario</label>
    <div class="link-copy-row">
      <input id="linkAfiliadoInput" type="text" readonly value="https://forms.gle/Lv1Rkp9qWQigUS4g8">
      <button type="button" onclick="copiarLinkAfiliado()">Copiar</button>
    </div>
    <p id="linkAfiliadoMsg" class="copy-msg"></p>
  </div>
</div>

<script>
  const API_URL='https://script.google.com/macros/s/AKfycbxNiAZCMVvaagzFjYQgIsQkGEWJPui9baIHcO_-JjeJ6HvDYdDU5BdH8R6zzD3zDUw/exec';
  const WOMPI_PUBLIC_KEY='pub_prod_D1w0Ys7mW5OJOueJoMi1rA5aLYJvlN06';
  const WOMPI_INTEGRITY_KEY='prod_integrity_zNC4ZqryuKzC75Cp72boasFFTLgzmhKN';
  const WOMPI_REDIRECT_URL='https://portal.radizco.com/';
  const API_CALLBACK_URL = API_URL;

  let tipoUsuarioActual=null;
  let datosContratoActual=null;
  let datosAfiliadoActual=null;

  const RADIZ_USER_KEY = 'radiz_usuario_guardado';

  document.addEventListener('DOMContentLoaded', function(){
    const fabMenu=document.getElementById('fabMenu');
    const menuInicial=document.getElementById('menuInicial');
    const menuRenting=document.getElementById('menuRenting');
    const menuAfiliado=document.getElementById('menuAfiliado');

    if(fabMenu){ fabMenu.style.display='block'; }
    if(menuInicial){ menuInicial.style.display='block'; }
    if(menuRenting){ menuRenting.style.display='none'; }
    if(menuAfiliado){ menuAfiliado.style.display='none'; }

    try{
      const saved = localStorage.getItem(RADIZ_USER_KEY) || '';
      const loginId = document.getElementById('loginId');
      if(loginId && saved){
        loginId.value = saved;
      }
    }catch(e){}
  });

  function toggleMenu(){
    const panel=document.getElementById('menuPanel');
    panel.style.display=panel.style.display==='block'?'none':'block';
  }
  function abrirModal(id){
    document.getElementById(id).style.display='flex';
    const menu=document.getElementById('menuPanel');
    if(menu) menu.style.display='none';
    if(id === 'modalHistorialPagos'){
      prepararModalHistorial();
    }
  }
  function cerrarModal(id){
    document.getElementById(id).style.display='none';
  }

  function prepararModalHistorial(){
    const correoLabel = document.querySelector('label[for="correoHistorial"]');
    const correoInput = document.getElementById('correoHistorial');
    const idInput = document.getElementById('idHistorial');
    const msg = document.getElementById('historialMsg');
    const intro = document.getElementById('historialIntro');
    const btnEnviar = document.getElementById('btnHistorialEnviar');
    const btnDescargar = document.getElementById('btnHistorialDescargar');

    const idActual = obtenerIdContratoActual();
    if(idInput && idActual){
      idInput.value = idActual;
    }

    if(msg){
      msg.textContent='';
      msg.style.color='#6b7280';
    }

    if(tipoUsuarioActual && tipoUsuarioActual.toUpperCase() === 'AFILIADO'){
      if(correoLabel) correoLabel.style.display='block';
      if(correoInput) correoInput.style.display='block';
      if(btnEnviar) btnEnviar.style.display='inline-flex';
      if(btnDescargar) btnDescargar.style.display='none';
      if(intro) intro.textContent='Ingresa tu correo electr√≥nico y el ID para que nuestro equipo te env√≠e el historial en PDF.';
    }else{
      if(correoLabel) correoLabel.style.display='none';
      if(correoInput) correoInput.style.display='none';
      if(btnEnviar) btnEnviar.style.display='none';
      if(btnDescargar) btnDescargar.style.display='inline-flex';
      if(intro) intro.textContent='Ingresa tu ID de contrato para descargar tu historial de pagos en PDF.';
    }
  }

  async function consultar(){
    const id=document.getElementById('idContrato').value.trim().toUpperCase();
    const status=document.getElementById('status');
    const btn=document.getElementById('btnConsultar');
    const resultados=document.getElementById('resultados');
    const cardContrato=document.getElementById('cardContrato');
    const cardPagos=document.getElementById('cardPagos');
    const cardMantenimientos=document.getElementById('cardMantenimientos');
    const fabMenu=document.getElementById('fabMenu');
    const menuRenting=document.getElementById('menuRenting');
    const menuAfiliado=document.getElementById('menuAfiliado');
    const menuInicial=document.getElementById('menuInicial');

    status.className='status';
    status.textContent='';
    resultados.style.display='none';
    document.getElementById('menuPanel').style.display='none';

    if(!id){
      status.classList.add('error');
      status.textContent='Por favor ingresa un ID.';
      return;
    }

    btn.disabled=true;
    status.textContent='Consultando informaci√≥n...';

    try{
      const resp=await fetch(API_URL+'?id='+encodeURIComponent(id));
      const data=await resp.json();

      if(!data.ok){
        status.className='status error';
        status.textContent=data.error||'No se encontr√≥ informaci√≥n para ese ID.';
        btn.disabled=false;
        return;
      }

      const c=data.contrato||{};
      datosContratoActual=c;

      const tipo=(c['TIPO USUARIO']||'').toString().toUpperCase();
      tipoUsuarioActual=tipo;

      const pagos=data.pagos||[];
      const rawM=data.mantenimientos??data.mantenimiento??[];
      const mts=Array.isArray(rawM)?rawM:(rawM?[rawM]:[]);
      const beneficiosTexto=c['BENEFICIOS']||'Informaci√≥n no disponible';

      cardContrato.innerHTML='';
      cardPagos.innerHTML='';
      cardMantenimientos.innerHTML='';

      const afiliados=data.afiliados||[];
      const vehiculosAll=data.vehiculos||[];

      if(tipo==='AFILIADO'){
        const idAfiliado=(c['ID AFILIADO']||id).toString().trim().toUpperCase();

        const af = afiliados.find(a =>
          String(a['ID AFILIADO'] || '').trim().toUpperCase() === idAfiliado
        ) || {};

        datosAfiliadoActual=af;

        const nombreAf = af['NOMBRE'] || c['ID CLIENTE'] || 'Dato no disponible';
        const fechaAfRaw = af['FECHA AFILIACI√ìN'] || af['FECHA AFILIACION'] || '';
        const fechaAf = formatearFecha(fechaAfRaw);

        const numLiq = af['NO LIQUIDACIONES']!==undefined && af['NO LIQUIDACIONES']!=='' ? af['NO LIQUIDACIONES'] : '0';

        let valorLiqTexto='0';
        if(af['VALOR LIQUIDADO']!==undefined && af['VALOR LIQUIDADO']!==''){
          const bruto=af['VALOR LIQUIDADO'];
          if(typeof bruto==='number'){
            valorLiqTexto=formatearNumero(bruto);
          }else{
            valorLiqTexto=String(bruto);
          }
        }

        cardContrato.innerHTML=
          '<h2>Contrato</h2>'+
          '<p><strong>ID afiliado:</strong> '+idAfiliado+'</p>'+
          '<p><strong>Nombre:</strong> '+nombreAf+'</p>'+
          '<p><strong>Inicio de afiliaci√≥n:</strong> '+(fechaAf||'Dato no disponible')+'</p>'+
          '<p><strong>Tipo de usuario:</strong> Participaci√≥n</p>';

        const pagoRelacionado=pagos.find(p=>{
          const idAf = String(p['ID AFILIADO']||'').trim().toUpperCase();
          const idCt = String(p['ID CONTRATO']||'').trim().toUpperCase();
          return idAf===idAfiliado || idCt===id;
        });
        const diasCorte=pagoRelacionado?(pagoRelacionado['D√çAS DE CORTE']||pagoRelacionado['DIAS DE CORTE']||'Dato no disponible'):'Dato no disponible';

        cardPagos.innerHTML=
          '<h2>Pagos</h2>'+
          '<p><strong>D√≠a de corte:</strong> '+diasCorte+'</p>'+
          '<p><strong>No. de liquidaciones:</strong> '+numLiq+'</p>'+
          '<p><strong>Valor liquidado:</strong> '+valorLiqTexto+'</p>';

        const vehiculosAf = vehiculosAll.filter(v =>
          String(v['ID AFILIADO']||'').trim().toUpperCase() === idAfiliado
        );
        const cantidadVeh = vehiculosAf.length;
        const placas = vehiculosAf
          .map(v => v['ID VEH√çCULO'] || v['ID VEHICULO'] || '')
          .filter(Boolean)
          .join(', ') || 'Sin veh√≠culos asociados';

        cardMantenimientos.innerHTML=
          '<h2>Flota</h2>'+
          '<p><strong>Cantidad de veh√≠culos:</strong> '+cantidadVeh+'</p>'+
          '<p><strong>Placas asociadas:</strong> '+placas+'</p>'+
          '<p><strong>Ventas:</strong> 0</p>';

        document.getElementById('modalFechaPagosTexto').textContent=
          'D√≠a de corte de pagos: '+diasCorte;
        document.getElementById('modalVehiculosTexto').textContent=
          'N√∫mero de veh√≠culos: '+cantidadVeh;
        document.getElementById('modalLiquidacionesTexto1').textContent=
          'N√∫mero de liquidaciones: '+numLiq;
        document.getElementById('modalLiquidacionesTexto2').textContent=
          'Valor total liquidado: '+valorLiqTexto;

        const correoAf = af['CORREO ELECTR√ìNICO'] || af['CORREO'] || '';
        const cuentaAf = af['CUENTA BANCARIA'] || af['CUENTA_BANCARIA'] || '';
        const celAf = af['CELULAR'] || af['TEL√âFONO'] || af['TELEFONO'] || '';

        const misCorreoInput = document.getElementById('misContratosCorreo');
        const misIdInput = document.getElementById('misContratosId');
        const actCuentaInput = document.getElementById('actualizarCuenta');
        const actCorreoInput = document.getElementById('actualizarCorreo');
        const actCelInput = document.getElementById('actualizarCelular');
        const actIdInput = document.getElementById('actualizarId');
        const flotaTexto = document.getElementById('miFlotaTexto');

        if(misCorreoInput) misCorreoInput.value = correoAf || '';
        if(misIdInput) misIdInput.value = idAfiliado;
        if(actCuentaInput) actCuentaInput.value = cuentaAf || '';
        if(actCorreoInput) actCorreoInput.value = correoAf || '';
        if(actCelInput) actCelInput.value = celAf || '';
        if(actIdInput) actIdInput.value = idAfiliado;
        if(flotaTexto) flotaTexto.textContent =
          cantidadVeh === 0
            ? 'No se encontraron veh√≠culos asociados a tu ID.'
            : 'Tienes '+cantidadVeh+' veh√≠culo(s) afiliado(s): '+placas+'.';

        if(menuInicial) menuInicial.style.display='none';
        menuRenting.style.display='none';
        menuAfiliado.style.display='block';
        fabMenu.style.display='block';

      }else{
        datosAfiliadoActual=null;

        const estado=(c['ESTADO']||'').toString().toUpperCase();

        cardContrato.innerHTML=
          '<h2>Contrato</h2>'+
          '<p><strong>ID:</strong> '+(c['ID CONTRATO']||'')+'</p>'+
          '<p><strong>Tipo usuario:</strong> '+(c['TIPO USUARIO']||'')+'</p>'+
          '<p><strong>Veh√≠culo:</strong> '+(c['ID VEH√çCULO']||c['ID VEHICULO']||'')+'</p>'+
          '<p><strong>Inicio:</strong> '+formatearFecha(c['INICIO'])+'</p>'+
          '<p><strong>Fin:</strong> '+formatearFecha(c['FIN'])+'</p>'+
          '<p><strong>Tarifa semanal:</strong> '+formatearNumero(c['TARIFA SEMANAL'])+'</p>'+
          '<p><strong>Beneficios:</strong> '+beneficiosTexto+'</p>'+
          '<p><span class="badge '+(estado==='ACTIVO'?'badge-activo':'badge-inactivo')+'">'+(estado||'SIN ESTADO')+'</span></p>';

        if(pagos.length===0){
          cardPagos.innerHTML='<h2>Pagos</h2><p>No hay pagos registrados para este contrato.</p>';
        }else{
          const p=pagos[0];
          const tarifasCompletadas = p['TARIFAS COMPLETADAS'] || '0';
          const tarifasVencidas = p['TARIFAS VENCIDAS'] || '0';

          const idContratoPagos = String(c['ID CONTRATO']||'').trim().toUpperCase();
          const esRentingPagos = idContratoPagos.startsWith('R');
          const tarifaSemanalNum = Number(c['TARIFA SEMANAL'] || 0);
          const tarifasVencidasNum = Number(tarifasVencidas || 0);
          const moraEstim = esRentingPagos ? tarifaSemanalNum * tarifasVencidasNum : 0;
          const moraHtml = esRentingPagos && moraEstim > 0
            ? '<p><strong>Mora estimada:</strong> '+formatearNumero(moraEstim)+'</p>'
            : '';

          cardPagos.innerHTML=
            '<h2>Pagos</h2>'+
            '<p><strong>D√≠a de corte:</strong> '+(p['D√çAS DE CORTE']||p['DIAS DE CORTE']||'')+'</p>'+
            '<p><strong>Tarifas completadas:</strong> '+tarifasCompletadas+'</p>'+
            '<p><strong>Tarifas vencidas:</strong> '+tarifasVencidas+'</p>'+
            moraHtml;
        }

        if(mts.length===0){
          cardMantenimientos.innerHTML='<h2>Mantenimientos</h2><p>No hay mantenimientos registrados para este contrato.</p>';
        }else{
          const totalM=mts.reduce((s,m)=>s+(Number(m['VALOR GENERAL']||m['VALOR MTOS'])||0),0);
          const m=mts[0];
          cardMantenimientos.innerHTML=
            '<h2>Mantenimientos</h2>'+
            '<p><strong>Total mantenimientos:</strong> '+formatearNumero(totalM)+'</p>'+
            '<p><strong>Placa:</strong> '+(m['ID VEH√çCULO']||m['ID VEHICULO']||'')+'</p>'+
            '<p><strong>√öltimo mantenimiento:</strong> '+formatearFecha(m['√öLTIMO MANTENIMIENTO']||m['ULTIMO MANTENIMIENTO']||m['FECHA ULT. MANTENIMIENTO'])+'</p>'+
            '<p><strong>Tipo de mantenimiento:</strong> '+(m['TIPO']||m['TIPO ULT. MANTENIMIENTO']||'')+'</p>'+
            '<p><strong>Realizados:</strong> '+(m['REALIZADOS']||m['MTOS REALIZADOS']||'')+'</p>'+
            '<p><strong>Taller asignado:</strong> '+(m['TALLER ASIGNADO']||'')+'</p>';
        }

        const idContratoActual = (c['ID CONTRATO']||'').toString().trim().toUpperCase();
        const esRentingId = idContratoActual.startsWith('R');

        const modalBeneficios=document.getElementById('modalBeneficiosTexto');
        if(esRentingId){
          modalBeneficios.innerHTML=
            '<img src="beneficios_renting.png" alt="Beneficios Renting Radiz" class="img-beneficios-renting">';
        }else{
          modalBeneficios.textContent=beneficiosTexto||'Informaci√≥n no disponible.';
        }

        const tallerEjemplo='Taller asignado: '+(mts[0]?.['TALLER ASIGNADO']||'Informaci√≥n no disponible.');
        document.getElementById('modalTallerTexto').textContent=tallerEjemplo;

        if(menuInicial) menuInicial.style.display='none';
        menuRenting.style.display='block';
        menuAfiliado.style.display='none';
        fabMenu.style.display='block';
      }

      resultados.style.display='grid';
      status.className='status ok';
      status.textContent='Informaci√≥n cargada correctamente.';
    }catch(e){
      console.error(e);
      status.className='status error';
      status.textContent='Error al consultar la informaci√≥n. Intenta de nuevo.';
    }finally{
      btn.disabled=false;
    }
  }

  function formatearNumero(n){
    const num=Number(n);
    if(isNaN(num))return n||'';
    return num.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
  }

  function formatearFecha(v){
    if(!v)return'';
    const d=new Date(v);
    if(isNaN(d.getTime()))return v;
    return d.toLocaleDateString('es-CO');
  }

  async function generarIntegritySignature(reference, amountInCents, currency){
    const encoder=new TextEncoder();
    const data=`${reference}${amountInCents}${currency}${WOMPI_INTEGRITY_KEY}`;
    const hashBuffer=await crypto.subtle.digest('SHA-256', encoder.encode(data));
    const hashArray=Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  async function crearPagoWompi(){
    const montoInput=document.getElementById('montoPago');
    const errorLabel=document.getElementById('pagoError');
    const contratoError=document.getElementById('pagoContratoError');
    const valor=parseInt(montoInput.value,10);
    const idContrato=(document.getElementById('idContrato').value||'').trim().toUpperCase();

    errorLabel.style.display='none';
    contratoError.style.display='none';

    if(!idContrato){
      contratoError.style.display='block';
      return;
    }

    if(!valor||valor<170000){
      errorLabel.style.display='block';
      return;
    }

    if(typeof WidgetCheckout==='undefined'){
      alert('No se pudo cargar el checkout de Wompi. Por favor recarga la p√°gina.');
      return;
    }

    const amountInCents = valor*100;
    const reference='PAGO_'+idContrato+'_'+Date.now();
    const currency='COP';

    try{
      const integritySignature=await generarIntegritySignature(reference,amountInCents,currency);

      const checkout=new WidgetCheckout({
        currency:currency,
        amountInCents:amountInCents,
        reference:reference,
        publicKey:WOMPI_PUBLIC_KEY,
        signature:{ integrity: integritySignature },
        redirectUrl:WOMPI_REDIRECT_URL
      });

      checkout.open(function(result){
        const transaction=result.transaction;
        console.log('Transacci√≥n Wompi:', transaction && transaction.id, transaction && transaction.status);
        registrarPagoEnSheet(reference, valor, idContrato);
      });
    }catch(e){
      console.error('Error generando firma de integridad',e);
      alert('No fue posible iniciar el pago. Intenta de nuevo.');
    }
  }

  async function registrarPagoEnSheet(reference, valor, idContrato){
    try{
      const formData=new URLSearchParams();
      formData.append('accion','registrar_pago');
      formData.append('referencia',reference);
      formData.append('monto',valor);
      formData.append('idContrato',idContrato);
      formData.append('origen','PORTAL_WEB');

      await fetch(API_CALLBACK_URL,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:formData.toString()
      });
    }catch(e){
      console.error('Error registrando pago en hoja',e);
    }
  }

  async function enviarSolicitudHistorial(){
    const correo=document.getElementById('correoHistorial').value.trim();
    const idHist=document.getElementById('idHistorial').value.trim();
    const msg=document.getElementById('historialMsg');

    msg.style.color='#6b7280';
    msg.textContent='Enviando solicitud...';

    if(!correo||!idHist){
      msg.style.color='#b91c1c';
      msg.textContent='Debes ingresar el correo y el ID.';
      return;
    }

    try{
      const formData=new URLSearchParams();
      formData.append('accion','solicitar_historial');
      formData.append('correo',correo);
      formData.append('idContrato',idHist);

      const resp=await fetch(API_CALLBACK_URL,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:formData.toString()
      });
      const data=await resp.json();
      if(data.ok){
        msg.style.color='#065f46';
        msg.textContent='Solicitud enviada correctamente. Nuestro equipo revisar√° y enviar√° el historial al correo registrado.';
      }else{
        msg.style.color='#b91c1c';
        msg.textContent=data.error||'Ocurri√≥ un problema al enviar la solicitud.';
      }
    }catch(e){
      console.error(e);
      msg.style.color='#b91c1c';
      msg.textContent='Error al enviar la solicitud. Intenta de nuevo.';
    }
  }

  async function descargarHistorialPdf(){
    const idInput = document.getElementById('idHistorial');
    const msg = document.getElementById('historialMsg');
    const id = (idInput.value || '').trim().toUpperCase();

    msg.style.color='#6b7280';
    msg.textContent='Generando historial...';

    if(!id){
      msg.style.color='#b91c1c';
      msg.textContent='Debes ingresar tu ID de contrato.';
      return;
    }

    try{
      const resp = await fetch(API_URL+'?accion=historial_pagos&id='+encodeURIComponent(id));
      const data = await resp.json();

      if(!data.ok){
        msg.style.color='#b91c1c';
        msg.textContent=data.error || 'No se encontr√≥ informaci√≥n de pagos para ese ID.';
        return;
      }

      const pagos = Array.isArray(data.pagos) ? data.pagos : [];
      if(pagos.length === 0){
        msg.style.color='#b91c1c';
        msg.textContent='No hay pagos registrados en Alegra para este contrato.';
        return;
      }

      const placa = data.placa || '';

      const filasHtml = pagos.map(function(p){
        const fecha = p.fecha || '';
        const consecutivo = p.consecutivo || '';
        const cliente = p.cliente || '';
        const notas = p.notas || '';
        const pagadas = (p.pagadas !== null && p.pagadas !== undefined) ? p.pagadas : '';
        const vencidas = (p.vencidas !== null && p.vencidas !== undefined) ? p.vencidas : '';
        var valorNum = Number(p.valor||0);
        var valorStr = isNaN(valorNum)
          ? (p.valor || '')
          : valorNum.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
        return '<tr>'+
          '<td>'+fecha+'</td>'+
          '<td>'+consecutivo+'</td>'+
          '<td>'+cliente+'</td>'+
          '<td style="text-align:right">'+valorStr+'</td>'+
          '<td>'+notas+'</td>'+
          '<td style="text-align:center">'+pagadas+'</td>'+
          '<td style="text-align:center">'+vencidas+'</td>'+
        '</tr>';
      }).join('');

      const nuevaVentana = window.open('', '_blank');
      if(!nuevaVentana){
        msg.style.color='#b91c1c';
        msg.textContent='El navegador bloque√≥ la ventana emergente. Habil√≠tala para descargar el PDF.';
        return;
      }

      const html = `
      <!DOCTYPE html>
      <html lang="es">
      <head>
        <meta charset="UTF-8" />
        <title>Historial de pagos ${id}</title>
        <style>
          body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:24px;color:#111827;}
          h1{font-size:20px;margin-bottom:4px;}
          p{font-size:12px;margin:2px 0 10px;}
          table{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px;}
          th,td{border:1px solid #d1d5db;padding:4px 6px;}
          th{background:#eff6ff;text-align:left;}
        </style>
      </head>
      <body>
        <h1>Historial de pagos</h1>
        <p><strong>Contrato:</strong> ${id}</p>
        <p><strong>Veh√≠culo / CC:</strong> ${placa}</p>
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Consecutivo</th>
              <th>Cliente</th>
              <th>Valor</th>
              <th>Notas</th>
              <th>Pagadas</th>
              <th>Vencidas</th>
            </tr>
          </thead>
          <tbody>
            ${filasHtml}
          </tbody>
        </table>
        <script>
          window.onload = function(){
            window.print();
          };
        <\/script>
      </body>
      </html>
      `;
      nuevaVentana.document.write(html);
      nuevaVentana.document.close();

      msg.style.color='#065f46';
      msg.textContent='Historial generado. Se abri√≥ una ventana de impresi√≥n para guardar en PDF.';
    }catch(e){
      console.error(e);
      msg.style.color='#b91c1c';
      msg.textContent='Error al generar el historial. Intenta de nuevo.';
    }
  }

  function copiarLinkAfiliado(){
    const input=document.getElementById('linkAfiliadoInput');
    const msg=document.getElementById('linkAfiliadoMsg');
    input.focus();
    input.select();
    try{
      const ok=document.execCommand('copy');
      if(ok){
        msg.style.color='#065f46';
        msg.textContent='Link copiado al portapapeles.';
      }else{
        msg.style.color='#b91c1c';
        msg.textContent='No se pudo copiar autom√°ticamente. Selecciona y copia el link manualmente.';
      }
    }catch(e){
      console.error(e);
      msg.style.color='#b91c1c';
      msg.textContent='No se pudo copiar autom√°ticamente. Selecciona y copia el link manualmente.';
    }
  }

  function solicitarGrua(){
    const mensaje='Hola, necesito solicitar gr√∫a para mi veh√≠culo.';
    const url='https://wa.me/573159406263?text='+encodeURIComponent(mensaje);
    window.open(url,'_blank');
  }

  function obtenerIdContratoActual(){
    if(datosContratoActual && datosContratoActual['ID CONTRATO']){
      return String(datosContratoActual['ID CONTRATO']).trim().toUpperCase();
    }
    return (document.getElementById('idContrato').value||'').trim().toUpperCase();
  }

  async function enviarActualizacionKilometraje(){
    const kmInput=document.getElementById('kmValor');
    const idVehInput=document.getElementById('kmIdVehiculo');
    const msg=document.getElementById('kmMsg');

    msg.className='status';
    msg.textContent='';

    const km = Number(kmInput.value||0);
    const idVeh = idVehInput.value.trim().toUpperCase();
    const idContrato = obtenerIdContratoActual();

    if(!idContrato || !km){
      msg.classList.add('error');
      msg.textContent='Debes ingresar el kilometraje e iniciar sesi√≥n con tu contrato.';
      return;
    }

    msg.textContent='Enviando actualizaci√≥n...';

    try{
      const formData=new URLSearchParams();
      formData.append('accion','actualizar_kilometraje');
      formData.append('kilometraje', km.toString());
      formData.append('idVehiculo', idVeh);
      formData.append('idContrato', idContrato);

      const resp = await fetch(API_CALLBACK_URL,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:formData.toString()
      });
      const data = await resp.json();
      if(data.ok){
        msg.className='status ok';
        msg.textContent='Kilometraje actualizado correctamente.';
      }else{
        msg.className='status error';
        msg.textContent=data.error || 'No fue posible actualizar el kilometraje.';
      }
    }catch(e){
      console.error(e);
      msg.className='status error';
      msg.textContent='Error al enviar la actualizaci√≥n. Intenta de nuevo.';
    }
  }

  async function enviarIncidente(){
    const descInput=document.getElementById('incidenteDescripcion');
    const idVehInput=document.getElementById('incidenteIdVehiculo');
    const fechaInput=document.getElementById('incidenteFecha');
    const msg=document.getElementById('incidenteMsg');

    msg.className='status';
    msg.textContent='';

    const descripcion = descInput.value.trim();
    const idVeh = idVehInput.value.trim().toUpperCase();
    const fecha = fechaInput.value;
    const idContrato = obtenerIdContratoActual();

    if(!idContrato || !descripcion){
      msg.classList.add('error');
      msg.textContent='Debes ingresar la descripci√≥n y tener un contrato cargado.';
      return;
    }

    msg.textContent='Enviando incidente...';

    try{
      const formData=new URLSearchParams();
      formData.append('accion','notificar_incidente');
      formData.append('descripcion', descripcion);
      formData.append('idVehiculo', idVeh);
      formData.append('idContrato', idContrato);
      formData.append('fecha', fecha);

      const resp = await fetch(API_CALLBACK_URL,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:formData.toString()
      });
      const data = await resp.json();
      if(data.ok){
        msg.className='status ok';
        msg.textContent='Incidente registrado correctamente.';
      }else{
        msg.className='status error';
        msg.textContent=data.error || 'No fue posible registrar el incidente.';
      }
    }catch(e){
      console.error(e);
      msg.className='status error';
      msg.textContent='Error al enviar el incidente. Intenta de nuevo.';
    }
  }

  async function enviarSolicitudMisContratos(){
    const correo = document.getElementById('misContratosCorreo').value.trim();
    const id = document.getElementById('misContratosId').value.trim().toUpperCase();
    const msg = document.getElementById('misContratosMsg');

    msg.className='status';
    msg.style.color='#6b7280';
    msg.textContent='Enviando solicitud...';

    if(!correo || !id){
      msg.classList.add('error');
      msg.textContent='Debes ingresar el correo y el ID.';
      return;
    }

    try{
      const formData = new URLSearchParams();
      formData.append('accion','solicitar_copia_contratos');
      formData.append('correo', correo);
      formData.append('idAfiliado', id);

      const resp = await fetch(API_CALLBACK_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: formData.toString()
      });
      const data = await resp.json();
      if(data.ok){
        msg.className='status ok';
        msg.textContent='Solicitud enviada correctamente. Nuestro equipo se comunicar√° contigo al correo registrado.';
      }else{
        msg.className='status error';
        msg.textContent=data.error || 'No fue posible enviar la solicitud.';
      }
    }catch(e){
      console.error(e);
      msg.className='status error';
      msg.textContent='Error al enviar la solicitud. Intenta de nuevo.';
    }
  }

  async function enviarActualizacionDatosAfiliado(){
    const cuenta = document.getElementById('actualizarCuenta').value.trim();
    const correo = document.getElementById('actualizarCorreo').value.trim();
    const celular = document.getElementById('actualizarCelular').value.trim();
    const id = document.getElementById('actualizarId').value.trim().toUpperCase();
    const archivoInput = document.getElementById('actualizarCertificado');
    const archivoNombre = archivoInput && archivoInput.value ? archivoInput.value.split('\\').pop() : '';
    const msg = document.getElementById('actualizarDatosMsg');

    msg.className='status';
    msg.style.color='#6b7280';
    msg.textContent='Enviando solicitud...';

    if(!correo || !id){
      msg.classList.add('error');
      msg.textContent='Debes ingresar al menos tu correo e ID.';
      return;
    }

    try{
      const formData = new URLSearchParams();
      formData.append('accion','actualizar_datos_afiliado');
      formData.append('cuenta', cuenta);
      formData.append('correo', correo);
      formData.append('celular', celular);
      formData.append('idAfiliado', id);
      formData.append('certificadoNombre', archivoNombre);

      const resp = await fetch(API_CALLBACK_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: formData.toString()
      });
      const data = await resp.json();
      if(data.ok){
        msg.className='status ok';
        msg.textContent='Solicitud enviada correctamente. Revisaremos tu informaci√≥n y te contactaremos al correo registrado.';
      }else{
        msg.className='status error';
        msg.textContent=data.error || 'No fue posible enviar la actualizaci√≥n de datos.';
      }
    }catch(e){
      console.error(e);
      msg.className='status error';
      msg.textContent='Error al enviar la actualizaci√≥n. Intenta de nuevo.';
    }
  }

  if('serviceWorker' in navigator){
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('Service Worker registrado:', reg.scope))
        .catch(err => console.error('Error registrando Service Worker', err));
    });
  }

  let deferredInstallPrompt = null;

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredInstallPrompt = e;
    console.log('Evento beforeinstallprompt capturado');
  });

  function esIOS(){
    const ua = window.navigator.userAgent || '';
    return /iphone|ipad|ipod/i.test(ua);
  }

  function esAndroid(){
    const ua = window.navigator.userAgent || '';
    return /android/i.test(ua);
  }

  function estaEnModoApp(){
    return window.matchMedia('(display-mode: standalone)').matches ||
      window.navigator.standalone === true;
  }

  function mostrarInstruccionesIOS(){
    alert(
      'Para instalar la app RADIZ en iPhone/iPad:\n\n' +
      '1. Toca el √≠cono "Compartir" (cuadro con flecha hacia arriba).\n' +
      '2. Elige "A√±adir a pantalla de inicio".\n' +
      '3. Confirma con "A√±adir".'
    );
  }

  async function manejarDescargaApp(){
    if(estaEnModoApp()){
      alert('La aplicaci√≥n RADIZ ya est√° instalada en este dispositivo.');
      return;
    }

    if(esIOS()){
      mostrarInstruccionesIOS();
      return;
    }

    if(deferredInstallPrompt){
      try{
        deferredInstallPrompt.prompt();
        const choice = await deferredInstallPrompt.userChoice;
        console.log('Resultado instalaci√≥n:', choice && choice.outcome);
        deferredInstallPrompt = null;
      }catch(e){
        console.error('Error al mostrar el prompt de instalaci√≥n', e);
      }
      return;
    }

    if(esAndroid()){
      alert(
        'Chrome todav√≠a no muestra el cuadro autom√°tico de instalaci√≥n.\n\n' +
        'Para instalar la app RADIZ:\n' +
        '1. Toca el √≠cono de tres puntos (‚ãÆ) en la esquina superior derecha.\n' +
        '2. Elige "Instalar aplicaci√≥n" o "A√±adir a pantalla de inicio".\n' +
        '3. Confirma con "Instalar".'
      );
      return;
    }

    alert(
      'Para instalar la app RADIZ en tu dispositivo, usa la opci√≥n ' +
      '"Instalar aplicaci√≥n" o "A√±adir a pantalla de inicio" del navegador.'
    );
  }

  async function loginInversiones(origen){
    const useLogin = (origen === 'login');

    const idLogin = document.getElementById('loginId');
    const passLogin = document.getElementById('loginPassword');
    const msgLogin = document.getElementById('loginMsg');

    const idModal = document.getElementById('invId');
    const passModal = document.getElementById('invPassword');
    const msgModal = document.getElementById('invLoginMsg');

    const idInput = useLogin ? idLogin : idModal;
    const passInput = useLogin ? passLogin : passModal;
    const msg = useLogin ? msgLogin : msgModal;

    if(!idInput || !passInput || !msg) return;

    if(useLogin){
      msg.className = 'login-msg';
    }else{
      msg.className = 'status';
    }
    msg.textContent = '';

    const idRaw = (idInput.value || '').trim();
    const pass = (passInput.value || '').trim();

    if(!idRaw || !pass){
      msg.classList.add('error');
      msg.textContent = 'Ingresa tu ID y tu contrase√±a.';
      return;
    }

    const id = idRaw.toUpperCase();

    try{
      localStorage.setItem(RADIZ_USER_KEY, id);
    }catch(e){}

    msg.textContent = 'Verificando credenciales...';

    try{
      const formData = new URLSearchParams();
      formData.append('accion','login_portal');
      formData.append('id', id);
      formData.append('password', pass);

      const resp = await fetch(API_URL,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: formData.toString()
      });
      const data = await resp.json();

      if(!data.ok){
        msg.className = useLogin ? 'login-msg error' : 'status error';
        msg.textContent = data.error || 'Usuario o contrase√±a incorrectos.';
        return;
      }

      const tipo = (data.tipo || '').toString().toUpperCase();
      const idFinal = (data.id || id).toString().toUpperCase();

      if(tipo === 'RENTING'){
        msg.className = useLogin ? 'login-msg ok' : 'status ok';
        msg.textContent = 'Acceso concedido. Abriendo tu panel...';
        if(!useLogin){ cerrarModal('modalInversiones'); }
        window.location.href = 'https://portal.radizco.com/logistica/?id=' + encodeURIComponent(idFinal);
      }else if(tipo === 'AFILIADO'){
        msg.className = useLogin ? 'login-msg ok' : 'status ok';
        msg.textContent = 'Acceso concedido. Abriendo tu portal de inversiones...';
        if(!useLogin){ cerrarModal('modalInversiones'); }
        window.location.href = 'inversiones/?id=' + encodeURIComponent(idFinal);
      }else{
        msg.className = useLogin ? 'login-msg error' : 'status error';
        msg.textContent = 'Tipo de usuario no reconocido para este ID.';
      }
    }catch(e){
      console.error(e);
      msg.className = useLogin ? 'login-msg error' : 'status error';
      msg.textContent = 'Error al iniciar sesi√≥n. Intenta de nuevo.';
    }
  }
</script>
</body>
</html>
