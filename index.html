<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PORTAL CLIENTES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://checkout.wompi.co/widget.js" async></script>
  <style>
    *{box-sizing:border-box}

    body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f5f6f8;
      color:#111827;
    }

    .page{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:32px 16px;
    }

    .container{
      position:relative;
      width:100%;
      max-width:960px;
      background:#ffffff;
      border-radius:24px;
      box-shadow:0 18px 45px rgba(15,23,42,.14);
      padding:28px 32px 32px;
      overflow:visible;
    }

    /* Logo Radiz */
    .logo-top{
      text-align:center;
      margin-bottom:12px;
    }
    .logo-top img{
      max-width:260px;
      max-height:120px;
      object-fit:contain;
    }

    /* GRID PRINCIPAL DOS COLUMNAS */
    .main-grid{
      display:grid;
      grid-template-columns:minmax(0,1.05fr) minmax(0,1.15fr);
      gap:24px;
      margin-top:8px;
    }

    .brand-card{
      position:relative;
      border-radius:22px;
      overflow:hidden;
      background:#0f172a;
      min-height:380px;
      box-shadow:0 18px 40px rgba(15,23,42,.32);
      color:#f9fafb;
    }
    .brand-image{
      position:absolute;
      inset:0;
    }
    .brand-image img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .brand-overlay{
      position:absolute;
      inset:0;
      background:linear-gradient(180deg,rgba(15,23,42,.15) 10%,rgba(15,23,42,.78) 80%);
    }
    .brand-copy{
      position:absolute;
      left:18px;
      right:18px;
      bottom:18px;
    }
    .brand-kicker{
      margin:0 0 4px;
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#bfdbfe;
      font-weight:600;
    }
    .brand-copy h2{
      margin:0;
      font-size:1.45rem;
      line-height:1.25;
      font-weight:700;
    }

    .panel-main{
      display:flex;
      flex-direction:column;
    }

    /* Banner bienvenida */
    .welcome-banner{
      display:flex;
      align-items:flex-start;
      gap:10px;
      background:#e0f2fe;
      border-radius:16px;
      padding:10px 14px;
      margin-bottom:18px;
      border:1px solid #bfdbfe;
    }
    .welcome-icon{
      position:relative;
      width:32px;
      height:32px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#2563eb;
      color:transparent;
      flex-shrink:0;
    }
    .welcome-icon::before{
      content:"";
      position:absolute;
      width:3px;
      height:10px;
      border-radius:999px;
      background:#ffffff;
      top:11px;
      left:50%;
      transform:translateX(-50%);
    }
    .welcome-icon::after{
      content:"";
      position:absolute;
      width:3px;
      height:3px;
      border-radius:999px;
      background:#ffffff;
      top:7px;
      left:50%;
      transform:translateX(-50%);
    }
    .welcome-text-title{
      font-size:.95rem;
      font-weight:600;
      margin:0 0 2px;
      color:#0f172a;
    }
    .welcome-text-sub{
      margin:0;
      font-size:.85rem;
      color:#4b5563;
    }

    .portal-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:12px;
    }
    h1{
      margin:0 0 4px;
      font-size:1.9rem;
      letter-spacing:.03em;
    }

    .card{
      position:relative;
      border-radius:18px;
      border:1px solid #e5e7eb;
      padding:16px 18px 16px;
      background:#ffffff;
      font-size:.9rem;
      transition:border-color .15s,box-shadow .15s,transform .1s,background .15s;
    }
    .card h2{
      margin:0 0 8px;
      font-size:1.05rem;
      font-weight:700;
      color:#111827;
    }
    .card p{
      margin:3px 0;
      color:#111827;
      font-size:.9rem;
    }
    .card p strong{
      font-weight:600;
    }
    .card:hover{
      border-color:#2563eb;
      box-shadow:0 16px 34px rgba(37,99,235,.18);
      background:#f9fbff;
      transform:translateY(-1px);
    }

    .card-consulta{
      margin-bottom:18px;
    }
    .card-pago{
      margin-bottom:18px;
    }

    /* Iconos SVG para tarjetas de resultados */
    .card-contrato::before,
    .card-pagos::before,
    .card-mantenimientos::before{
      content:"";
      position:absolute;
      top:18px;
      left:18px;
      width:26px;
      height:26px;
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
    }
    .card-contrato::before{
      background-image:url('ícono_contrato1.svg');
    }
    .card-pagos::before{
      background-image:url('ícono_pagos.svg');
    }
    .card-mantenimientos::before{
      background-image:url('ícono_mantenimientos.svg');
    }
    .card-contrato h2,
    .card-pagos h2,
    .card-mantenimientos h2{
      margin-left:40px;
    }
    .card-mantenimientos:hover{
      background:#fff7ed;
      border-color:#f97316;
      box-shadow:0 18px 38px rgba(249,115,22,.22);
    }

    /* Títulos de sección (consulta / pago) */
    .section-title{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
    }
    .section-title span{
      font-size:1.05rem;
      font-weight:700;
      color:#111827;
    }
    .section-icon{
      position:relative;
      width:28px;
      height:28px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#eff6ff;
      flex-shrink:0;
    }
    /* Icono de lupa (consulta) */
    .section-icon-search::before{
      content:"";
      position:absolute;
      width:13px;
      height:13px;
      border-radius:999px;
      border:2px solid #2563eb;
      top:6px;
      left:7px;
      box-sizing:border-box;
    }
    .section-icon-search::after{
      content:"";
      position:absolute;
      width:8px;
      height:2px;
      border-radius:999px;
      background:#2563eb;
      bottom:7px;
      right:6px;
      transform:rotate(45deg);
    }
    /* Icono $ en líneas (pago) */
    .section-icon-money::before{
      content:"$";
      position:absolute;
      font-size:16px;
      font-weight:700;
      color:#2563eb;
    }

    label{
      font-size:.9rem;
      font-weight:600;
      color:#374151;
    }
    .form-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-top:6px;
      margin-bottom:10px;
      align-items:flex-end;
    }
    input[type="text"],
    input[type="number"],
    input[type="email"]{
      width:100%;
      padding:10px 12px;
      border-radius:9px;
      border:1px solid #d1d5db;
      font-size:.95rem;
      outline:none;
      transition:border-color .15s,box-shadow .15s,background .15s;
      background:#f9fafb;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="email"]:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.18);
      background:#ffffff;
    }

    button{
      padding:11px 22px;
      border-radius:999px;
      border:none;
      font-size:.95rem;
      font-weight:600;
      cursor:pointer;
      background:#2563eb;
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      box-shadow:0 12px 26px rgba(37,99,235,.45);
      transition:transform .1s,box-shadow .1s,background .1s;
      white-space:nowrap;
    }
    button:hover{
      transform:translateY(-1px);
      background:#1d4ed8;
      box-shadow:0 16px 32px rgba(37,99,235,.55);
    }
    button:disabled{
      opacity:.65;
      cursor:default;
      box-shadow:none;
      transform:none;
    }

    /* Botones principales alineados y del mismo tamaño */
    .btn-main{
      min-width:190px;
      justify-content:center;
    }

    .btn-afiliado{
      background:#f97316;
      box-shadow:0 12px 26px rgba(249,115,22,.45);
    }
    .btn-afiliado:hover{
      background:#ea580c;
      box-shadow:0 16px 32px rgba(249,115,22,.6);
    }

    .status{
      font-size:.9rem;
      margin-top:4px;
      min-height:1.2em;
    }
    .status.error{color:#b91c1c}
    .status.ok{color:#065f46}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:16px;
      margin-top:6px;
      margin-bottom:18px;
    }

    ul{padding-left:18px;margin:6px 0}
    li{margin-bottom:4px}

    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:600;
      text-transform:uppercase;
    }
    .badge-activo{background:#dcfce7;color:#166534}
    .badge-inactivo{background:#fee2e2;color:#b91c1c}

    footer{
      margin-top:10px;
      font-size:.75rem;
      color:#9ca3af;
      text-align:center;
    }

    /* Pago Wompi */
    #seccionPago h2{
      font-size:1.05rem;
      margin:0 0 4px;
      color:#111827;
    }
    #seccionPago p{
      font-size:.9rem;
      color:#4b5563;
      margin:4px 0 10px;
    }
    #seccionPago .row-pago{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    #montoPago{
      width:220px;
    }
    #pagoError{
      color:#dc2626;
      margin-top:6px;
      font-size:.85rem;
      display:none;
    }
    #pagoContratoError{
      color:#dc2626;
      margin-top:4px;
      font-size:.85rem;
      display:none;
    }

    /* Fila de consulta (misma lógica que pagos) */
    .row-consulta{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:6px;
      margin-bottom:10px;
    }
    #idContrato{
      width:220px;
    }

    /* Botón Link de afiliado centrado */
    .affiliate-row{
      margin-top:18px;
      display:flex;
      justify-content:center;
    }

    /* FAB menú */
    .fab-menu{
      position:absolute;
      top:24px;
      right:24px;
      z-index:20;
      display:none;
    }
    .fab-btn{
      width:54px;
      height:54px;
      border-radius:999px;
      background:#2563eb;
      border:none;
      box-shadow:0 10px 24px rgba(37,99,235,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:transform .12s,box-shadow .12s,background .12s;
    }
    .fab-btn:hover{
      transform:translateY(-1px);
      background:#1d4ed8;
      box-shadow:0 14px 32px rgba(37,99,235,.55);
    }
    .fab-btn span{
      display:block;
      width:22px;
      height:2px;
      border-radius:999px;
      background:#fff;
      position:relative;
    }
    .fab-btn span::before,
    .fab-btn span::after{
      content:"";
      position:absolute;
      left:0;
      width:22px;
      height:2px;
      border-radius:999px;
      background:#fff;
    }
    .fab-btn span::before{top:-6px}
    .fab-btn span::after{top:6px}

    .menu-panel{
      position:absolute;
      top:86px;
      right:28px;
      background:#ffffff;
      border-radius:14px;
      box-shadow:0 12px 30px rgba(15,23,42,.22);
      padding:8px 0;
      width:220px;
      display:none;
      z-index:25;
    }
    .menu-title{
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-weight:600;
      color:#6b7280;
      padding:6px 14px 4px;
    }
    .menu-item{
      padding:7px 14px;
      font-size:.9rem;
      cursor:pointer;
      color:#111827;
    }
    .menu-item:hover{
      background:#eff6ff;
      color:#1d4ed8;
    }

    /* Modales */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal{
      background:#fff;
      border-radius:18px;
      max-width:480px;
      width:90%;
      padding:18px 20px 18px;
      box-shadow:0 20px 45px rgba(15,23,42,.4);
      font-size:.9rem;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .modal-header h3{
      margin:0;
      font-size:1.05rem;
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size:1.3rem;
      cursor:pointer;
      color:#6b7280;
    }
    .modal p{margin:4px 0;color:#111827}
    .modal label{display:block;margin-top:8px;margin-bottom:3px}
    .modal-actions{
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .link-copy-row{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:4px;
    }
    .link-copy-row input{
      flex:1;
    }
    .copy-msg{
      font-size:.8rem;
      margin-top:6px;
      color:#6b7280;
    }

    @media(max-width:900px){
      .main-grid{
        grid-template-columns:1fr;
      }
      .brand-card{
        min-height:260px;
      }
    }

    @media(max-width:640px){
      .container{
        padding:22px 18px 24px;
        border-radius:18px;
      }
      .portal-header{
        flex-direction:column;
        align-items:flex-start;
      }
      .fab-menu{
        top:16px;
        right:16px;
      }
      #montoPago{
        width:100%;
      }
      #idContrato{
        width:100%;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="container">
    <div class="logo-top">
      <img src="logoradiz.png" alt="Logo RADIZ" id="logo-radiz">
    </div>

    <!-- Botón menú flotante -->
    <div class="fab-menu" id="fabMenu">
      <button class="fab-btn" type="button" onclick="toggleMenu()">
        <span></span>
      </button>
      <div class="menu-panel" id="menuPanel">
        <div class="menu-title" id="menuTitle">Opciones</div>
        <!-- Para renting -->
        <div id="menuRenting" style="display:none;">
          <div class="menu-item" onclick="abrirModal('modalBeneficios')">Beneficios</div>
          <div class="menu-item" onclick="abrirModal('modalHistorialPagos')">Historial de pagos</div>
          <div class="menu-item" onclick="abrirModal('modalTaller')">Taller asignado</div>
        </div>
        <!-- Para afiliados -->
        <div id="menuAfiliado" style="display:none;">
          <div class="menu-item" onclick="abrirModal('modalFechaPagosAfiliado')">Fecha de pagos</div>
          <div class="menu-item" onclick="abrirModal('modalVehiculosAfiliado')">Cantidad de vehículos</div>
          <div class="menu-item" onclick="abrirModal('modalLiquidacionesAfiliado')">Liquidaciones</div>
        </div>
      </div>
    </div>

    <!-- GRID PRINCIPAL -->
    <div class="main-grid">
      <!-- COLUMNA IZQUIERDA: CARD CORPORATIVA -->
      <div class="brand-card">
        <div class="brand-image">
          <img src="radiz-driver.jpg.jpg" alt="Conductor Radiz frente a vehículos de carga">
        </div>
        <div class="brand-overlay"></div>
        <div class="brand-copy">
          <p class="brand-kicker">Una marca de Proyecto I45 S.A.S.</p>
          <h2>Vehículos que dignifican</h2>
        </div>
      </div>

      <!-- COLUMNA DERECHA: PANEL DEL PORTAL -->
      <div class="panel-main">
        <div class="welcome-banner">
          <div class="welcome-icon"></div>
          <div>
            <p class="welcome-text-title">¡Bienvenido a tu portal Radiz!</p>
            <p class="welcome-text-sub">Consulta tu contrato, revisa tus pagos y realiza pagos en línea de forma segura.</p>
          </div>
        </div>

        <header class="portal-header">
          <div>
            <h1>PORTAL CLIENTES</h1>
          </div>
        </header>

        <!-- Consulta de contrato -->
        <div class="card card-consulta">
          <div class="section-title">
            <div class="section-icon section-icon-search"></div>
            <span>Consulta de contrato</span>
          </div>
          <label for="idContrato">ID CONTRATO</label>
          <div class="row-consulta">
            <input type="text" id="idContrato" placeholder="Ejemplo: R-0001">
            <button id="btnConsultar" class="btn-main" onclick="consultar()">Consultar</button>
          </div>
          <div id="status" class="status"></div>
        </div>

        <!-- Realizar pago -->
        <div class="card card-pago" id="seccionPago">
          <div class="section-title">
            <div class="section-icon section-icon-money"></div>
            <span>Realizar pago</span>
          </div>
          <p>Ingresa el monto a pagar y completa el proceso con Wompi.</p>
          <label for="montoPago">Monto a pagar (COP)</label>
          <div class="row-pago">
            <input id="montoPago" type="number" min="170000" step="1000" placeholder="Ej: 170000">
            <button type="button" class="btn-main" onclick="crearPagoWompi()">Pagar con Wompi</button>
          </div>
          <p id="pagoError">Ingresa un monto válido (mínimo 170.000).</p>
          <p id="pagoContratoError">Digita tu código de contrato.</p>
        </div>

        <!-- Botón Link de afiliado -->
        <div class="affiliate-row">
          <button type="button" class="btn-main btn-afiliado" onclick="abrirModal('modalAfiliado')">
            Link de referidos
          </button>
        </div>

        <!-- Resultados -->
        <div class="grid" id="resultados" style="display:none;">
          <div class="card card-contrato" id="cardContrato"></div>
          <div class="card card-pagos" id="cardPagos"></div>
          <div class="card card-mantenimientos" id="cardMantenimientos"></div>
        </div>

        <footer>Versión interna • RADIZ Suministro Vehicular</footer>
      </div>
    </div>
  </div>
</div>

<!-- MODALES RENTING -->
<div class="modal-backdrop" id="modalBeneficios">
  <div class="modal">
    <div class="modal-header">
      <h3>Beneficios del plan</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalBeneficios')">&times;</button>
    </div>
    <p id="modalBeneficiosTexto">Información no disponible.</p>
  </div>
</div>

<div class="modal-backdrop" id="modalHistorialPagos">
  <div class="modal">
    <div class="modal-header">
      <h3>Solicitar historial de pagos</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalHistorialPagos')">&times;</button>
    </div>
    <p style="margin-bottom:6px;">Ingresa tu correo electrónico y el ID de contrato para enviarte el historial en PDF.</p>
    <label for="correoHistorial">Correo electrónico</label>
    <input type="email" id="correoHistorial" placeholder="ejemplo@correo.com">
    <label for="idHistorial">ID de contrato</label>
    <input type="text" id="idHistorial" placeholder="Ej: R-0001">
    <p id="historialMsg" style="font-size:.85rem;margin-top:6px;color:#6b7280;"></p>
    <div class="modal-actions">
      <button type="button" onclick="cerrarModal('modalHistorialPagos')">Cerrar</button>
      <button type="button" onclick="enviarSolicitudHistorial()">Enviar solicitud</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalTaller">
  <div class="modal">
    <div class="modal-header">
      <h3>Taller asignado</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalTaller')">&times;</button>
    </div>
    <p id="modalTallerTexto">Información no disponible.</p>
  </div>
</div>

<!-- MODALES AFILIADOS -->
<div class="modal-backdrop" id="modalFechaPagosAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Fecha de pagos al afiliado</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalFechaPagosAfiliado')">&times;</button>
    </div>
    <p id="modalFechaPagosTexto">Dato no disponible.</p>
  </div>
</div>

<div class="modal-backdrop" id="modalVehiculosAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Cantidad de vehículos afiliados</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalVehiculosAfiliado')">&times;</button>
    </div>
    <p id="modalVehiculosTexto">Número de vehículos: Dato no disponible.</p>
  </div>
</div>

<div class="modal-backdrop" id="modalLiquidacionesAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Resumen de liquidaciones</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalLiquidacionesAfiliado')">&times;</button>
    </div>
    <p id="modalLiquidacionesTexto1">Número de liquidaciones: Dato no disponible.</p>
    <p id="modalLiquidacionesTexto2">Valor total liquidado: Dato no disponible.</p>
  </div>
</div>

<!-- MODAL LINK DE AFILIADO -->
<div class="modal-backdrop" id="modalAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Link de afiliado</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalAfiliado')">&times;</button>
    </div>
    <p>
      Comparte nuestro link de referidos con tu código de contrato (ejemplo: R-0001) y gana hasta
      $70.000 pesos por cada referido aprobado.
    </p>
    <label for="linkAfiliadoInput">Link del formulario</label>
    <div class="link-copy-row">
      <input id="linkAfiliadoInput" type="text" readonly value="https://forms.gle/Lv1Rkp9qWQigUS4g8">
      <button type="button" onclick="copiarLinkAfiliado()">Copiar</button>
    </div>
    <p id="linkAfiliadoMsg" class="copy-msg"></p>
  </div>
</div>

<script>
  const API_URL='https://script.google.com/macros/s/AKfycbxNiAZCMVvaagzFjYQgIsQkGEWJPui9baIHcO_-JjeJ6HvDYdDU5BdH8R6zzD3zDUw/exec';
  const WOMPI_PUBLIC_KEY='pub_prod_D1w0Ys7mW5OJOueJoMi1rA5aLYJvlN06';
  const WOMPI_INTEGRITY_KEY='prod_integrity_zNC4ZqryuKzC75Cp72boasFFTLgzmhKN';
  const WOMPI_REDIRECT_URL='https://portal.radizco.com/';
  const API_CALLBACK_URL = API_URL;

  let tipoUsuarioActual=null;
  let datosContratoActual=null;
  let datosAfiliadoActual=null;
  let resumenAfiliadoVehiculos=0;
  let resumenAfiliadoMantenimientos=0;

  function toggleMenu(){
    const panel=document.getElementById('menuPanel');
    panel.style.display=panel.style.display==='block'?'none':'block';
  }
  function abrirModal(id){
    document.getElementById(id).style.display='flex';
    const menu=document.getElementById('menuPanel');
    if(menu) menu.style.display='none';
  }
  function cerrarModal(id){
    document.getElementById(id).style.display='none';
  }

  async function consultar(){
    const id=document.getElementById('idContrato').value.trim();
    const status=document.getElementById('status');
    const btn=document.getElementById('btnConsultar');
    const resultados=document.getElementById('resultados');
    const cardContrato=document.getElementById('cardContrato');
    const cardPagos=document.getElementById('cardPagos');
    const cardMantenimientos=document.getElementById('cardMantenimientos');
    const fabMenu=document.getElementById('fabMenu');
    const menuRenting=document.getElementById('menuRenting');
    const menuAfiliado=document.getElementById('menuAfiliado');

    status.className='status';
    status.textContent='';
    resultados.style.display='none';
    fabMenu.style.display='none';
    document.getElementById('menuPanel').style.display='none';

    if(!id){
      status.classList.add('error');
      status.textContent='Por favor ingresa un ID de contrato.';
      return;
    }

    btn.disabled=true;
    status.textContent='Consultando información...';

    try{
      const resp=await fetch(API_URL+'?id='+encodeURIComponent(id));
      const data=await resp.json();

      if(!data.ok){
        status.className='status error';
        status.textContent=data.error||'No se encontró información para ese contrato.';
        btn.disabled=false;
        return;
      }

      const c=data.contrato||{};
      datosContratoActual=c;

      const tipo=(c['TIPO USUARIO']||'').toString().toUpperCase();
      tipoUsuarioActual=tipo;

      const pagos=data.pagos||[];
      const rawM=data.mantenimientos??data.mantenimiento??data.mtos??data.manten??[];
      const mts=Array.isArray(rawM)?rawM:(rawM?[rawM]:[]);
      const beneficiosTexto=c['BENEFICIOS']||'Información no disponible';

      // limpiar tarjetas
      cardContrato.innerHTML='';
      cardPagos.innerHTML='';
      cardMantenimientos.innerHTML='';

      if(tipo==='AFILIADO'){
        const afiliados=data.afiliados||[];
        const vehiculosAll=data.vehiculos||[];

        const idAfiliado=(c['ID AFILIADO']||id).toString().trim();

        const af = afiliados.find(a =>
          String(a['ID AFILIADO'] || '').trim() === idAfiliado
        ) || {};

        datosAfiliadoActual=af;

        const nombreAf = af['NOMBRE'] || c['ID CLIENTE'] || 'Dato no disponible';
        const documentoAf = af['NO DOCUMENTO'] || 'Dato no disponible';

        let numLiqTexto='Dato no disponible';
        if(af['NO LIQUIDACIONES']!==undefined && af['NO LIQUIDACIONES']!==''){
          numLiqTexto=af['NO LIQUIDACIONES'];
        }

        let valorLiqTexto='Dato no disponible';
        if(af['VALOR LIQUIDADO']!==undefined && af['VALOR LIQUIDADO']!==''){
          const bruto=af['VALOR LIQUIDADO'];
          if(typeof bruto==='number'){
            valorLiqTexto=formatearNumero(bruto);
          }else{
            valorLiqTexto=String(bruto);
          }
        }

        cardContrato.innerHTML=
          '<h2>Afiliado</h2>'+
          '<p><strong>ID contrato:</strong> '+(c['ID CONTRATO']||id)+'</p>'+
          '<p><strong>Nombre:</strong> '+nombreAf+'</p>'+
          '<p><strong>Documento:</strong> '+documentoAf+'</p>'+
          '<p><strong>No. liquidaciones:</strong> '+numLiqTexto+'</p>'+
          '<p><strong>Valor liquidado:</strong> '+valorLiqTexto+'</p>';

        const pagoRelacionado=pagos.find(p=>String(p['ID CONTRATO']).trim()===id);
        const diasCorte=pagoRelacionado?(pagoRelacionado['DÍAS DE CORTE']||pagoRelacionado['DIAS DE CORTE']||'Dato no disponible'):'Dato no disponible';

        cardPagos.innerHTML=
          '<h2>Pagos</h2>'+
          '<p><strong>Días de corte:</strong> '+diasCorte+'</p>'+
          '<p><strong>Inicio contrato:</strong> '+formatearFecha(c['INICIO'])+'</p>';

        const vehiculosContrato = vehiculosAll.filter(v => {
          const idContrVeh = String(v['ID CONTRATO'] || '').trim();
          const idAfiliadoVeh = String(v['ID AFILIADO'] || '').trim();
          return idContrVeh === id || idAfiliadoVeh === idAfiliado;
        });

        const numVehiculos=vehiculosContrato.length;
        resumenAfiliadoVehiculos=numVehiculos;

        const mtsAfiliado=mts.filter(m=>String(m['ID CONTRATO']||'').trim()===id);
        const numMts=mtsAfiliado.length;
        resumenAfiliadoMantenimientos=numMts;

        cardMantenimientos.innerHTML=
          '<h2>Vehículos y mantenimientos</h2>'+
          '<p><strong>Cantidad de vehículos afiliados:</strong> '+(numVehiculos||'0')+'</p>'+
          '<p><strong>Mantenimientos registrados:</strong> '+(numMts||'0')+'</p>';

        const modalFecha=document.getElementById('modalFechaPagosTexto');
        modalFecha.textContent='Días de corte de pagos: '+diasCorte;

        document.getElementById('modalVehiculosTexto').textContent=
          'Número de vehículos: '+(numVehiculos||'0');

        document.getElementById('modalLiquidacionesTexto1').textContent=
          'Número de liquidaciones: '+numLiqTexto;
        document.getElementById('modalLiquidacionesTexto2').textContent=
          'Valor total liquidado: '+valorLiqTexto;

        menuRenting.style.display='none';
        menuAfiliado.style.display='block';
        fabMenu.style.display='block';

      }else{
        datosAfiliadoActual=null;

        const estado=(c['ESTADO']||'').toString().toUpperCase();

        cardContrato.innerHTML=
          '<h2>Contrato</h2>'+
          '<p><strong>ID:</strong> '+(c['ID CONTRATO']||'')+'</p>'+
          '<p><strong>Tipo usuario:</strong> '+(c['TIPO USUARIO']||'')+'</p>'+
          '<p><strong>Vehículo:</strong> '+(c['ID VEHÍCULO']||'')+'</p>'+
          '<p><strong>Inicio:</strong> '+formatearFecha(c['INICIO'])+'</p>'+
          '<p><strong>Fin:</strong> '+formatearFecha(c['FIN'])+'</p>'+
          '<p><strong>Tarifa semanal:</strong> '+formatearNumero(c['TARIFA SEMANAL'])+'</p>'+
          '<p><strong>Beneficios:</strong> '+beneficiosTexto+'</p>'+
          '<p><span class="badge '+(estado==='ACTIVO'?'badge-activo':'badge-inactivo')+'">'+(estado||'SIN ESTADO')+'</span></p>';

        if(pagos.length===0){
          cardPagos.innerHTML='<h2>Pagos</h2><p>No hay pagos registrados para este contrato.</p>';
        }else{
          const items=pagos.map(p=>
            '<li>'+
            '<strong>ID pago:</strong> '+(p['ID PAGO']||'')+'<br>'+
            '<strong>ID contrato:</strong> '+(p['ID CONTRATO']||'')+'<br>'+
            '<strong>Días de corte:</strong> '+(p['DÍAS DE CORTE']||p['DIAS DE CORTE']||'')+'<br>'+
            '<strong>Gasto mantenimientos:</strong> '+formatearNumero(p['GASTO MANTENIMIENTOS'])+'<br>'+
            '<strong>Tarifas completadas:</strong> '+(p['TARIFAS COMPLETADAS']||'')+'<br>'+
            '<strong>Tarifas vencidas:</strong> '+(p['TARIFAS VENCIDAS']||'')+'<br>'+
            '<strong>Referencia:</strong> '+(p['REFERENCIA']||'')+
            '</li>'
          ).join('');
          cardPagos.innerHTML='<h2>Pagos</h2><ul>'+items+'</ul>';
        }

        if(mts.length===0){
          cardMantenimientos.innerHTML='<h2>Mantenimientos</h2><p>No hay mantenimientos registrados para este contrato.</p>';
        }else{
          const totalM=mts.reduce((s,m)=>s+(Number(m['VALOR MTOS'])||0),0);
          const itemsM=mts.map(m=>
            '<li>'+
            '<strong>ID vehículo:</strong> '+(m['ID VEHÍCULO']||'')+'<br>'+
            '<strong>Último mantenimiento:</strong> '+formatearFecha(m['ÚLTIMO MANTENIMIENTO']||m['ULTIMO MANTENIMIENTO']||m['FECHA ULT. MANTENIMIENTO'])+'<br>'+
            '<strong>Tipo:</strong> '+(m['TIPO']||m['TIPO ULT. MANTENIMIENTO']||'')+'<br>'+
            '<strong>Realizados:</strong> '+(m['REALIZADOS']||m['MTOS REALIZADOS']||'')+'<br>'+
            '<strong>Valor general:</strong> '+formatearNumero(m['VALOR GENERAL']||m['VALOR MTOS'])+'<br>'+
            '<strong>Taller asignado:</strong> '+(m['TALLER ASIGNADO']||'')+
            '</li>'
          ).join('');
          cardMantenimientos.innerHTML=
            '<h2>Mantenimientos</h2>'+
            '<p><strong>Total mantenimientos:</strong> '+formatearNumero(totalM)+'</p>'+
            '<ul>'+itemsM+'</ul>';
        }

        document.getElementById('modalBeneficiosTexto').textContent=beneficiosTexto||'Información no disponible.';
        const tallerEjemplo='Taller asignado: '+(mts[0]?.['TALLER ASIGNADO']||'Información no disponible.');
        document.getElementById('modalTallerTexto').textContent=tallerEjemplo;

        menuRenting.style.display='block';
        menuAfiliado.style.display='none';
        fabMenu.style.display='block';
      }

      resultados.style.display='grid';
      status.className='status ok';
      status.textContent='Información cargada correctamente.';
    }catch(e){
      console.error(e);
      status.className='status error';
      status.textContent='Error al consultar la información. Intenta de nuevo.';
    }finally{
      btn.disabled=false;
    }
  }

  function formatearNumero(n){
    const num=Number(n);
    if(isNaN(num))return n||'';
    return num.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
  }

  function formatearFecha(v){
    if(!v)return'';
    const d=new Date(v);
    if(isNaN(d.getTime()))return v;
    return d.toLocaleDateString('es-CO');
  }

  async function generarIntegritySignature(reference, amountInCents, currency){
    const encoder=new TextEncoder();
    const data=`${reference}${amountInCents}${currency}${WOMPI_INTEGRITY_KEY}`;
    const hashBuffer=await crypto.subtle.digest('SHA-256', encoder.encode(data));
    const hashArray=Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  async function crearPagoWompi(){
    const montoInput=document.getElementById('montoPago');
    const errorLabel=document.getElementById('pagoError');
    const contratoError=document.getElementById('pagoContratoError');
    const valor=parseInt(montoInput.value,10);
    const idContrato=(document.getElementById('idContrato').value||'').trim();

    errorLabel.style.display='none';
    contratoError.style.display='none';

    if(!idContrato){
      contratoError.style.display='block';
      return;
    }

    if(!valor||valor<170000){
      errorLabel.style.display='block';
      return;
    }

    if(typeof WidgetCheckout==='undefined'){
      alert('No se pudo cargar el checkout de Wompi. Por favor recarga la página.');
      return;
    }

    const amountInCents = valor*100;
    const reference='PAGO_'+idContrato+'_'+Date.now();
    const currency='COP';

    try{
      const integritySignature=await generarIntegritySignature(reference,amountInCents,currency);

      const checkout=new WidgetCheckout({
        currency:currency,
        amountInCents:amountInCents,
        reference:reference,
        publicKey:WOMPI_PUBLIC_KEY,
        signature:{ integrity: integritySignature },
        redirectUrl:WOMPI_REDIRECT_URL
      });

      checkout.open(function(result){
        const transaction=result.transaction;
        console.log('Transacción Wompi:', transaction && transaction.id, transaction && transaction.status);
        // Registrar siempre la intención de pago para trazabilidad
        registrarPagoEnSheet(reference, valor, idContrato);
      });
    }catch(e){
      console.error('Error generando firma de integridad',e);
      alert('No fue posible iniciar el pago. Intenta de nuevo.');
    }
  }

  async function registrarPagoEnSheet(reference, valor, idContrato){
    try{
      const formData=new URLSearchParams();
      formData.append('accion','registrar_pago');
      formData.append('referencia',reference);
      formData.append('monto',valor);
      formData.append('idContrato',idContrato);
      formData.append('origen','PORTAL_WEB');

      await fetch(API_CALLBACK_URL,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:formData.toString()
      });
    }catch(e){
      console.error('Error registrando pago en hoja',e);
    }
  }

  async function enviarSolicitudHistorial(){
    const correo=document.getElementById('correoHistorial').value.trim();
    const idHist=document.getElementById('idHistorial').value.trim();
    const msg=document.getElementById('historialMsg');

    msg.style.color='#6b7280';
    msg.textContent='Enviando solicitud...';

    if(!correo||!idHist){
      msg.style.color='#b91c1c';
      msg.textContent='Debes ingresar el correo y el ID de contrato.';
      return;
    }

    try{
      const formData=new URLSearchParams();
      formData.append('accion','solicitar_historial');
      formData.append('correo',correo);
      formData.append('idContrato',idHist);

      const resp=await fetch(API_CALLBACK_URL,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:formData.toString()
      });
      const data=await resp.json();
      if(data.ok){
        msg.style.color='#065f46';
        msg.textContent='Solicitud enviada correctamente. Revisaremos y te enviaremos el historial al correo.';
      }else{
        msg.style.color='#b91c1c';
        msg.textContent=data.error||'Ocurrió un problema al enviar la solicitud.';
      }
    }catch(e){
      console.error(e);
      msg.style.color='#b91c1c';
      msg.textContent='Error al enviar la solicitud. Intenta de nuevo.';
    }
  }

  function copiarLinkAfiliado(){
    const input=document.getElementById('linkAfiliadoInput');
    const msg=document.getElementById('linkAfiliadoMsg');
    input.focus();
    input.select();
    try{
      const ok=document.execCommand('copy');
      if(ok){
        msg.style.color='#065f46';
        msg.textContent='Link copiado al portapapeles.';
      }else{
        msg.style.color='#b91c1c';
        msg.textContent='No se pudo copiar automáticamente. Selecciona y copia el link manualmente.';
      }
    }catch(e){
      console.error(e);
      msg.style.color='#b91c1c';
      msg.textContent='No se pudo copiar automáticamente. Selecciona y copia el link manualmente.';
    }
  }
</script>
</body>
</html>
