<!DOCTYPE html> 
<html lang="es"> 
<head> 
  <meta charset="UTF-8" /> 
  <title></title> 
  <meta name="viewport" content="width=device-width, initial-scale=1" /> 
 
  <!-- Colores PWA / navegador --> 
  <meta name="theme-color" content="#0f172a"> 
  <meta name="mobile-web-app-capable" content="yes"> 
  <meta name="apple-mobile-web-app-capable" content="yes"> 
 
  <!-- Manifest e íconos --> 
  <link rel="manifest" href="manifest.json"> 
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png"> 
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png"> 
  <link rel="apple-touch-icon" href="icon-192.png"> 
 
  <!-- Wompi --> 
  <script src="https://checkout.wompi.co/widget.js" async></script> 
 
  <style> 
    *{box-sizing:border-box} 
 
    body{ 
      margin:0; 
      padding:0; 
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; 
      background:#f5f6f8; 
      color:#111827; 
    } 
 
    .page{ 
      min-height:100vh; 
      display:flex; 
      align-items:flex-start; 
      justify-content:center; 
      padding:32px 16px; 
    } 
 
    .container{ 
      position:relative; 
      width:100%; 
      max-width:960px; 
      background:#ffffff; 
      border-radius:24px; 
      box-shadow:0 18px 45px rgba(15,23,42,.12); 
      padding:18px 18px 22px; 
      overflow:hidden; 
    } 
 
    .logo-top{ 
      display:flex; 
      justify-content:center; 
      padding:8px 0 4px; 
    } 
    #logo-radiz{ 
      width:44px; 
      height:44px; 
      object-fit:contain; 
    } 
 
    /* Menú flotante */ 
    .fab-menu{ 
      position:fixed; 
      right:16px; 
      bottom:16px; 
      z-index:9999; 
    } 
    .fab-btn{ 
      width:54px; 
      height:54px; 
      border:none; 
      border-radius:999px; 
      background:#0f172a; 
      color:#fff; 
      box-shadow:0 16px 36px rgba(15,23,42,.35); 
      cursor:pointer; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      position:relative; 
    } 
    .fab-btn span, 
    .fab-btn span::before, 
    .fab-btn span::after{ 
      content:""; 
      display:block; 
      width:22px; 
      height:2px; 
      background:#fff; 
      border-radius:2px; 
      position:absolute; 
      transition:.25s ease; 
    } 
    .fab-btn span{ 
      position:relative; 
    } 
    .fab-btn span::before{ 
      transform:translateY(-7px); 
    } 
    .fab-btn span::after{ 
      transform:translateY(7px); 
    } 
 
    .menu-panel{ 
      position:absolute; 
      right:0; 
      bottom:64px; 
      width:280px; 
      background:#fff; 
      border-radius:18px; 
      box-shadow:0 20px 50px rgba(15,23,42,.18); 
      overflow:hidden; 
      transform:translateY(10px); 
      opacity:0; 
      pointer-events:none; 
      transition:.22s ease; 
    } 
    .menu-panel.open{ 
      transform:translateY(0); 
      opacity:1; 
      pointer-events:auto; 
    } 
    .menu-title{ 
      padding:14px 16px; 
      font-weight:800; 
      background:#0f172a; 
      color:#fff; 
      font-size:14px; 
    } 
    .menu-item{ 
      padding:13px 16px; 
      border-bottom:1px solid #eef2f7; 
      font-size:14px; 
      cursor:pointer; 
    } 
    .menu-item:last-child{border-bottom:none} 
    .menu-item:hover{background:#f8fafc} 
 
    /* GRID */ 
    .main-grid{ 
      display:grid; 
      grid-template-columns: 1.15fr .85fr; 
      gap:18px; 
      margin-top:10px; 
      align-items:start; 
    } 
 
    .brand-card{ 
      position:relative; 
      border-radius:22px; 
      overflow:hidden; 
      min-height:440px; 
      background:#0f172a; 
      box-shadow:0 18px 45px rgba(15,23,42,.14); 
    } 
    .brand-image img{ 
      width:100%; 
      height:100%; 
      object-fit:cover; 
      display:block; 
      transform:scale(1.02); 
    } 
    .brand-overlay{ 
      position:absolute; 
      inset:0; 
      background:linear-gradient(to top, rgba(15,23,42,.75), rgba(15,23,42,.25)); 
    } 
    .brand-copy{ 
      position:absolute; 
      left:18px; 
      bottom:16px; 
      right:18px; 
      color:#fff; 
    } 
    .brand-kicker{ 
      margin:0 0 6px; 
      font-size:12px; 
      opacity:.92; 
    } 
    .brand-copy h2{ 
      margin:0; 
      font-size:28px; 
      line-height:1.05; 
      letter-spacing:-.02em; 
    } 
 
    .card{ 
      background:#ffffff; 
      border:1px solid #eef2f7; 
      border-radius:22px; 
      padding:16px; 
      box-shadow:0 10px 30px rgba(15,23,42,.08); 
    } 
 
    label{ 
      display:block; 
      font-weight:700; 
      font-size:12px; 
      margin:10px 0 6px; 
      color:#0f172a; 
    } 
    input, select, textarea{ 
      width:100%; 
      padding:12px 12px; 
      border:1px solid #e5e7eb; 
      border-radius:14px; 
      outline:none; 
      font-size:14px; 
      background:#fff; 
    } 
    input:focus, select:focus, textarea:focus{ 
      border-color:#2563eb; 
      box-shadow:0 0 0 4px rgba(37,99,235,.12); 
    } 
 
    .btn{ 
      display:inline-flex; 
      gap:8px; 
      align-items:center; 
      justify-content:center; 
      padding:12px 14px; 
      border:none; 
      border-radius:14px; 
      cursor:pointer; 
      font-weight:800; 
      font-size:14px; 
      transition:.15s ease; 
      user-select:none; 
    } 
    .btn-primary{ 
      background:#2563eb; 
      color:#fff; 
      box-shadow:0 12px 26px rgba(37,99,235,.35); 
    } 
    .btn-primary:hover{transform:translateY(-1px)} 
    .btn-secondary{ 
      background:#0f172a; 
      color:#fff; 
      box-shadow:0 12px 26px rgba(15,23,42,.25); 
    } 
    .btn-afiliado{ 
      background:#f97316; 
      color:#fff; 
      box-shadow:0 12px 26px rgba(249,115,22,.35); 
    } 
    .btn:disabled{ 
      opacity:.65; 
      cursor:default; 
      box-shadow:none; 
      transform:none; 
    } 
 
    .btn-main{ 
      min-width:190px; 
      justify-content:center; 
    } 
 
    .status{ 
      font-size:.9rem; 
      margin-top:4px; 
      min-height:1.2em; 
    } 
    .status.error{color:#b91c1c} 
    .status.ok{color:#065f46} 
 
    .grid{ 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); 
      gap:16px; 
      margin-top:6px; 
      margin-bottom:18px; 
    } 
 
    /* Modales */ 
    .modal-backdrop{ 
      position:fixed; 
      inset:0; 
      background:rgba(15,23,42,.55); 
      display:none; 
      align-items:center; 
      justify-content:center; 
      padding:18px; 
      z-index:99999; 
    } 
    .modal{ 
      width:100%; 
      max-width:540px; 
      background:#fff; 
      border-radius:22px; 
      box-shadow:0 22px 60px rgba(15,23,42,.25); 
      padding:16px; 
      position:relative; 
    } 
    .modal-header{ 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:10px; 
      margin-bottom:6px; 
    } 
    .modal-header h3{ 
      margin:0; 
      font-size:16px; 
      letter-spacing:-.01em; 
    } 
    .modal-close{ 
      width:38px; 
      height:38px; 
      border:none; 
      background:#f3f4f6; 
      border-radius:12px; 
      cursor:pointer; 
      font-size:20px; 
      line-height:1; 
    } 
    .modal-actions{ 
      display:flex; 
      gap:10px; 
      justify-content:flex-end; 
      margin-top:14px; 
    } 
    .modal-actions button{ 
      padding:10px 12px; 
      border:none; 
      border-radius:12px; 
      cursor:pointer; 
      font-weight:800; 
    } 
    .modal-actions button:first-child{ 
      background:#0f172a; 
      color:#fff; 
    } 
    .modal-actions button:last-child{ 
      background:#2563eb; 
      color:#fff; 
    } 
 
    /* Responsive */ 
    @media (max-width: 820px){ 
      .main-grid{grid-template-columns:1fr; } 
      .brand-card{min-height:260px} 
      .container{padding:14px} 
      .fab-menu{right:12px;bottom:12px} 
    } 
 
    /* ==============================
       LOGIN PRINCIPAL (estilo app)
       ============================== */
    .login-screen{
      position:fixed;
      inset:0;
      z-index:9999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px 18px calc(22px + env(safe-area-inset-bottom));
      background:#000; /* fallback */
      overflow:hidden;
    }
    .login-screen::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        linear-gradient(to bottom, rgba(15,23,42,.45), rgba(15,23,42,.78)),
        url('radiz-driver.jpg');
      background-size:cover;
      background-position:center;
      transform:scale(1.03);
      filter:saturate(1.05) contrast(1.03);
    }
    .login-content{
      position:relative;
      width:100%;
      max-width:420px;
      text-align:center;
      color:#fff;
    }
    .login-logo{
      display:flex;
      justify-content:center;
      margin-bottom:18px;
    }
    .login-logo img{
      width:42px;
      height:42px;
      object-fit:contain;
      border-radius:12px;
      background:rgba(255,255,255,.10);
      padding:8px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      box-shadow:0 10px 26px rgba(0,0,0,.30);
    }
    .login-hello{
      margin:0 0 18px;
      font-size:32px;
      line-height:1.05;
      font-weight:800;
      letter-spacing:-0.02em;
      text-shadow:0 10px 32px rgba(0,0,0,.45);
    }
    .login-form{
      margin:0 auto;
      width:100%;
      max-width:360px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .login-input{
      width:100%;
      padding:14px 14px;
      border-radius:14px;
      border:2px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.08);
      color:#fff;
      outline:none;
      font-size:16px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow:0 10px 26px rgba(0,0,0,.18);
    }
    .login-input::placeholder{ color:rgba(255,255,255,.70); }
    .login-input.user{
      border-color:rgba(37,99,235,.85);  /* Radiz azul */
    }
    .login-input.pass{
      border-color:rgba(249,115,22,.90); /* Radiz naranja */
    }
    .login-btn{
      margin-top:4px;
      width:100%;
      padding:14px 16px;
      border:none;
      border-radius:14px;
      background:#2563eb;
      color:#fff;
      font-weight:800;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 14px 30px rgba(37,99,235,.42);
    }
    .login-btn:active{ transform:translateY(1px); }
    #loginMsg{
      margin:2px 0 0;
      font-size:13px;
      min-height:18px;
      text-align:left;
      padding-left:6px;
    }
  </style> 
</head> 
<body>

<div id="loginScreen" class="login-screen">
  <div class="login-content">
    <div class="login-logo">
      <!-- Logo pequeño (misma ubicación de asset ya usada en este index) -->
      <img src="logoradiz.png" alt="RADIZ">
    </div>

    <h1 class="login-hello">¡Buenas buenas!</h1>

    <div class="login-form">
      <input id="loginUser" class="login-input user" type="text" inputmode="text"
             autocomplete="username" autocapitalize="characters"
             placeholder="Usuario (Ej: R7467 o A1020)">

      <input id="loginPass" class="login-input pass" type="password"
             autocomplete="current-password"
             placeholder="Contraseña">

      <p id="loginMsg" class="status"></p>

      <button id="loginBtn" class="login-btn" type="button">Entrar</button>
    </div>
  </div>
</div>
 
<div class="page" id="portalWrapper" style="display:none;"> 
  <div class="container"> 
    <div class="logo-top"> 
      <img src="logoradiz.png" alt="Logo RADIZ" id="logo-radiz"> 
    </div> 
 
    <!-- Botón menú flotante --> 
    <div class="fab-menu" id="fabMenu"> 
      <button class="fab-btn" type="button" onclick="toggleMenu()"> 
        <span></span> 
      </button> 
      <div class="menu-panel" id="menuPanel"> 
        <div class="menu-title" id="menuTitle">Opciones</div> 
 
        <!-- Menú inicial (antes de consultar contrato / sin sesión cargada) --> 
        <div id="menuInicial"> 
          <div class="menu-item" onclick="abrirModal('modalConsultar')">Consultar contrato</div> 
          <div class="menu-item" onclick="abrirModal('modalInversiones')">Portal de inversiones</div> 
          <div class="menu-item" onclick="abrirModal('modalAyuda')">Ayuda</div> 
          <div class="menu-item" onclick="abrirModal('modalDescargaApp')">Descarga la App</div> 
        </div> 
 
        <!-- Para renting (clientes tipo R) --> 
        <div id="menuRenting" style="display:none;"> 
          <div class="menu-item">Beneficios</div> 
          <div class="menu-item">Solicitar grúa</div> 
          <div class="menu-item" onclick="abrirModal('modalKilometraje')">Actualizar kilometraje</div> 
          <div class="menu-item">Señales</div> 
          <div class="menu-item" onclick="abrirModal('modalHistorialPagos')">Historial de pagos</div> 
          <div class="menu-item">Historial de mantenimientos</div> 
          <div class="menu-item" onclick="abrirModal('modalSaldoFavor')">Mi saldo a favor</div> 
          <div class="menu-item" onclick="abrirModal('modalAfiliado')">Link de referidos</div> 
          <div class="menu-item" onclick="abrirModal('modalIncidente')">Notificar incidente</div> 
          <div class="menu-item" onclick="abrirModal('modalTaller')">Taller asignado</div> 
        </div> 
 
        <!-- Para afiliados (clientes tipo A) --> 
        <div id="menuAfiliado" style="display:none;"> 
          <div class="menu-item">Beneficios</div> 
          <div class="menu-item" onclick="abrirModal('modalHistorialPagosAfiliado')">Historial de pagos</div> 
          <div class="menu-item" onclick="abrirModal('modalVehiculosAfiliado')">Mis vehículos</div> 
          <div class="menu-item" onclick="abrirModal('modalLiquidacionesAfiliado')">Mis liquidaciones</div> 
          <div class="menu-item" onclick="abrirModal('modalIncidente')">Notificar incidente</div> 
          <div class="menu-item" onclick="abrirModal('modalAyuda')">Ayuda</div> 
        </div> 
      </div> 
    </div> 
 
    <!-- GRID PRINCIPAL --> 
    <div class="main-grid"> 
      <!-- COLUMNA IZQUIERDA: CARD CORPORATIVA --> 
      <div class="brand-card"> 
        <div class="brand-image"> 
          <img src="radiz-driver.jpg.jpg" alt="Conductor Radiz frente a vehículos de carga"> 
        </div> 
        <div class="brand-overlay"></div> 
        <div class="brand-copy"> 
          <p class="brand-kicker">Una marca de Proyecto I45 S.A.S.</p> 
          <h2>Vehículos que dignifican</h2> 
        </div> 
      </div> 
 
      <!-- COLUMNA DERECHA: CONTENIDO DEL PORTAL --> 
      <div class="card"> 
        <div class="grid"> 
          <div> 
            <label for="idContrato">ID del contrato</label> 
            <input id="idContrato" type="text" placeholder="Ej: R7467" autocapitalize="characters"> 
          </div> 
          <div> 
            <label for="password">Contraseña</label> 
            <input id="password" type="password" placeholder="Tu contraseña"> 
          </div> 
        </div> 
 
        <div style="display:flex;gap:10px;flex-wrap:wrap;"> 
          <button class="btn btn-primary btn-main" type="button" onclick="consultarContrato()">Consultar</button> 
          <button class="btn btn-afiliado btn-main" type="button" onclick="abrirModal('modalAfiliado')">Link de referidos</button> 
        </div> 
 
        <div id="status" class="status"></div> 
      </div> 
 
      <!-- Realizar pago --> 
      <div class="card card-pago" id="seccionPago"> 
        <div class="section-title"> 
          <div class="section-icon section-icon-money"></div> 
          <span>Realizar pago</span> 
        </div> 
        <p>Ingresa el monto a pagar y completa el proceso con Wompi.</p> 
        <label for="montoPago">Monto a pagar (COP)</label> 
        <div class="row-pago"> 
          <input id="montoPago" type="number" min="170000" step="1000" placeholder="Ej: 250000"> 
        </div> 
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;"> 
          <button class="btn btn-primary btn-main" type="button" onclick="pagarWompi()">Pagar con Wompi</button> 
          <button class="btn btn-secondary btn-main" type="button" onclick="descargarApp()">Descarga la App</button> 
        </div> 
        <p id="statusPago" class="status"></p> 
      </div> 
    </div> 
  </div> 
</div> 
 
<!-- MODALES --> 
<div class="modal-backdrop" id="modalConsultar"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Consultar contrato</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalConsultar')">&times;</button> 
    </div> 
    <p>Ingrese su ID de contrato y contraseña para consultar.</p> 
    <label for="modalIdContrato">ID Contrato</label> 
    <input type="text" id="modalIdContrato" placeholder="Ej: R7467"> 
    <label for="modalPassword">Contraseña</label> 
    <input type="password" id="modalPassword" placeholder="Tu contraseña"> 
    <p id="modalLoginMsg" class="status"></p> 
    <div class="modal-actions"> 
      <button type="button" onclick="cerrarModal('modalConsultar')">Cerrar</button> 
      <button type="button" onclick="consultarContratoDesdeModal()">Entrar</button> 
    </div> 
  </div> 
</div> 
 
<div class="modal-backdrop" id="modalInversiones"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Iniciar sesión</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalInversiones')">&times;</button> 
    </div> 
    <p>Ingrese su ID y contraseña para acceder a su portal.</p> 
    <label for="invId">ID</label> 
    <input type="text" id="invId" placeholder="Ej: R4523"> 
 
    <label for="invPassword">Contraseña</label> 
    <input type="password" id="invPassword" placeholder="Tu contraseña"> 
    <p id="invLoginMsg" class="status"></p> 
    <div class="modal-actions"> 
      <button type="button" onclick="cerrarModal('modalInversiones')">Cerrar</button> 
      <button type="button" onclick="loginInversiones()">Entrar</button> 
    </div> 
    <p style="font-size:.8rem;margin-top:8px;color:#6b7280;"> 
      ¿Olvidó su contraseña? Escríbanos a notificacionespi45@gmail.com 
    </p> 
  </div> 
</div> 
 
<div class="modal-backdrop" id="modalAyuda"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Ayuda</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalAyuda')">&times;</button> 
    </div> 
    <p style="margin:0;color:#374151;font-size:14px;"> 
      Si necesitas soporte, escríbenos a notificacionespi45@gmail.com o envía un WhatsApp al número oficial. 
    </p> 
    <div class="modal-actions"> 
      <button type="button" onclick="cerrarModal('modalAyuda')">Cerrar</button> 
    </div> 
  </div> 
</div> 
 
<div class="modal-backdrop" id="modalDescargaApp"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Descarga la App</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalDescargaApp')">&times;</button> 
    </div> 
    <p style="margin:0;color:#374151;font-size:14px;"> 
      Próximamente encontrarás aquí los enlaces oficiales de descarga. 
    </p> 
    <div class="modal-actions"> 
      <button type="button" onclick="cerrarModal('modalDescargaApp')">Cerrar</button> 
    </div> 
  </div> 
</div> 
 
<div class="modal-backdrop" id="modalKilometraje"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Actualizar kilometraje</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalKilometraje')">&times;</button> 
    </div> 
    <label for="kmNuevo">Kilometraje actual</label> 
    <input type="number" id="kmNuevo" placeholder="Ej: 12345"> 
    <p id="kmMsg" class="status"></p> 
    <div class="modal-actions"> 
      <button type="button" onclick="cerrarModal('modalKilometraje')">Cerrar</button> 
      <button type="button" onclick="guardarKilometraje()">Guardar</button> 
    </div> 
  </div> 
</div> 
 
<div class="modal-backdrop" id="modalIncidente"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Notificar incidente</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalIncidente')">&times;</button> 
    </div> 
    <label for="incidenteTexto">Describe el incidente</label> 
    <textarea id="incidenteTexto" rows="4" placeholder="Escribe aquí..."></textarea> 
    <p id="incidenteMsg" class="status"></p> 
    <div class="modal-actions"> 
      <button type="button" onclick="cerrarModal('modalIncidente')">Cerrar</button> 
      <button type="button" onclick="enviarIncidente()">Enviar</button> 
    </div> 
  </div> 
</div> 
 
<div class="modal-backdrop" id="modalTaller"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Taller asignado</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalTaller')">&times;</button> 
    </div> 
    <p id="tallerTexto">Dato no disponible.</p> 
    <div class="modal-actions"> 
      <button type="button" onclick="cerrarModal('modalTaller')">Cerrar</button> 
    </div> 
  </div> 
</div> 
 
<div class="modal-backdrop" id="modalSaldoFavor"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Mi saldo a favor</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalSaldoFavor')">&times;</button> 
    </div> 
    <p id="saldoFavorTexto">Dato no disponible.</p> 
    <div class="modal-actions"> 
      <button type="button" onclick="cerrarModal('modalSaldoFavor')">Cerrar</button> 
    </div> 
  </div> 
</div> 
 
<div class="modal-backdrop" id="modalAfiliado"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Link de referidos</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalAfiliado')">&times;</button> 
    </div> 
    <p id="afiliadoTexto">Dato no disponible.</p> 
    <div class="modal-actions"> 
      <button type="button" onclick="cerrarModal('modalAfiliado')">Cerrar</button> 
    </div> 
  </div> 
</div> 
 
<div class="modal-backdrop" id="modalHistorialPagos"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Historial de pagos</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalHistorialPagos')">&times;</button> 
    </div> 
    <p>Ingresa tu ID de contrato para generar el historial.</p> 
    <label for="histId">ID Contrato</label> 
    <input type="text" id="histId" placeholder="Ej: R7467"> 
    <p id="histMsg" class="status"></p> 
    <div class="modal-actions"> 
      <button type="button" onclick="cerrarModal('modalHistorialPagos')">Cerrar</button> 
      <button type="button" onclick="generarHistorialPagos()">Generar</button> 
    </div> 
  </div> 
</div> 
 
<div class="modal-backdrop" id="modalHistorialPagosAfiliado"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Historial de pagos (Afiliado)</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalHistorialPagosAfiliado')">&times;</button> 
    </div> 
    <p id="historialAfiliadoTexto">Dato no disponible.</p> 
    <div class="modal-actions"> 
      <button type="button" onclick="cerrarModal('modalHistorialPagosAfiliado')">Cerrar</button> 
    </div> 
  </div> 
</div> 
 
<div class="modal-backdrop" id="modalVehiculosAfiliado"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Cantidad de vehículos afiliados</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalVehiculosAfiliado')">&times;</button> 
    </div> 
    <p id="modalVehiculosTexto">Número de vehículos: Dato no disponible.</p> 
  </div> 
</div> 
 
<div class="modal-backdrop" id="modalLiquidacionesAfiliado"> 
  <div class="modal"> 
    <div class="modal-header"> 
      <h3>Resumen de liquidaciones</h3> 
      <button class="modal-close" type="button" onclick="cerrarModal('modalLiquidacionesAfiliado')">&times;</button> 
    </div> 
    <p id="modalLiquidacionesTexto1">Número de liquidaciones: Dato no disponible.</p> 
    <p id="modalLiquidacionesTexto2">Total liquidado: Dato no disponible.</p> 
    <div class="modal-actions"> 
      <button type="button" onclick="cerrarModal('modalLiquidacionesAfiliado')">Cerrar</button> 
    </div> 
  </div> 
</div> 
 
<script> 
  const API_URL='https://script.google.com/macros/s/AKfycbxNiAZCMVvaagzFjYQgIsQkGEWJPui9baIHcO_-JjeJ6HvDYdDU5BdH8R6zzD3zDUw/exec'; 
  const WOMPI_PUBLIC_KEY='pub_prod_D1w0Ys7mW5OJOueJoMi1rA5aLYJvlN06'; 
  const WOMPI_INTEGRITY_KEY='prod_integrity_zNC4ZqryuKzC75Cp72boasFFTLgzmhKN'; 
  const WOMPI_REDIRECT_URL='https://portal.radizco.com/'; 
  const API_CALLBACK_URL = API_URL; 
 
  let tipoUsuarioActual=null; 
  let datosContratoActual=null; 
  let datosAfiliadoActual=null; 

  // ==========================
  //   LOGIN PRINCIPAL (Router)
  // ==========================
  const PORTAL_LOGISTICA_URL  = 'logistica.html';
  const PORTAL_INVERSIONES_URL = 'inversiones.html';
  const LS_USER_KEY = 'RADIZ_USUARIO_GUARDADO';

  document.addEventListener('DOMContentLoaded', function(){
    const userEl = document.getElementById('loginUser');
    const passEl = document.getElementById('loginPass');
    const btnEl  = document.getElementById('loginBtn');

    // Prefill usuario guardado
    try{
      const saved = localStorage.getItem(LS_USER_KEY);
      if(saved && userEl){ userEl.value = saved; }
    }catch(e){}

    function onEnter(e){
      if(e.key === 'Enter'){ loginPrincipal(); }
    }

    if(userEl){
      userEl.addEventListener('keydown', onEnter);
      userEl.addEventListener('blur', function(){
        const v = (userEl.value || '').toString().trim().toUpperCase();
        if(v){
          try{ localStorage.setItem(LS_USER_KEY, v); }catch(e){}
        }
      });
    }
    if(passEl){ passEl.addEventListener('keydown', onEnter); }
    if(btnEl){ btnEl.addEventListener('click', loginPrincipal); }
  });

  function setLoginMsg(text, ok){
    const msg = document.getElementById('loginMsg');
    if(!msg) return;
    msg.textContent = text || '';
    msg.className = 'status ' + (ok ? 'ok' : 'error');
  }

  async function loginPrincipal(){
    const userEl = document.getElementById('loginUser');
    const passEl = document.getElementById('loginPass');

    const id = (userEl && userEl.value ? userEl.value : '').toString().trim().toUpperCase();
    const password = (passEl && passEl.value ? passEl.value : '').toString();

    if(!id || !password){
      setLoginMsg('Debes ingresar usuario y contraseña.', false);
      return;
    }

    setLoginMsg('Validando...', true);

    try{
      const body = new URLSearchParams();
      body.append('accion','login_portal');
      body.append('id', id);
      body.append('password', password);

      const resp = await fetch(API_URL, { method:'POST', body });
      const data = await resp.json();

      if(!data || !data.ok){
        setLoginMsg((data && data.error) ? data.error : 'Error al iniciar sesión. Intenta de nuevo.', false);
        return;
      }

      // Guardar usuario para próximos ingresos (no se guarda la contraseña)
      try{ localStorage.setItem(LS_USER_KEY, id); }catch(e){}

      // Router por tipo
      const tipo = (data.tipo || '').toString().toUpperCase();

      if(id.charAt(0) === 'R' || tipo === 'RENTING'){
        window.location.href = PORTAL_LOGISTICA_URL + '?id=' + encodeURIComponent(id);
        return;
      }

      if(id.charAt(0) === 'A' || tipo === 'AFILIADO'){
        window.location.href = PORTAL_INVERSIONES_URL + '?id=' + encodeURIComponent(id);
        return;
      }

      setLoginMsg('Tipo de usuario no reconocido. Verifica tu usuario.', false);
    }catch(e){
      console.error(e);
      setLoginMsg('Error al iniciar sesión. Intenta de nuevo.', false);
    }
  }
 
  // Estado inicial del menú: mostrar menú inicial siempre 
  document.addEventListener('DOMContentLoaded', function(){ 
    const fabMenu=document.getElementById('fabMenu'); 
    const menuInicial=document.getElementById('menuInicial'); 
    const menuRenting=document.getElementById('menuRenting'); 
    const menuAfiliado=document.getElementById('menuAfiliado'); 
 
    if(fabMenu){ fabMenu.style.display='block'; } 
    if(menuInicial){ menuInicial.style.display='block'; } 
    if(menuRenting){ menuRenting.style.display='none'; } 
    if(menuAfiliado){ menuAfiliado.style.display='none'; } 
  }); 
 
  function toggleMenu(){ 
    const panel=document.getElementById('menuPanel'); 
    if(!panel) return; 
    panel.classList.toggle('open'); 
  } 
 
  function abrirModal(id){ 
    const el=document.getElementById(id); 
    if(!el) return; 
    el.style.display='flex'; 
  } 
  function cerrarModal(id){ 
    const el=document.getElementById(id); 
    if(!el) return; 
    el.style.display='none'; 
  } 
 
  function descargarApp(){ 
    abrirModal('modalDescargaApp'); 
  } 
 
  async function consultarContrato(){ 
    const idInput=document.getElementById('idContrato'); 
    const passInput=document.getElementById('password'); 
    const status=document.getElementById('status'); 
    const id=(idInput?.value||'').toString().trim().toUpperCase(); 
    const password=(passInput?.value||'').toString(); 
 
    if(!id || !password){ 
      status.className='status error'; 
      status.textContent='Debes ingresar ID y contraseña.'; 
      return; 
    } 
 
    status.className='status'; 
    status.textContent='Consultando...'; 
 
    try{ 
      const body=new URLSearchParams(); 
      body.append('accion','login_portal'); 
      body.append('id',id); 
      body.append('password',password); 
 
      const resp=await fetch(API_URL,{method:'POST',body}); 
      const data=await resp.json(); 
 
      if(!data.ok){ 
        status.className='status error'; 
        status.textContent=data.error||'No se pudo consultar.'; 
        return; 
      } 
 
      tipoUsuarioActual=(data.tipo||'').toString().toUpperCase(); 
 
      // Cambiar menú según tipo 
      const menuInicial=document.getElementById('menuInicial'); 
      const menuRenting=document.getElementById('menuRenting'); 
      const menuAfiliado=document.getElementById('menuAfiliado'); 
      if(menuInicial) menuInicial.style.display='none'; 
      if(tipoUsuarioActual==='RENTING'){ 
        if(menuRenting) menuRenting.style.display='block'; 
        if(menuAfiliado) menuAfiliado.style.display='none'; 
      }else if(tipoUsuarioActual==='AFILIADO'){ 
        if(menuAfiliado) menuAfiliado.style.display='block'; 
        if(menuRenting) menuRenting.style.display='none'; 
      } 
 
      status.className='status ok'; 
      status.textContent='Sesión iniciada.'; 
    }catch(e){ 
      console.error(e); 
      status.className='status error'; 
      status.textContent='Error al consultar. Intenta de nuevo.'; 
    } 
  } 
 
  async function consultarContratoDesdeModal(){ 
    const idInput=document.getElementById('modalIdContrato'); 
    const passInput=document.getElementById('modalPassword'); 
    const msg=document.getElementById('modalLoginMsg'); 
    const id=(idInput?.value||'').toString().trim().toUpperCase(); 
    const password=(passInput?.value||'').toString(); 
 
    if(!id || !password){ 
      msg.className='status error'; 
      msg.textContent='Debes ingresar ID y contraseña.'; 
      return; 
    } 
 
    msg.className='status'; 
    msg.textContent='Consultando...'; 
 
    try{ 
      const body=new URLSearchParams(); 
      body.append('accion','login_portal'); 
      body.append('id',id); 
      body.append('password',password); 
 
      const resp=await fetch(API_URL,{method:'POST',body}); 
      const data=await resp.json(); 
 
      if(!data.ok){ 
        msg.className='status error'; 
        msg.textContent=data.error||'No se pudo consultar.'; 
        return; 
      } 
 
      cerrarModal('modalConsultar'); 
      msg.textContent=''; 
      const mainId=document.getElementById('idContrato'); 
      const mainPass=document.getElementById('password'); 
      if(mainId) mainId.value=id; 
      if(mainPass) mainPass.value=password; 
      consultarContrato(); 
    }catch(e){ 
      console.error(e); 
      msg.className='status error'; 
      msg.textContent='Error al iniciar sesión. Intenta de nuevo.'; 
    } 
  } 
 
  async function loginInversiones(){ 
    const idInput=document.getElementById('invId'); 
    const passInput=document.getElementById('invPassword'); 
    const msg=document.getElementById('invLoginMsg'); 
 
    if(!idInput || !passInput || !msg) return; 
 
    const id=(idInput.value||'').toString().trim().toUpperCase(); 
    const password=(passInput.value||'').toString(); 
 
    if(!id || !password){ 
      msg.className='status error'; 
      msg.textContent='Debes ingresar usuario y contraseña.'; 
      return; 
    } 
 
    msg.className='status'; 
    msg.textContent='Validando...'; 
 
    try{ 
      const body=new URLSearchParams(); 
      body.append('accion','login_portal'); 
      body.append('id',id); 
      body.append('password',password); 
 
      const resp=await fetch(API_URL,{method:'POST',body}); 
      const data=await resp.json(); 
 
      if(!data.ok){ 
        msg.className='status error'; 
        msg.textContent=data.error||'No se pudo iniciar sesión.'; 
        return; 
      } 
 
      cerrarModal('modalInversiones'); 
      msg.textContent=''; 
    }catch(e){ 
      console.error(e); 
      msg.className='status error'; 
      msg.textContent='Error al iniciar sesión. Intenta de nuevo.'; 
    } 
  } 
 
  async function generarIntegritySignature(reference, amountInCents, currency){ 
    try{ 
      const body=new URLSearchParams(); 
      body.append('accion','integrity_signature'); 
      body.append('reference',reference); 
      body.append('amountInCents',String(amountInCents)); 
      body.append('currency',currency); 
 
      const resp=await fetch(API_CALLBACK_URL,{method:'POST',body}); 
      const data=await resp.json(); 
      if(data && data.ok && data.signature) return data.signature; 
      throw new Error(data.error || 'No signature'); 
    }catch(e){ 
      throw e; 
    } 
  } 
 
  async function pagarWompi(){ 
    const idContrato=(document.getElementById('idContrato')?.value||'').toString().trim().toUpperCase(); 
    const montoRaw=(document.getElementById('montoPago')?.value||'').toString(); 
    const statusPago=document.getElementById('statusPago'); 
 
    if(!idContrato){ 
      if(statusPago){ 
        statusPago.className='status error'; 
        statusPago.textContent='Debes ingresar tu ID de contrato primero.'; 
      } 
      return; 
    } 
 
    const valor=Number(montoRaw); 
    if(!valor || isNaN(valor) || valor<170000){ 
      if(statusPago){ 
        statusPago.className='status error'; 
        statusPago.textContent='El monto mínimo es 170.000 COP.'; 
      } 
      return; 
    } 
 
    if(typeof WidgetCheckout==='undefined'){ 
      alert('No se pudo cargar el checkout de Wompi. Por favor recarga la página.'); 
      return; 
    } 
 
    const amountInCents = valor*100; 
    const reference='PAGO_'+idContrato+'_'+Date.now(); 
    const currency='COP'; 
 
    try{ 
      const integritySignature=await generarIntegritySignature(reference,amountInCents,currency); 
 
      const checkout = new WidgetCheckout({ 
        currency: 'COP', 
        amountInCents: amountInCents, 
        reference: reference, 
        publicKey: WOMPI_PUBLIC_KEY, 
        redirectUrl: WOMPI_REDIRECT_URL, 
        signature:{ integrity: integritySignature }, 
      }); 
 
      checkout.open(function (result){ 
        // Resultado del checkout 
      }); 
    }catch(e){ 
      console.error(e); 
      if(statusPago){ 
        statusPago.className='status error'; 
        statusPago.textContent='Error al preparar el pago. Intenta de nuevo.'; 
      } 
    } 
  } 
 
  async function guardarKilometraje(){ 
    const km = (document.getElementById('kmNuevo')?.value||'').toString(); 
    const idContrato = (document.getElementById('idContrato')?.value||'').toString().trim().toUpperCase(); 
    const msg = document.getElementById('kmMsg'); 
    if(!idContrato || !km){ 
      if(msg){ msg.className='status error'; msg.textContent='Debes ingresar kilometraje e ID.'; } 
      return; 
    } 
    try{ 
      const body=new URLSearchParams(); 
      body.append('accion','actualizar_kilometraje'); 
      body.append('idContrato',idContrato); 
      body.append('kilometraje',km); 
      const resp=await fetch(API_URL,{method:'POST',body}); 
      const data=await resp.json(); 
      if(!data.ok){ 
        if(msg){ msg.className='status error'; msg.textContent=data.error||'Error al guardar.'; } 
        return; 
      } 
      if(msg){ msg.className='status ok'; msg.textContent='Kilometraje actualizado.'; } 
    }catch(e){ 
      console.error(e); 
      if(msg){ msg.className='status error'; msg.textContent='Error al guardar.'; } 
    } 
  } 
 
  async function enviarIncidente(){ 
    const txt=(document.getElementById('incidenteTexto')?.value||'').toString().trim(); 
    const idContrato=(document.getElementById('idContrato')?.value||'').toString().trim().toUpperCase(); 
    const msg=document.getElementById('incidenteMsg'); 
    if(!idContrato || !txt){ 
      if(msg){ msg.className='status error'; msg.textContent='Debes ingresar el incidente e ID.'; } 
      return; 
    } 
    try{ 
      const body=new URLSearchParams(); 
      body.append('accion','notificar_incidente'); 
      body.append('idContrato',idContrato); 
      body.append('detalle',txt); 
      const resp=await fetch(API_URL,{method:'POST',body}); 
      const data=await resp.json(); 
      if(!data.ok){ 
        if(msg){ msg.className='status error'; msg.textContent=data.error||'Error al enviar.'; } 
        return; 
      } 
      if(msg){ msg.className='status ok'; msg.textContent='Incidente enviado.'; } 
    }catch(e){ 
      console.error(e); 
      if(msg){ msg.className='status error'; msg.textContent='Error al enviar.'; } 
    } 
  } 
 
  async function generarHistorialPagos(){ 
    const id=(document.getElementById('histId')?.value||'').toString().trim().toUpperCase(); 
    const msg=document.getElementById('histMsg'); 
    if(!msg) return; 
    msg.className='status'; 
    msg.textContent='Generando historial...'; 
 
    if(!id){ 
      msg.style.color='#b91c1c'; 
      msg.textContent='Debes ingresar tu ID de contrato.'; 
      return; 
    } 
 
    try{ 
      const resp = await fetch(API_URL+'?accion=historial_pagos&id='+encodeURIComponent(id)); 
      const data = await resp.json(); 
 
      if(!data.ok){ 
        msg.style.color='#b91c1c'; 
        msg.textContent=data.error||'No se pudo generar el historial.'; 
        return; 
      } 
 
      const html = data.html || ''; 
      const w = window.open('','_blank'); 
      if(w){ 
        w.document.open(); 
        w.document.write(html); 
        w.document.close(); 
      } 
      msg.className='status ok'; 
      msg.textContent='Historial generado.'; 
    }catch(e){ 
      console.error(e); 
      msg.className='status error'; 
      msg.textContent='Error al generar.'; 
    } 
  } 
</script> 
</body> 
</html>
