<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Portal de Clientes RADIZ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Script oficial del Widget de Wompi -->
  <script src="https://checkout.wompi.co/widget.js"></script>

  <!-- Aqu칤 puedes conservar TU CSS original; este es solo ejemplo suave -->
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    .page {
      max-width: 1100px;
      margin: 32px auto;
      padding: 16px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .header-logo {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #fff;
      background: #1d4ed8;
    }

    .header-title {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .header-subtitle {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 24px;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 20px 24px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
    }

    .card-title {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .card-subtitle {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .field-group {
      margin-bottom: 12px;
    }

    .field-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: #6b7280;
      margin-bottom: 2px;
    }

    .field-value {
      font-size: 0.95rem;
      font-weight: 500;
      color: #111827;
    }

    .amount-big {
      font-size: 1.8rem;
      font-weight: 700;
      color: #0f172a;
    }

    .amount-big span {
      font-size: 0.9rem;
      font-weight: 500;
      color: #6b7280;
      margin-left: 4px;
    }

    .input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 0.95rem;
      outline: none;
      background: #f9fafb;
    }

    .input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
      background: #ffffff;
    }

    .btn-primary {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 1rem;
      font-weight: 600;
      color: #ffffff;
      background: linear-gradient(135deg, #1d4ed8, #2563eb);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.12s ease;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.38);
      margin-top: 12px;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(37, 99, 235, 0.45);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
    }

    .btn-primary-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 0.8rem;
    }

    .helper-text {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #6b7280;
    }

    @media (max-width: 800px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- CABECERA -->
    <header class="header">
      <div class="header-logo">R</div>
      <div>
        <div class="header-title">RADIZ Vehicular</div>
        <div class="header-subtitle">Portal de pagos 췅 clientes afiliados</div>
      </div>
    </header>

    <div class="layout">
      <!-- COLUMNA IZQUIERDA: RESUMEN (aqu칤 puedes poner tus propios datos desde Sheets) -->
      <section class="card">
        <div class="card-title">Resumen de tu servicio</div>
        <div class="card-subtitle">
          Aqu칤 puedes reemplazar este texto por los datos que traes desde Google Sheets.
        </div>

        <div class="field-group">
          <div class="field-label">Cliente</div>
          <div class="field-value" id="clienteNombre">Juan P칠rez</div>
        </div>

        <div class="field-group">
          <div class="field-label">Documento</div>
          <div class="field-value" id="clienteDocumento">1.111.111.111</div>
        </div>

        <div class="field-group">
          <div class="field-label">Servicio</div>
          <div class="field-value" id="servicioDescripcion">Renting motocicleta RADIZ</div>
        </div>

        <div class="field-group">
          <div class="field-label">Periodo</div>
          <div class="field-value" id="servicioPeriodo">01/12/2025 - 31/12/2025</div>
        </div>
      </section>

      <!-- COLUMNA DERECHA: PAGO PENDIENTE -->
      <section class="card">
        <div class="card-title">Pago pendiente</div>
        <div class="card-subtitle">
          Configura el valor y la referencia. Al hacer clic en el bot칩n se abrir치 el pago seguro con Wompi.
        </div>

        <div class="field-group">
          <div class="field-label">Valor pendiente</div>
          <div class="amount-big">
            $170.000 <span>COP</span>
          </div>
        </div>

        <!-- INPUT MONTO A PAGAR -->
        <div class="field-group">
          <label class="field-label" for="valorPagar">Valor a pagar (COP)</label>
          <input
            id="valorPagar"
            class="input"
            type="number"
            min="1"
            step="1"
            value="170000"
          />
        </div>

        <!-- INPUT REFERENCIA 칔NICA -->
        <div class="field-group">
          <label class="field-label" for="referenciaPago">Referencia 칰nica de pago</label>
          <input
            id="referenciaPago"
            class="input"
            type="text"
            value="RADIZ-DEC-2025-001"
          />
        </div>

        <!-- BOT칍N WOMPI -->
        <button id="pagarWompi" type="button" class="btn-primary">
          <span class="btn-primary-icon">游눱</span>
          <span>Pagar con Wompi</span>
        </button>

        <p class="helper-text">
          Al hacer clic abriremos el formulario oficial de Wompi para completar tu pago de forma segura.
        </p>
      </section>
    </div>
  </div>

  <!-- L칍GICA WIDGET WOMPI (ESTO ES LO IMPORTANTE) -->
  <script>
    // Obtiene el valor de un input buscando entre varios IDs posibles
    function getValueFromPossibleIds(ids) {
      for (var i = 0; i < ids.length; i++) {
        var el = document.getElementById(ids[i]);
        if (el) return el.value;
      }
      return '';
    }

    function parseAmountToCents(amountStr) {
      if (!amountStr) return NaN;
      // eliminar separadores de miles, espacios, etc.
      var clean = String(amountStr).replace(/[^\d]/g, '');
      var value = parseInt(clean, 10);
      if (isNaN(value) || value <= 0) return NaN;
      return value * 100; // COP -> centavos
    }

    function initWompiButton() {
      var button =
        document.getElementById('pagarWompi') ||
        document.getElementById('btnPagarWompi') ||
        document.getElementById('payButton');

      if (!button) {
        console.error('No se encontr칩 el bot칩n de pago (pagarWompi / btnPagarWompi / payButton).');
        return;
      }

      button.addEventListener('click', function () {
        // 1) Tomar monto y referencia del formulario (soporta varios IDs por si ya tienes otros)
        var amountStr = getValueFromPossibleIds(['paymentAmount', 'valorPagar', 'amountInput']);
        var reference = getValueFromPossibleIds(['paymentReference', 'referenciaPago', 'referenceInput']).trim();

        var amountInCents = parseAmountToCents(amountStr);

        if (!reference) {
          alert('Por favor ingresa una referencia de pago.');
          return;
        }

        if (!amountInCents || isNaN(amountInCents)) {
          alert('Por favor ingresa un valor a pagar v치lido.');
          return;
        }

        // 2) Llamar al servidor para que genere la firma de integridad
        button.disabled = true;
        button.style.opacity = '0.8';

        google.script.run
          .withSuccessHandler(function (config) {
            button.disabled = false;
            button.style.opacity = '1';

            try {
              // 3) Crear instancia del WidgetCheckout con la firma generada en el servidor
              var checkout = new WidgetCheckout({
                currency: config.currency,
                amountInCents: config.amountInCents,
                reference: config.reference,
                publicKey: config.publicKey,
                signature: { integrity: config.integrity }
              });

              // 4) Abrir el widget
              checkout.open(function (result) {
                // Aqu칤 podr칤as hacer algo con el resultado si quieres.
                console.log('Resultado transacci칩n Wompi:', result);
              });
            } catch (e) {
              console.error('Error al abrir WidgetCheckout:', e);
              alert('Ocurri칩 un error al abrir la pasarela de pago.');
            }
          })
          .withFailureHandler(function (err) {
            button.disabled = false;
            button.style.opacity = '1';
            console.error('Error generando firma en Apps Script:', err);
            alert('No se pudo generar la firma de pago. Intenta nuevamente.');
          })
          .getWompiConfig(reference, amountInCents);
      });
    }

    // Inicializar cuando el HTML est치 listo
    document.addEventListener('DOMContentLoaded', initWompiButton);
  </script>
</body>
</html>
