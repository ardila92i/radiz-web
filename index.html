<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PORTAL CLIENTES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://checkout.wompi.co/widget.js"></script>
  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f3f4f6;
      color:#111827;
    }
    .page{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:32px 16px;
    }
    .container{
      position:relative;
      width:100%;
      max-width:960px;
      background:#fff;
      border-radius:20px;
      box-shadow:0 15px 40px rgba(15,23,42,.12);
      padding:28px 32px 32px;
      overflow:hidden;
    }
    .logo-top{
      text-align:left;
      margin-bottom:12px;
    }
    .logo-top img{
      max-width:220px;
      max-height:80px;
      object-fit:contain;
    }
    h1{
      margin:0 0 4px;
      font-size:1.8rem;
      letter-spacing:.03em;
    }
    .subtitle{
      color:#4b5563;
      font-size:.95rem;
      margin-bottom:18px;
    }
    .form-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:16px;
      align-items:flex-end;
    }
    label{
      font-size:.9rem;
      font-weight:600;
      color:#374151;
    }
    input[type="text"],
    input[type="number"],
    input[type="email"]{
      width:100%;
      padding:10px 12px;
      border-radius:9px;
      border:1px solid #d1d5db;
      font-size:.95rem;
      outline:none;
      transition:border-color .15s,box-shadow .15s;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="email"]:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.18);
    }
    button{
      padding:11px 22px;
      border-radius:999px;
      border:none;
      font-size:.95rem;
      font-weight:600;
      cursor:pointer;
      background:#2563eb;
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      box-shadow:0 10px 25px rgba(37,99,235,.4);
      transition:transform .1s,box-shadow .1s,background .1s;
      white-space:nowrap;
    }
    button:hover{
      transform:translateY(-1px);
      background:#1d4ed8;
      box-shadow:0 14px 30px rgba(37,99,235,.5);
    }
    button:disabled{
      opacity:.65;
      cursor:default;
      box-shadow:none;
      transform:none;
    }
    .status{
      font-size:.9rem;
      margin-bottom:10px;
      min-height:1.2em;
    }
    .status.error{color:#b91c1c}
    .status.ok{color:#065f46}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:16px;
      margin-top:8px;
      margin-bottom:24px;
    }
    .card{
      border-radius:14px;
      border:1px solid #e5e7eb;
      padding:14px 16px 16px;
      background:#f9fafb;
      font-size:.9rem;
    }
    .card h2{
      margin:0 0 8px;
      font-size:1.05rem;
      font-weight:700;
      color:#111827;
    }
    .card p{
      margin:3px 0;
      color:#111827;
      font-size:.9rem;
    }
    .card p strong{
      font-weight:600;
    }
    ul{padding-left:18px;margin:6px 0}
    li{margin-bottom:4px}
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:600;
      text-transform:uppercase;
    }
    .badge-activo{background:#dcfce7;color:#166534}
    .badge-inactivo{background:#fee2e2;color:#b91c1c}
    footer{
      margin-top:24px;
      font-size:.75rem;
      color:#9ca3af;
      text-align:center;
    }

    /* Pago Wompi */
    #seccionPago h2{
      font-size:1rem;
      margin:0 0 4px;
      color:#111827;
    }
    #seccionPago p{
      font-size:.9rem;
      color:#4b5563;
      margin:4px 0 10px;
    }
    #seccionPago .row-pago{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    #montoPago{
      width:220px;
    }
    #pagoError{
      color:#dc2626;
      margin-top:6px;
      font-size:.85rem;
      display:none;
    }

    /* FAB menú */
    .fab-menu{
      position:absolute;
      top:24px;
      right:26px;
      z-index:20;
      display:none;
    }
    .fab-btn{
      width:54px;
      height:54px;
      border-radius:999px;
      background:#2563eb;
      border:none;
      box-shadow:0 15px 35px rgba(37,99,235,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:transform .12s,box-shadow .12s,background .12s;
    }
    .fab-btn:hover{
      transform:translateY(-1px);
      background:#1d4ed8;
      box-shadow:0 18px 40px rgba(37,99,235,.65);
    }
    .fab-btn span{
      display:block;
      width:22px;
      height:2px;
      border-radius:999px;
      background:#fff;
      position:relative;
    }
    .fab-btn span::before,
    .fab-btn span::after{
      content:"";
      position:absolute;
      left:0;
      width:22px;
      height:2px;
      border-radius:999px;
      background:#fff;
    }
    .fab-btn span::before{top:-6px}
    .fab-btn span::after{top:6px}

    /* Menú flotante */
    .menu-panel{
      position:absolute;
      top:90px;
      right:32px;
      background:#ffffff;
      border-radius:14px;
      box-shadow:0 12px 30px rgba(15,23,42,.22);
      padding:8px 0;
      width:220px;
      display:none;
      z-index:25;
    }
    .menu-title{
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-weight:600;
      color:#6b7280;
      padding:6px 14px 4px;
    }
    .menu-item{
      padding:7px 14px;
      font-size:.9rem;
      cursor:pointer;
      color:#111827;
    }
    .menu-item:hover{
      background:#eff6ff;
      color:#1d4ed8;
    }

    /* Modales */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal{
      background:#fff;
      border-radius:18px;
      max-width:480px;
      width:90%;
      padding:18px 20px 18px;
      box-shadow:0 20px 45px rgba(15,23,42,.4);
      font-size:.9rem;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .modal-header h3{
      margin:0;
      font-size:1.05rem;
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size:1.3rem;
      cursor:pointer;
      color:#6b7280;
    }
    .modal p{margin:4px 0;color:#111827}
    .modal label{display:block;margin-top:8px;margin-bottom:3px}
    .modal-actions{
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    @media(max-width:640px){
      .container{
        padding:22px 18px 24px;
        border-radius:16px;
      }
      .fab-menu{
        top:18px;
        right:18px;
      }
      .menu-panel{
        top:78px;
        right:20px;
      }
      .logo-top{
        text-align:center;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="container">
    <div class="logo-top">
      <img src="logoradiz.png" alt="Logo RADIZ" id="logo-radiz">
    </div>

    <!-- Botón menú flotante -->
    <div class="fab-menu" id="fabMenu">
      <button class="fab-btn" type="button" onclick="toggleMenu()">
        <span></span>
      </button>
      <div class="menu-panel" id="menuPanel">
        <div class="menu-title" id="menuTitle">Opciones</div>
        <!-- Para renting -->
        <div id="menuRenting" style="display:none;">
          <div class="menu-item" onclick="abrirModal('modalBeneficios')">Beneficios</div>
          <div class="menu-item" onclick="abrirModal('modalHistorialPagos')">Historial de pagos</div>
          <div class="menu-item" onclick="abrirModal('modalTaller')">Taller asignado</div>
        </div>
        <!-- Para afiliados -->
        <div id="menuAfiliado" style="display:none;">
          <div class="menu-item" onclick="abrirModal('modalFechaPagosAfiliado')">Fecha de pagos</div>
          <div class="menu-item" onclick="abrirModal('modalVehiculosAfiliado')">Cantidad de vehículos</div>
          <div class="menu-item" onclick="abrirModal('modalLiquidacionesAfiliado')">Liquidaciones</div>
        </div>
      </div>
    </div>

    <h1>PORTAL CLIENTES</h1>
    <p class="subtitle">
      Ingresa el <strong>ID del contrato</strong> para consultar el estado, pagos y mantenimientos.
    </p>

    <div class="form-row">
      <div style="flex:1;min-width:220px;">
        <label for="idContrato">ID CONTRATO</label><br>
        <input type="text" id="idContrato" placeholder="Ejemplo: R-0001">
      </div>
      <div>
        <button id="btnConsultar" onclick="consultar()">Consultar</button>
      </div>
    </div>

    <div id="status" class="status"></div>

    <div class="grid" id="resultados" style="display:none;">
      <div class="card" id="cardContrato"></div>
      <div class="card" id="cardPagos"></div>
      <div class="card" id="cardMantenimientos"></div>
    </div>

    <div id="seccionPago" style="margin-top:8px;">
      <h2>Realizar pago</h2>
      <p>Ingresa el monto a pagar y completa el proceso con Wompi.</p>
      <label for="montoPago">Monto a pagar (COP)</label>
      <div class="row-pago">
        <input id="montoPago" type="number" min="100000" step="1000" placeholder="Ej: 170000">
        <button type="button" onclick="crearPagoWompi()">Pagar con Wompi</button>
      </div>
      <p id="pagoError">Ingresa un monto válido (mínimo 100.000).</p>
    </div>

    <footer>Versión interna • RADIZ Suministro Vehicular</footer>
  </div>
</div>

<!-- MODALES RENTING -->
<div class="modal-backdrop" id="modalBeneficios">
  <div class="modal">
    <div class="modal-header">
      <h3>Beneficios del plan</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalBeneficios')">&times;</button>
    </div>
    <p id="modalBeneficiosTexto">Información no disponible.</p>
  </div>
</div>

<div class="modal-backdrop" id="modalHistorialPagos">
  <div class="modal">
    <div class="modal-header">
      <h3>Solicitar historial de pagos</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalHistorialPagos')">&times;</button>
    </div>
    <p style="margin-bottom:6px;">Ingresa tu correo electrónico y el ID de contrato para enviarte el historial en PDF.</p>
    <label for="correoHistorial">Correo electrónico</label>
    <input type="email" id="correoHistorial" placeholder="ejemplo@correo.com">
    <label for="idHistorial">ID de contrato</label>
    <input type="text" id="idHistorial" placeholder="Ej: R-0001">
    <p id="historialMsg" style="font-size:.85rem;margin-top:6px;color:#6b7280;"></p>
    <div class="modal-actions">
      <button type="button" onclick="cerrarModal('modalHistorialPagos')">Cerrar</button>
      <button type="button" onclick="enviarSolicitudHistorial()">Enviar solicitud</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalTaller">
  <div class="modal">
    <div class="modal-header">
      <h3>Taller asignado</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalTaller')">&times;</button>
    </div>
    <p id="modalTallerTexto">Información no disponible.</p>
  </div>
</div>

<!-- MODALES AFILIADOS -->
<div class="modal-backdrop" id="modalFechaPagosAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Fecha de pagos al afiliado</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalFechaPagosAfiliado')">&times;</button>
    </div>
    <p id="modalFechaPagosTexto">Dato no disponible.</p>
  </div>
</div>

<div class="modal-backdrop" id="modalVehiculosAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Cantidad de vehículos afiliados</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalVehiculosAfiliado')">&times;</button>
    </div>
    <p id="modalVehiculosTexto">Número de vehículos: Dato no disponible.</p>
  </div>
</div>

<div class="modal-backdrop" id="modalLiquidacionesAfiliado">
  <div class="modal">
    <div class="modal-header">
      <h3>Resumen de liquidaciones</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalLiquidacionesAfiliado')">&times;</button>
    </div>
    <p id="modalLiquidacionesTexto1">Número de liquidaciones: Dato no disponible.</p>
    <p id="modalLiquidacionesTexto2">Valor total liquidado: Dato no disponible.</p>
  </div>
</div>

<script>
  const API_URL='https://script.google.com/macros/s/AKfycbxNiAZCMVvaagzFjYQgIsQkGEWJPui9baIHcO_-JjeJ6HvDYdDU5BdH8R6zzD3zDUw/exec';
  const WOMPI_PUBLIC_KEY='pub_test_3dus3DoqOnuXmuGDbXVVVZEbhUNsHVfI';
  const WOMPI_REDIRECT_URL='https://portal.radizco.com/';
  const API_CALLBACK_URL = API_URL;

  let tipoUsuarioActual=null;
  let datosContratoActual=null;
  let datosAfiliadoActual=null;
  let resumenAfiliadoVehiculos=0;
  let resumenAfiliadoMantenimientos=0;

  function toggleMenu(){
    const panel=document.getElementById('menuPanel');
    panel.style.display=panel.style.display==='block'?'none':'block';
  }
  function abrirModal(id){
    document.getElementById(id).style.display='flex';
    document.getElementById('menuPanel').style.display='none';
  }
  function cerrarModal(id){
    document.getElementById(id).style.display='none';
  }

  async function consultar(){
    const id=document.getElementById('idContrato').value.trim();
    const status=document.getElementById('status');
    const btn=document.getElementById('btnConsultar');
    const resultados=document.getElementById('resultados');
    const cardContrato=document.getElementById('cardContrato');
    const cardPagos=document.getElementById('cardPagos');
    const cardMantenimientos=document.getElementById('cardMantenimientos');
    const fabMenu=document.getElementById('fabMenu');

    status.className='status';
    status.textContent='';
    resultados.style.display='none';
    fabMenu.style.display='none';
    document.getElementById('menuPanel').style.display='none';

    if(!id){
      status.classList.add('error');
      status.textContent='Por favor ingresa un ID de contrato.';
      return;
    }

    btn.disabled=true;
    status.textContent='Consultando información...';

    try{
      const resp=await fetch(API_URL+'?id='+encodeURIComponent(id));
      const data=await resp.json();

      if(!data.ok){
        status.className='status error';
        status.textContent=data.error||'No se encontró información para ese contrato.';
        btn.disabled=false;
        return;
      }

      const c=data.contrato||{};
      datosContratoActual=c;

      const tipo=(c['TIPO USUARIO']||'').toString().toUpperCase();
      tipoUsuarioActual=tipo;

      const pagos=data.pagos||[];
      const rawM=data.mantenimientos??data.mantenimiento??data.mtos??data.manten??[];
      const mts=Array.isArray(rawM)?rawM:(rawM?[rawM]:[]);
      const beneficiosTexto=c['BENEFICIOS']||'Información no disponible';

      cardContrato.innerHTML='';
      cardPagos.innerHTML='';
      cardMantenimientos.innerHTML='';

      if(tipo.includes('AFILIADO')){
        const af=data.afiliado||{};
        datosAfiliadoActual=af;

        const nombreAf = af['NOMBRE'] || c['ID CLIENTE'] || 'Dato no disponible';
        const documentoAf = af['NO DOCUMENTO'] || 'Dato no disponible';

        let numLiqTexto='Dato no disponible';
        if(af['NO LIQUIDACIONES']!==undefined && af['NO LIQUIDACIONES']!==''){
          numLiqTexto=af['NO LIQUIDACIONES'];
        }

        let valorLiqTexto='Dato no disponible';
        if(af['VALOR LIQUIDADO']!==undefined && af['VALOR LIQUIDADO']!==''){
          const bruto=af['VALOR LIQUIDADO'];
          if(typeof bruto==='number'){
            valorLiqTexto=formatearNumero(bruto);
          }else{
            valorLiqTexto=String(bruto);
          }
        }

        cardContrato.innerHTML=
          '<h2>Afiliado</h2>'+
          '<p><strong>ID contrato:</strong> '+(c['ID CONTRATO']||id)+'</p>'+
          '<p><strong>Nombre:</strong> '+nombreAf+'</p>'+
          '<p><strong>Documento:</strong> '+documentoAf+'</p>'+
          '<p><strong>No. liquidaciones:</strong> '+numLiqTexto+'</p>'+
          '<p><strong>Valor liquidado:</strong> '+valorLiqTexto+'</p>';

        const pagoRelacionado=pagos.find(p=>String(p['ID CONTRATO']).trim()===id);
        const diasCorte=pagoRelacionado?(pagoRelacionado['DÍAS DE CORTE']||pagoRelacionado['DIAS DE CORTE']||'Dato no disponible'):'Dato no disponible';

        cardPagos.innerHTML=
          '<h2>Pagos</h2>'+
          '<p><strong>Días de corte:</strong> '+diasCorte+'</p>'+
          '<p><strong>Inicio contrato:</strong> '+formatearFecha(c['INICIO'])+'</p>';

        const vehiculos=data.vehiculosContrato||[];
        const numVehiculos=Array.isArray(vehiculos)?vehiculos.length:0;
        resumenAfiliadoVehiculos=numVehiculos;

        const mtsAfiliado=mts.filter(m=>String(m['ID CONTRATO']||'').trim()===id);
        const numMts=mtsAfiliado.length;
        resumenAfiliadoMantenimientos=numMts;

        cardMantenimientos.innerHTML=
          '<h2>Vehículos y mantenimientos</h2>'+
          '<p><strong>Cantidad de vehículos afiliados:</strong> '+(numVehiculos||'0')+'</p>'+
          '<p><strong>Mantenimientos registrados:</strong> '+(numMts||'0')+'</p>';

        document.getElementById('modalFechaPagosTexto').textContent=
          'Días de corte de pagos: '+diasCorte;
        document.getElementById('modalVehiculosTexto').textContent=
          'Número de vehículos: '+(numVehiculos||'0');
        document.getElementById('modalLiquidacionesTexto1').textContent=
          'Número de liquidaciones: '+numLiqTexto;
        document.getElementById('modalLiquidacionesTexto2').textContent=
          'Valor total liquidado: '+valorLiqTexto;

        document.getElementById('menuRenting').style.display='none';
        document.getElementById('menuAfiliado').style.display='block';
        fabMenu.style.display='block';

      }else{
        datosAfiliadoActual=null;

        const estado=(c['ESTADO']||'').toString().toUpperCase();

        cardContrato.innerHTML=
          '<h2>Contrato</h2>'+
          '<p><strong>ID:</strong> '+(c['ID CONTRATO']||'')+'</p>'+
          '<p><strong>Tipo usuario:</strong> '+(c['TIPO USUARIO']||'')+'</p>'+
          '<p><strong>Vehículo:</strong> '+(c['ID VEHÍCULO']||'')+'</p>'+
          '<p><strong>Inicio:</strong> '+formatearFecha(c['INICIO'])+'</p>'+
          '<p><strong>Fin:</strong> '+formatearFecha(c['FIN'])+'</p>'+
          '<p><strong>Tarifa semanal:</strong> '+formatearNumero(c['TARIFA SEMANAL'])+'</p>'+
          '<p><strong>Beneficios:</strong> '+beneficiosTexto+'</p>'+
          '<p><span class="badge '+(estado==='ACTIVO'?'badge-activo':'badge-inactivo')+'">'+(estado||'SIN ESTADO')+'</span></p>';

        if(pagos.length===0){
          cardPagos.innerHTML='<h2>Pagos</h2><p>No hay pagos registrados para este contrato.</p>';
        }else{
          const items=pagos.map(p=>
            '<li>'+
            '<strong>ID pago:</strong> '+(p['ID PAGO']||'')+'<br>'+
            '<strong>ID contrato:</strong> '+(p['ID CONTRATO']||'')+'<br>'+
            '<strong>Días de corte:</strong> '+(p['DÍAS DE CORTE']||p['DIAS DE CORTE']||'')+'<br>'+
            '<strong>Gasto mantenimientos:</strong> '+formatearNumero(p['GASTO MANTENIMIENTOS'])+'<br>'+
            '<strong>Tarifas completadas:</strong> '+(p['TARIFAS COMPLETADAS']||'')+'<br>'+
            '<strong>Tarifas vencidas:</strong> '+(p['TARIFAS VENCIDAS']||'')+'<br>'+
            '<strong>Referencia:</strong> '+(p['REFERENCIA']||'')+
            '</li>'
          ).join('');
          cardPagos.innerHTML='<h2>Pagos</h2><ul>'+items+'</ul>';
        }

        if(mts.length===0){
          cardMantenimientos.innerHTML='<h2>Mantenimientos</h2><p>No hay mantenimientos registrados para este contrato.</p>';
        }else{
          const totalM=mts.reduce((s,m)=>s+(Number(m['VALOR MTOS'])||0),0);
          const itemsM=mts.map(m=>
            '<li>'+
            '<strong>ID vehículo:</strong> '+(m['ID VEHÍCULO']||'')+'<br>'+
            '<strong>Último mantenimiento:</strong> '+formatearFecha(m['ÚLTIMO MANTENIMIENTO']||m['ULTIMO MANTENIMIENTO']||m['FECHA ULT. MANTENIMIENTO'])+'<br>'+
            '<strong>Tipo:</strong> '+(m['TIPO']||m['TIPO ULT. MANTENIMIENTO']||'')+'<br>'+
            '<strong>Realizados:</strong> '+(m['REALIZADOS']||m['MTOS REALIZADOS']||'')+'<br>'+
            '<strong>Valor general:</strong> '+formatearNumero(m['VALOR GENERAL']||m['VALOR MTOS'])+'<br>'+
            '<strong>Taller asignado:</strong> '+(m['TALLER ASIGNADO']||'')+
            '</li>'
          ).join('');
          cardMantenimientos.innerHTML=
            '<h2>Mantenimientos</h2>'+
            '<p><strong>Total mantenimientos:</strong> '+formatearNumero(totalM)+'</p>'+
            '<ul>'+itemsM+'</ul>';
        }

        document.getElementById('modalBeneficiosTexto').textContent=beneficiosTexto||'Información no disponible.';
        const tallerEjemplo='Taller asignado: '+(mts[0]?.['TALLER ASIGNADO']||'Información no disponible.');
        document.getElementById('modalTallerTexto').textContent=tallerEjemplo;

        document.getElementById('menuRenting').style.display='block';
        document.getElementById('menuAfiliado').style.display='none';
        fabMenu.style.display='block';
      }

      resultados.style.display='grid';
      status.className='status ok';
      status.textContent='Información cargada correctamente.';
    }catch(e){
      console.error(e);
      status.className='status error';
      status.textContent='Error al consultar la información. Intenta de nuevo.';
    }finally{
      btn.disabled=false;
    }
  }

  function formatearNumero(n){
    const num=Number(n);
    if(isNaN(num))return n||'';
    return num.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
  }

  function formatearFecha(v){
    if(!v)return'';
    const d=new Date(v);
    if(isNaN(d.getTime()))return v;
    return d.toLocaleDateString('es-CO');
  }

  // -------- Wompi con firma de integridad ----------
  async function crearPagoWompi(){
    const montoInput=document.getElementById('montoPago');
    const errorLabel=document.getElementById('pagoError');
    const valor=parseInt(montoInput.value,10);

    errorLabel.style.display='none';
    if(!valor||valor<100000){
      errorLabel.style.display='block';
      return;
    }

    const idContrato=(document.getElementById('idContrato').value||'').trim() || 'SIN_CONTRATO';

    try{
      // Pedimos al backend que genere la firma
      const formData = new URLSearchParams();
      formData.append('accion','generar_firma');
      formData.append('idContrato',idContrato);
      formData.append('monto',String(valor));

      const resp = await fetch(API_URL,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:formData.toString()
      });
      const data = await resp.json();

      if(!data.ok){
        console.error('Error al generar firma',data);
        alert(data.error || 'No se pudo generar la firma de integridad.');
        return;
      }

      const { reference, amountInCents, currency, integritySignature } = data;

      if(typeof WidgetCheckout==='undefined'){
        alert('No se pudo cargar el checkout de Wompi. Por favor recarga la página.');
        return;
      }

      const checkout=new WidgetCheckout({
        currency:currency,
        amountInCents:amountInCents,
        reference:reference,
        publicKey:WOMPI_PUBLIC_KEY,
        signature:{ integrity: integritySignature },
        redirectUrl:WOMPI_REDIRECT_URL
      });

      checkout.open(function(result){
        const transaction=result.transaction;
        console.log('Transacción Wompi:', transaction && transaction.id, transaction && transaction.status);
      });

    }catch(err){
      console.error(err);
      alert('Ocurrió un error al iniciar el pago. Intenta nuevamente.');
    }
  }

  async function enviarSolicitudHistorial(){
    const correo=document.getElementById('correoHistorial').value.trim();
    const idHist=document.getElementById('idHistorial').value.trim();
    const msg=document.getElementById('historialMsg');

    msg.style.color='#6b7280';
    msg.textContent='Enviando solicitud...';

    if(!correo||!idHist){
      msg.style.color='#b91c1c';
      msg.textContent='Debes ingresar el correo y el ID de contrato.';
      return;
    }

    try{
      const formData=new URLSearchParams();
      formData.append('accion','solicitar_historial');
      formData.append('correo',correo);
      formData.append('idContrato',idHist);

      const resp=await fetch(API_CALLBACK_URL,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:formData.toString()
      });
      const data=await resp.json();
      if(data.ok){
        msg.style.color='#065f46';
        msg.textContent='Solicitud enviada correctamente. Revisaremos y te enviaremos el historial al correo.';
      }else{
        msg.style.color='#b91c1c';
        msg.textContent=data.error||'Ocurrió un problema al enviar la solicitud.';
      }
    }catch(e){
      console.error(e);
      msg.style.color='#b91c1c';
      msg.textContent='Error al enviar la solicitud. Intenta de nuevo.';
    }
  }
</script>
</body>
</html>
