<!doctype html><html lang="es"><head>
<meta charset="UTF-8"><title>Portal Logístico RADIZ</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#0f172a"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes">
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
<link rel="apple-touch-icon" href="/icon-512.png">
<script src="https://checkout.wompi.co/widget.js" async></script>
<style>
*{box-sizing:border-box}
:root{--bg:#0b1220;--card:rgba(255,255,255,.04);--b:#1f2937;--t:#e5e7eb;--m:#9ca3af;--a:#2563eb;--a2:#1d4ed8;--ok:#22c55e;--bad:#ef4444;--w:#f59e0b;--r:18px}
html,body{height:100%;width:100%;overflow:hidden;overscroll-behavior:none;position:fixed;inset:0;touch-action:none}
body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;color:var(--t);background:linear-gradient(180deg,#0b1220 0%,#070b14 100%)}
a{color:inherit}
#app{height:100dvh;display:flex;flex-direction:column}
.top{padding:14px 16px 10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.brand{display:flex;align-items:center;gap:10px;min-width:0}
.logo{width:34px;height:34px;border-radius:10px;background:#0b1220;border:1px solid var(--b);display:grid;place-items:center;overflow:hidden}
.logo img{width:100%;height:100%;object-fit:cover}
.tt{line-height:1.05;min-width:0}
.tt b{display:block;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tt span{display:block;font-size:12px;color:var(--m);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pill{display:flex;gap:8px;align-items:center}
.badge{font-size:12px;color:var(--m);border:1px solid var(--b);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.03)}
.btn{border:0;border-radius:14px;padding:10px 12px;font-weight:800;color:#fff;background:linear-gradient(180deg,var(--a) 0%,var(--a2) 100%);cursor:pointer}
.btn:active{transform:translateY(1px)}
.btn2{background:rgba(255,255,255,.06);border:1px solid var(--b);color:var(--t)}
.main{flex:1;min-height:0;padding:0 16px 12px;display:flex;flex-direction:column;gap:12px}
.view{display:none;flex:1;min-height:0}
.view.on{display:flex;flex-direction:column;gap:12px;min-height:0}
.card{background:var(--card);border:1px solid var(--b);border-radius:var(--r);padding:14px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.kpi{display:flex;flex-direction:column;gap:4px}
.kpi small{color:var(--m);font-size:12px}
.kpi b{font-size:18px}
.banner{border-radius:var(--r);overflow:hidden;border:1px solid var(--b);background:rgba(255,255,255,.03)}
.banner img{width:100%;height:170px;object-fit:cover;display:block}
.list{display:flex;flex-direction:column;gap:10px}
.item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border-radius:14px;background:rgba(255,255,255,.03);border:1px solid var(--b)}
.item .l{min-width:0}
.item .l b{display:block;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item .l span{display:block;font-size:12px;color:var(--m);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item .r{display:flex;align-items:center;gap:8px}
.chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--b);background:rgba(255,255,255,.03);color:var(--m);white-space:nowrap}
.chip.ok{color:#bdf7c9;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
.chip.bad{color:#fecaca;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
.chip.w{color:#fde68a;border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12)}
.sheet{position:fixed;left:0;right:0;bottom:0;z-index:30;padding:10px 10px 14px;background:linear-gradient(180deg,rgba(7,11,20,0) 0%,rgba(7,11,20,.55) 18%,rgba(7,11,20,.92) 55%,rgba(7,11,20,.98) 100%)}
.nav{background:rgba(255,255,255,.05);border:1px solid var(--b);border-radius:22px;padding:10px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.nbtn{border:1px solid transparent;border-radius:16px;padding:10px 8px;background:transparent;color:var(--m);font-weight:900;font-size:12px;cursor:pointer}
.nbtn.on{color:var(--t);background:rgba(37,99,235,.16);border-color:rgba(37,99,235,.35)}
.modal{position:fixed;inset:0;z-index:60;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);padding:14px}
.modal.on{display:flex}
.mbox{width:min(980px,100%);height:min(720px,100%);background:#050814;border:1px solid var(--b);border-radius:22px;overflow:hidden;display:flex;flex-direction:column}
.mhead{padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between;border-bottom:1px solid var(--b);background:rgba(255,255,255,.03)}
.mhead b{font-size:13px}
.mbody{flex:1;min-height:0}
iframe{border:0;width:100%;height:100%}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:92px;z-index:70;max-width:92vw;background:#050814;border:1px solid var(--b);border-radius:999px;padding:10px 14px;font-size:13px;color:var(--t);display:none;gap:10px;align-items:center}
.toast.on{display:flex}
.dot{width:8px;height:8px;border-radius:50%}
.dot.ok{background:var(--ok)}.dot.bad{background:var(--bad)}.dot.w{background:var(--w)}
.loginWrap{height:100dvh;display:flex;flex-direction:column;justify-content:center;gap:12px;padding:18px}
.inp{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--b);background:rgba(255,255,255,.04);color:var(--t);outline:none;font-weight:900}
.row{display:flex;gap:10px}
.row>*{flex:1}
small.hint{color:var(--m);display:block;margin-top:-6px}
.brands{display:flex;gap:10px;align-items:center;justify-content:space-between}
.brands img{height:26px;opacity:.95;filter:saturate(1.05);object-fit:contain}
</style></head><body>
<div id="app">
  <div id="login" class="loginWrap">
    <div class="brand">
      <div class="logo"><img src="/logoradiz.png" alt=""></div>
      <div class="tt"><b>Portal Logístico</b><span>Acceso a turnos, pagos y mantenimientos</span></div>
    </div>
    <div class="card">
      <div class="row">
        <input id="id" class="inp" placeholder="ID (Ej: R4523)" autocomplete="username">
        <button id="btnGo" class="btn">Entrar</button>
      </div>
      <small class="hint">Pantalla fija (sin scroll). Si entras desde el portal principal, el ID llega automático.</small>
    </div>
    <div class="card">
      <div class="brands">
        <img src="coordinadora.png" alt="Coordinadora">
        <img src="logoscuz-verde.png" alt="" style="display:none">
        <img src="logoscruz-verde.png" alt="Cruz Verde">
        <img src="servientrega.png" alt="Servientrega">
        <img src="inter-rapidisimo.png" alt="Inter Rapidísimo">
      </div>
    </div>
  </div>

  <div id="dash" style="display:none;height:100dvh;flex-direction:column">
    <div class="top">
      <div class="brand">
        <div class="logo"><img src="/logoradiz.png" alt=""></div>
        <div class="tt"><b id="tCliente">RADIZ</b><span id="tSub">Logística</span></div>
      </div>
      <div class="pill">
        <div class="badge" id="tContrato">—</div>
        <button class="btn btn2" id="btnSalir">Salir</button>
      </div>
    </div>

    <div class="main">
      <div id="vHome" class="view on">
        <div class="banner"><img src="banner-turnos.png" alt=""></div>
        <div class="card">
          <div class="grid">
            <div class="kpi"><small>Próximo pago</small><b id="kProx">—</b></div>
            <div class="kpi"><small>Estado</small><b id="kEstado">—</b></div>
            <div class="kpi"><small>Pagos (últimos)</small><b id="kPagos">—</b></div>
            <div class="kpi"><small>Mantenimientos</small><b id="kMant">—</b></div>
          </div>
          <div style="display:flex;gap:10px;margin-top:12px">
            <button class="btn" id="btnPagar" style="flex:1">Pagar</button>
            <button class="btn btn2" id="btnQR">QR</button>
          </div>
        </div>
        <div class="card">
          <div class="list">
            <div class="item" id="goTurnos"><div class="l"><b>Turnos publicados</b><span>Ver oportunidades disponibles</span></div><div class="r"><span class="chip">Abrir</span></div></div>
            <div class="item" id="goMant"><div class="l"><b>Mantenimientos</b><span>Resumen + historial</span></div><div class="r"><span class="chip">Abrir</span></div></div>
            <div class="item" id="goPagos"><div class="l"><b>Historial de pagos</b><span>Últimos 6 + visor</span></div><div class="r"><span class="chip">Abrir</span></div></div>
          </div>
        </div>
      </div>

      <div id="vTurnos" class="view">
        <div class="card"><div class="item" style="border:0;background:transparent;padding:0"><div class="l"><b>Turnos</b><span>Publicados para logística</span></div><div class="r"><button class="btn btn2" id="refTurnos">Actualizar</button></div></div></div>
        <div class="card"><div id="turnosList" class="list"></div></div>
      </div>

      <div id="vMant" class="view">
        <div class="card"><div class="item" style="border:0;background:transparent;padding:0"><div class="l"><b>Mantenimientos</b><span>Resumen y últimos registros</span></div><div class="r"><button class="btn btn2" id="refMant">Refrescar</button></div></div></div>
        <div class="card">
          <div class="grid">
            <div class="kpi"><small>Aceite</small><b id="mAceite">—</b></div>
            <div class="kpi"><small>Pastillas</small><b id="mPastillas">—</b></div>
            <div class="kpi"><small>Kit arrastre</small><b id="mKit">—</b></div>
            <div class="kpi"><small>Total</small><b id="mTotal">—</b></div>
          </div>
        </div>
        <div class="card"><div id="mantList" class="list"></div></div>
      </div>

      <div id="vPagos" class="view">
        <div class="card"><div class="item" style="border:0;background:transparent;padding:0"><div class="l"><b>Pagos</b><span>Últimos 6</span></div><div class="r"><button class="btn btn2" id="refPagos">Actualizar</button></div></div></div>
        <div class="card"><div id="pagosList" class="list"></div></div>
      </div>
    </div>

    <div class="sheet">
      <div class="nav">
        <button class="nbtn on" data-go="Home">Home</button>
        <button class="nbtn" data-go="Turnos">Turnos</button>
        <button class="nbtn" data-go="Mant">Mant.</button>
        <button class="nbtn" data-go="Pagos">Pagos</button>
      </div>
    </div>
  </div>
</div>

<div id="pdfModal" class="modal"><div class="mbox">
  <div class="mhead"><b id="pdfTitle">Documento</b><button class="btn btn2" id="pdfClose">Cerrar</button></div>
  <div class="mbody"><iframe id="pdfFrame" src=""></iframe></div>
</div></div>

<div id="qrModal" class="modal"><div class="mbox" style="height:min(620px,100%)">
  <div class="mhead"><b>Código QR</b><button class="btn btn2" id="qrClose">Cerrar</button></div>
  <div class="mbody" style="display:flex;align-items:center;justify-content:center;padding:14px">
    <div class="card" style="width:min(520px,100%);text-align:center">
      <div style="font-weight:900;margin-bottom:8px">Escanea para pagar</div>
      <img src="QRRADIZ-38.png" alt="QR RADIZ" style="max-width:100%;height:auto;border-radius:14px;border:1px solid var(--b)">
      <div style="color:var(--m);font-size:12px;margin-top:10px">Incluye tu ID en la referencia del pago.</div>
    </div>
  </div>
</div></div>

<div id="toast" class="toast"><span id="tdot" class="dot ok"></span><span id="tmsg">OK</span></div>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbxNiAZCMVvaagzFjYQgIsQkGEWJPui9baIHcO_-JjeJ6HvDYdDU5BdH8R6zzD3zDUw/exec';
const WOMPI_PUBLIC_KEY='pub_prod_D1w0Ys7mW5OJOueJoMi1rA5aLYJvlN06';
const WOMPI_INTEGRITY_KEY='prod_integrity_zNC4ZqryuKzC75Cp72boasFFTLgzmhKN';
const WOMPI_REDIRECT_URL=(location.origin||'https://portal.radizco.com')+'/logistica/';
const API_CALLBACK_URL=API_URL;

let S={id:'',tipo:'',contrato:null,pagos:null,mantenimientos:null,resumen:null,turnos:null};

const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const qs=o=>Object.entries(o).filter(([,v])=>v!==undefined&&v!==null&&v!=='').map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(v)).join('&');
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
const money=n=>{n=Number(n||0);return n.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0})};
function toast(msg,mode){const t=$("#toast"),d=$("#tdot"),m=$("#tmsg");d.className="dot "+(mode==="bad"?"bad":mode==="w"?"w":"ok");m.textContent=msg;t.classList.add("on");setTimeout(()=>t.classList.remove("on"),2200)}
const __touchBlocker=e=>{e.preventDefault();};
const __wheelBlocker=e=>{if(e&&e.ctrlKey)return;e.preventDefault();};
document.addEventListener('touchmove',__touchBlocker,{passive:false});
document.addEventListener('wheel',__wheelBlocker,{passive:false});

async function get(p){const r=await fetch(API_URL+'?'+qs(p),{cache:"no-store"});return await r.json()}
async function postForm(p){const r=await fetch(API_CALLBACK_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body:qs(p)});try{return await r.json()}catch(e){return {ok:true}}}

function show(v){
  ["Home","Turnos","Mant","Pagos"].forEach(x=>{
    const el=$("#v"+x);
    el.classList.toggle("on",x===v);
    el.style.display=x===v?"flex":"none";
  });
  $$(".nbtn").forEach(b=>b.classList.toggle("on",b.dataset.go===v));
}

function openPDF(title,url){
  $("#pdfTitle").textContent=title||"Documento";
  $("#pdfFrame").src=url||"";
  $("#pdfModal").classList.add("on");
}
function closePDF(){ $("#pdfModal").classList.remove("on"); $("#pdfFrame").src=""; }
$("#pdfClose").onclick=closePDF;
$("#pdfModal").onclick=e=>{if(e.target.id==="pdfModal")closePDF()};

function openQR(){ $("#qrModal").classList.add("on"); }
function closeQR(){ $("#qrModal").classList.remove("on"); }
$("#qrClose").onclick=closeQR;
$("#qrModal").onclick=e=>{if(e.target.id==="qrModal")closeQR()};
$("#btnQR").onclick=openQR;

function qparam(k){try{return new URLSearchParams(location.search).get(k)||''}catch(e){return ''}}

$("#btnSalir").onclick=()=>{S={id:'',tipo:'',contrato:null,pagos:null,mantenimientos:null,resumen:null,turnos:null};$("#dash").style.display="none";$("#login").style.display="flex";$("#id").value='';toast("Sesión cerrada","w")};

$("#goTurnos").onclick=()=>{show("Turnos");loadTurnos()};
$("#goMant").onclick=()=>{show("Mant");loadMant()};
$("#goPagos").onclick=()=>{show("Pagos");loadPagos()};
$$(".nbtn").forEach(b=>b.onclick=()=>{show(b.dataset.go);if(b.dataset.go==="Turnos")loadTurnos();if(b.dataset.go==="Mant")loadMant();if(b.dataset.go==="Pagos")loadPagos();});

async function boot(id){
  if(!id) return;
  id=String(id).trim().toUpperCase();
  $("#id").value=id;
  try{
    const data=await get({id:id});
    if(!data||data.ok===false) throw new Error(data?.error||"No fue posible cargar");
    const c=data.contrato||{};
    S.id=id;
    S.contrato=c;
    S.pagos=Array.isArray(data.pagos)?data.pagos:[];
    S.mantenimientos=Array.isArray(data.mantenimientos)?data.mantenimientos:[];
    S.resumen=data.mantenimientosResumen||data.resumenMantenimientos||{};
    const nombre=(c['ID CLIENTE']||c['NOMBRE']||'RADIZ').toString();
    $("#tCliente").textContent=nombre;
    $("#tContrato").textContent="ID: "+id;
    $("#login").style.display="none";
    $("#dash").style.display="flex";
    show("Home");
    await loadHome();
    toast("Listo","ok");
  }catch(e){
    toast(String(e.message||e),"bad");
  }
}

$("#btnGo").onclick=()=>boot(($("#id").value||"").trim());
document.addEventListener("DOMContentLoaded",()=>{const id=qparam("id");if(id) boot(id);});

async function loadHome(){
  const c=S.contrato||{};
  const estado=(c['ESTADO']||'').toString().toUpperCase()||"—";
  $("#kEstado").textContent=estado;
  $("#kPagos").textContent=String((S.pagos||[]).length||0);
  $("#kMant").textContent=String((S.mantenimientos||[]).length||0);
  const p=(S.pagos&&S.pagos.length)?S.pagos[0]:null;
  const prox=p?(p['DÍAS DE CORTE']||p['DIAS DE CORTE']||''):'';
  $("#kProx").textContent=prox?String(prox):"—";
}

async function loadTurnos(){
  try{
    if(S.turnos){renderTurnos(S.turnos);return}
    const r=await get({accion:"get_turnos_publicados",idContrato:S.id,id:S.id});
    const list=r?.turnos||r?.data||r||[];
    S.turnos=Array.isArray(list)?list:[];
    renderTurnos(S.turnos);
  }catch(e){toast("Error en turnos","bad")}
}
function renderTurnos(list){
  const el=$("#turnosList");el.innerHTML="";
  if(!list||!list.length){
    el.innerHTML='<div class="item"><div class="l"><b>Sin turnos</b><span>No hay turnos publicados por ahora</span></div><div class="r"><span class="chip">—</span></div></div>';
    return;
  }
  list.slice(0,10).forEach(t=>{
    const titulo=t.titulo||t.nombre||"Turno";
    const det=(t.detalle||t.descripcion||t.ruta||"").toString();
    const tag=t.tag||t.estado||"Disponible";
    const c=document.createElement("div");
    c.className="item";
    c.innerHTML='<div class="l"><b>'+esc(titulo)+'</b><span>'+esc(det)+'</span></div><div class="r"><span class="chip ok">'+esc(tag)+'</span></div>';
    el.appendChild(c);
  });
}
$("#refTurnos").onclick=async()=>{S.turnos=null;await loadTurnos();toast("Actualizado","ok")};

function numCO(v){
  if(v===null||v===undefined) return 0;
  if(typeof v==='number') return isNaN(v)?0:v;
  let s=String(v).trim();if(!s) return 0;
  s=s.replace(/[^\d.,-]/g,'');
  if(/^\d{1,3}(\.\d{3})+$/.test(s)) s=s.replace(/\./g,'');
  else if(s.includes('.')&&s.includes(',')) s=s.replace(/\./g,'').replace(/,/g,'.');
  else if(s.includes(',')&&!s.includes('.')){const p=s.split(',');s=(p.length===2&&p[1].length===3)?(p[0]+p[1]):(p[0]+'.'+p[1]);}
  const n=parseFloat(s);return isNaN(n)?0:n;
}

async function loadMant(){
  try{
    const rm=S.resumen||{};
    const mts=S.mantenimientos||[];
    const totalVal=(rm.totalMantenimientos!==undefined)?Number(rm.totalMantenimientos||0):mts.reduce((s,mm)=>s+numCO(mm?.valor??mm?.['VALOR GENERAL']??mm?.['VALOR MTOS']??mm?.['VALOR']??mm?.['VALOR MTO']),0);
    const ace=numCO(rm.cambiosAceite??rm.aceites??rm.Aceites??rm['CAMBIOS ACEITE']??(mts[0]?.cambiosAceite));
    const pas=numCO(rm.pastillas??rm.Pastillas??rm['PASTILLAS']??(mts[0]?.pastillas));
    const kit=numCO(rm.kitArrastre??rm.kitsArrastre??rm.KitArrastre??rm.KitsArrastre??rm.kit_arrastre??rm.kits_arrastre??rm['Kit de arrastre']??rm['KIT DE ARRASTRE']??(mts[0]?.kitArrastre));
    $("#mAceite").textContent=String(ace||0);
    $("#mPastillas").textContent=String(pas||0);
    $("#mKit").textContent=String(kit||0);
    $("#mTotal").textContent=money(totalVal||0);
    renderMant(mts);
  }catch(e){toast("Error en mantenimientos","bad")}
}
function renderMant(list){
  const el=$("#mantList");el.innerHTML="";
  if(!list||!list.length){
    el.innerHTML='<div class="item"><div class="l"><b>Sin registros</b><span>No hay mantenimientos para mostrar</span></div><div class="r"><span class="chip">—</span></div></div>';
    return;
  }
  list.slice(0,8).forEach(m=>{
    const f=(m.fecha||m.f||m.date||"").toString();
    const t=(m.tipo||m.concepto||m.item||m['TIPO']||"Mantenimiento").toString();
    const v=m.valor||m.monto||m.total||m['VALOR']||"";
    const c=document.createElement("div");
    c.className="item";
    c.innerHTML='<div class="l"><b>'+esc(t)+'</b><span>'+esc(f)+'</span></div><div class="r"><span class="chip">'+esc(v? (typeof v==="number"?money(v):String(v)):"—")+'</span></div>';
    el.appendChild(c);
  });
}
$("#refMant").onclick=async()=>{try{const data=await get({id:S.id});if(data&&data.ok!==false){S.pagos=Array.isArray(data.pagos)?data.pagos:[];S.mantenimientos=Array.isArray(data.mantenimientos)?data.mantenimientos:[];S.resumen=data.mantenimientosResumen||data.resumenMantenimientos||{};await loadHome();await loadMant();toast("Actualizado","ok")}}catch(e){toast("No se pudo actualizar","bad")}};

async function loadPagos(){
  try{
    const r=await get({accion:"historial_pagos_lista",idContrato:S.id,id:S.id,limite:6});
    const list=r?.pagos||r?.data||r||[];
    const arr=Array.isArray(list)?list:[];
    renderPagos(arr);
  }catch(e){toast("Error en pagos","bad")}
}
function renderPagos(list){
  const el=$("#pagosList");el.innerHTML="";
  if(!list||!list.length){
    el.innerHTML='<div class="item"><div class="l"><b>Sin pagos</b><span>No hay pagos registrados</span></div><div class="r"><span class="chip">—</span></div></div>';
    return;
  }
  list.slice(0,6).forEach(p=>{
    const ref=(p.referencia||p.ref||p.id||p.consecutivo||"—").toString();
    const f=(p.fecha||p.f||"").toString();
    const v=p.monto||p.valor||p.total||p['VALOR']||"";
    const st=(p.estado||p.status||"").toString().toLowerCase();
    const cls=st.includes("ok")||st.includes("aprob")?"ok":st.includes("rech")?"bad":"w";
    const row=document.createElement("div");
    row.className="item";
    row.innerHTML='<div class="l"><b>'+esc(ref)+'</b><span>'+esc(f)+'</span></div><div class="r"><span class="chip '+cls+'">'+esc(v? (typeof v==="number"?money(v):String(v)):"—")+'</span><button class="btn btn2" style="padding:8px 10px" data-ref="'+esc(ref)+'">Ver</button></div>';
    row.querySelector("button").onclick=()=>openPagoPDF(ref);
    el.appendChild(row);
  });
}
$("#refPagos").onclick=()=>{loadPagos();toast("Actualizado","ok")};

async function openPagoPDF(ref){
  try{
    const r=await get({accion:"historial_pagos_pdf",idContrato:S.id,id:S.id,referencia:ref});
    const url=r?.url||r?.pdf||r?.link;
    if(!url) throw new Error("Sin PDF");
    openPDF("Comprobante de pago",url);
  }catch(e){toast("No se pudo abrir","bad")}
}

async function __ensureWompiLoaded(){
  if(typeof WidgetCheckout!=='undefined') return true;
  if(window.__wompiLoading) return window.__wompiLoading;
  window.__wompiLoading=new Promise((resolve,reject)=>{
    const s=document.createElement('script');
    s.src='https://checkout.wompi.co/widget.js';
    s.async=true;
    s.onload=()=>resolve(true);
    s.onerror=()=>reject(new Error('Wompi no cargó'));
    document.head.appendChild(s);
  });
  return window.__wompiLoading;
}

async function generarIntegritySignature(reference,amountInCents,currency){
  if(!(window.crypto&&crypto.subtle)) throw new Error('Crypto no disponible');
  const encoder=new TextEncoder();
  const raw=`${reference}${amountInCents}${currency}${WOMPI_INTEGRITY_KEY}`;
  const hashBuffer=await crypto.subtle.digest('SHA-256',encoder.encode(raw));
  const hashArray=Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function registrarPagoEnSheet(reference,valor,idContrato,statusWompi){
  try{
    const p={accion:'registrar_pago_portal',referencia:reference,monto:valor,idContrato:idContrato,origen:'PORTAL_WEB'};
    if(statusWompi) p.statusWompi=statusWompi;
    const r=await postForm(p);
    if(r&&r.ok===false) throw new Error(r.error||"falló");
  }catch(e){
    try{await postForm({accion:'registrar_pago',referencia:reference,monto:valor,idContrato:idContrato,origen:'PORTAL_WEB',statusWompi:statusWompi||''});}catch(_){}
  }
}

$("#btnPagar").onclick=async()=>{
  if(!S.id) return toast("Falta ID","bad");
  try{
    await __ensureWompiLoaded();
    const valor=170000;
    const amountInCents=valor*100;
    const reference='PAGO_'+S.id+'_'+Date.now();
    const currency='COP';
    const integritySignature=await generarIntegritySignature(reference,amountInCents,currency);
    const checkout=new WidgetCheckout({currency,amountInCents,reference,publicKey:WOMPI_PUBLIC_KEY,signature:{integrity:integritySignature},redirectUrl:WOMPI_REDIRECT_URL});
    checkout.open(async function(result){
      const t=result&&result.transaction?result.transaction:null;
      const status=t&&t.status?t.status:'';
      await registrarPagoEnSheet(reference,valor,S.id,status);
      toast(status&&String(status).toUpperCase()==="APPROVED"?"Pago aprobado":"Pago registrado","ok");
      show("Home");
      try{const data=await get({id:S.id});if(data&&data.ok!==false){S.pagos=Array.isArray(data.pagos)?data.pagos:[];S.mantenimientos=Array.isArray(data.mantenimientos)?data.mantenimientos:[];S.resumen=data.mantenimientosResumen||data.resumenMantenimientos||{};await loadHome();}}catch(e){}
    });
  }catch(e){
    toast("No fue posible iniciar el pago","bad");
  }
};

if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('/sw.js').catch(()=>{});});}
</script></body></html>
