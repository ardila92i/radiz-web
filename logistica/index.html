<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Portal Logístico RADIZ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    *{box-sizing:border-box}

    body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f5f6f8;
      color:#0f172a;
    }

    .page{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:32px 16px;
    }

    .container{
      width:100%;
      max-width:1120px;
      background:#ffffff;
      border-radius:24px;
      box-shadow:0 18px 45px rgba(15,23,42,.14);
      padding:24px 28px 28px;
      position:relative;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      margin-bottom:10px;
    }

    .header-title h1{
      margin:0;
      font-size:1.8rem;
      letter-spacing:.03em;
    }

    .header-title p{
      margin:4px 0 0;
      font-size:.9rem;
      color:#4b5563;
    }

    .saludo{
      font-size:.95rem;
      color:#111827;
      font-weight:700;
      margin-bottom:4px;
      letter-spacing:.01em;
    }
    .saludo span{
      color:#2563eb;
    }

    .badge-id{
      font-size:.8rem;
      padding:4px 10px;
      border-radius:999px;
      background:#eff6ff;
      color:#1d4ed8;
      font-weight:600;
    }

    /* Texto principal debajo del título */
    .intro-text{
      margin-top:4px;
      margin-bottom:16px;
      font-size:.9rem;
      color:#4b5563;
    }

    /* Fila cobertura */
    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:18px;
    }

    .toolbar-left{
      font-size:.85rem;
      color:#6b7280;
    }

    /* GRID PRINCIPAL */
    .main-grid{
      display:grid;
      grid-template-columns:minmax(0,1.4fr) minmax(0,1fr);
      gap:18px;
      align-items:flex-start;
    }

    .card{
      border-radius:18px;
      border:1px solid #e5e7eb;
      background:#ffffff;
      padding:16px 18px 18px;
      font-size:.9rem;
      transition:border-color .15s,box-shadow .15s,transform .1s,background .15s;
    }

    .card h2{
      margin:0 0 6px;
      font-size:1.1rem;
      font-weight:700;
      color:#111827;
    }

    .card p{
      margin:3px 0;
      color:#4b5563;
    }

    .card:hover{
      border-color:#2563eb;
      box-shadow:0 16px 34px rgba(37,99,235,.12);
      transform:translateY(-1px);
    }

    /* Card turnos */
    .turnos-list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:10px;
    }

    .turno-card{
      border-radius:14px;
      border:1px solid #e5e7eb;
      padding:10px 12px;
      display:grid;
      grid-template-columns:96px minmax(0,1fr);
      gap:10px;
      align-items:stretch;
      background:#f9fafb;
      cursor:pointer;
      transition:transform .1s,box-shadow .12s,border-color .12s;
    }
    .turno-card:hover{
      border-color:#c7d2fe;
      box-shadow:0 12px 26px rgba(15,23,42,.08);
      transform:translateY(-1px);
    }

    .turno-logo-wrapper{
      border-radius:12px;
      overflow:hidden;
      background:#2563eb; /* placeholder azul RADIZ */
      display:flex;
      align-items:center;
      justify-content:center;
      color:#ffffff;
      font-weight:700;
      font-size:.78rem;
      text-align:center;
      padding:10px;
      user-select:none;
    }
    .turno-logo-wrapper small{
      display:block;
      opacity:.9;
      font-weight:600;
      margin-top:4px;
    }

    .turno-content{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .turno-header-line{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .turno-titulo{
      font-size:1rem;
      font-weight:800;
      color:#111827;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .dot-available{
      width:9px;
      height:9px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 4px rgba(34,197,94,.16);
      flex:0 0 auto;
    }

    .pill-idturno{
      font-size:.72rem;
      padding:2px 8px;
      border-radius:999px;
      background:#eff6ff;
      color:#1d4ed8;
      font-weight:700;
      border:1px solid #dbeafe;
    }

    .turno-mini{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      font-size:.85rem;
      color:#4b5563;
    }
    .turno-mini strong{ color:#111827; font-weight:700; }

    .turno-valor{
      margin-top:2px;
      font-size:.9rem;
      color:#111827;
      font-weight:800;
    }

    .status{
      font-size:.85rem;
      margin-top:6px;
      min-height:1.1em;
    }
    .status.error{color:#b91c1c}
    .status.ok{color:#065f46}
    .status.muted{color:#9ca3af}

    /* Card agenda en azul oscuro */
    .card-agenda{
      background:#0f172a;
      color:#f9fafb;
      border-color:#1f2937;
      box-shadow:0 16px 38px rgba(15,23,42,.5);
    }

    .card-agenda h2{
      color:#f9fafb;
    }

    .agenda-dia{
      display:flex;
      flex-direction:column;
      gap:2px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(15,23,42,.7);
      border:1px solid rgba(148,163,184,.35);
      font-size:.85rem;
      position:relative;
    }

    .agenda-dia + .agenda-dia{
      margin-top:8px;
    }

    .agenda-fecha{
      font-weight:700;
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:#bfdbfe;
    }

    .agenda-turno{
      font-weight:800;
      font-size:.92rem;
      margin-top:2px;
    }

    .agenda-detalle{
      font-size:.82rem;
      color:#e5e7eb;
    }

    .agenda-detalle strong{
      color:#ffffff;
      font-weight:700;
    }

    .agenda-estado-row{
      margin-top:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .estado-chip{
      font-size:.72rem;
      padding:3px 8px;
      border-radius:999px;
      font-weight:800;
      border:1px solid rgba(148,163,184,.35);
      user-select:none;
    }
    .estado-chip.pendiente{ background:rgba(148,163,184,.18); color:#e5e7eb; }
    .estado-chip.ensitio{ background:rgba(34,197,94,.18); color:#bbf7d0; border-color:rgba(34,197,94,.35); }
    .estado-chip.completado{ background:rgba(239,68,68,.18); color:#fecaca; border-color:rgba(239,68,68,.35); }

    .mini-switch{
      width:46px;
      height:24px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(148,163,184,.18);
      position:relative;
      cursor:pointer;
      flex:0 0 auto;
      transition:background .12s,border-color .12s;
    }
    .mini-switch .knob{
      width:20px;
      height:20px;
      border-radius:999px;
      background:#e5e7eb;
      position:absolute;
      top:50%;
      left:2px;
      transform:translateY(-50%);
      transition:left .14s, background .12s;
    }
    .mini-switch.ensitio{
      background:rgba(34,197,94,.2);
      border-color:rgba(34,197,94,.45);
    }
    .mini-switch.ensitio .knob{
      left:24px;
      background:#bbf7d0;
    }
    .mini-switch.completado{
      background:rgba(239,68,68,.2);
      border-color:rgba(239,68,68,.45);
      cursor:default;
      opacity:.92;
    }
    .mini-switch.completado .knob{
      left:24px;
      background:#fecaca;
    }

    /* FAB menú (Mi perfil) */
    .fab-menu{
      position:absolute;
      top:22px;
      right:22px;
      z-index:20;
    }

    .fab-btn{
      width:46px;
      height:46px;
      border-radius:999px;
      background:#2563eb;
      border:none;
      box-shadow:0 10px 24px rgba(37,99,235,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:transform .12s,box-shadow .12s,background .12s;
    }

    .fab-btn:hover{
      transform:translateY(-1px);
      background:#1d4ed8;
      box-shadow:0 14px 32px rgba(37,99,235,.55);
    }

    .fab-btn span{
      display:block;
      width:22px;
      height:2px;
      border-radius:999px;
      background:#fff;
      position:relative;
    }

    .fab-btn span::before,
    .fab-btn span::after{
      content:"";
      position:absolute;
      left:0;
      width:22px;
      height:2px;
      border-radius:999px;
      background:#fff;
    }
    .fab-btn span::before{top:-6px}
    .fab-btn span::after{top:6px}

    .menu-panel{
      position:absolute;
      top:56px;
      right:0;
      background:#ffffff;
      border-radius:14px;
      box-shadow:0 12px 30px rgba(15,23,42,.22);
      padding:8px 0;
      width:220px;
      display:none;
      z-index:25;
    }

    .menu-title{
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-weight:700;
      color:#6b7280;
      padding:6px 14px 4px;
    }

    .menu-item{
      padding:7px 14px;
      font-size:.9rem;
      cursor:pointer;
      color:#111827;
    }

    .menu-item:hover{
      background:#eff6ff;
      color:#1d4ed8;
    }

    /* Modales */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }

    .modal{
      background:#fff;
      border-radius:18px;
      max-width:520px;
      width:92%;
      padding:18px 20px 18px;
      box-shadow:0 20px 45px rgba(15,23,42,.4);
      font-size:.9rem;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      gap:10px;
    }

    .modal-header h3{
      margin:0;
      font-size:1.05rem;
      font-weight:800;
    }

    .modal-close{
      border:none;
      background:transparent;
      font-size:1.3rem;
      cursor:pointer;
      color:#6b7280;
    }

    .modal p{
      margin:4px 0;
      color:#111827;
    }

    .modal label{
      display:block;
      margin-top:8px;
      margin-bottom:3px;
      font-size:.85rem;
      color:#374151;
    }

    .modal .status{
      margin-top:6px;
    }

    .modal-actions{
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn{
      padding:8px 16px;
      border-radius:999px;
      border:none;
      font-size:.9rem;
      font-weight:700;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
      transition:transform .1s,box-shadow .1s,background .1s,color .1s,opacity .1s;
    }

    .btn-primary{
      background:#2563eb;
      color:#ffffff;
      box-shadow:0 10px 24px rgba(37,99,235,.4);
    }

    .btn-primary:hover{
      background:#1d4ed8;
      box-shadow:0 12px 30px rgba(37,99,235,.55);
      transform:translateY(-1px);
    }

    .btn-primary:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    .btn-secondary{
      background:#e5e7eb;
      color:#111827;
      box-shadow:none;
    }

    .btn-secondary:hover{
      background:#d1d5db;
      box-shadow:none;
      transform:translateY(-1px);
    }

    .check-row{
      display:flex;
      align-items:flex-start;
      gap:8px;
      margin-top:10px;
      font-size:.85rem;
    }

    .check-row input[type="checkbox"]{
      margin-top:3px;
      transform:scale(1.1);
    }

    .detalle-img{
      width:100%;
      height:160px;
      border-radius:14px;
      background:#2563eb;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#ffffff;
      font-weight:800;
      margin:10px 0 12px;
      cursor:pointer;
      user-select:none;
    }
    .detalle-img small{opacity:.9;font-weight:700}

    .iframe-box{
      width:100%;
      height:70vh;
      border-radius:14px;
      overflow:hidden;
      border:1px solid #e5e7eb;
      background:#f9fafb;
    }
    .iframe-box iframe{
      width:100%;
      height:100%;
      border:0;
    }

    footer{
      margin-top:16px;
      font-size:.75rem;
      color:#9ca3af;
      text-align:center;
    }

    @media(max-width:900px){
      .main-grid{
        grid-template-columns:1fr;
      }
    }

    @media(max-width:640px){
      .container{
        padding:20px 16px 22px;
        border-radius:18px;
      }
      .header{
        flex-direction:column;
        align-items:flex-start;
      }
      .fab-menu{
        top:18px;
        right:18px;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="container">
    <!-- FAB menú: Mi perfil -->
    <div class="fab-menu">
      <button class="fab-btn" type="button" onclick="toggleMenu()">
        <span></span>
      </button>
      <div class="menu-panel" id="menuPanel">
        <div class="menu-title">Portal logístico</div>
        <div class="menu-item" onclick="abrirModal('modalPerfil')">Mi perfil</div>
      </div>
    </div>

    <!-- Encabezado -->
    <div class="header">
      <div class="header-title">
        <div class="saludo">Hola, <span id="nombreMensajero">Mensajero</span></div>
        <h1>Portal Logístico</h1>
        <p class="intro-text">
          Te mostraremos los turnos de mensajería o repartos disponibles en tu ciudad.
        </p>
      </div>
      <div>
        <span id="badgeContrato" class="badge-id" style="display:none;"></span>
      </div>
    </div>

    <!-- Fila cobertura fija -->
    <div class="toolbar">
      <div class="toolbar-left">
        <strong>Cobertura:</strong> Bogotá
      </div>
    </div>

    <!-- GRID PRINCIPAL -->
    <div class="main-grid">
      <!-- Turnos -->
      <div class="card">
        <h2>Disponibles</h2>
        <p style="font-size:.85rem;color:#6b7280;">
          Toca un turno para ver detalles y confirmar aceptación.
        </p>
        <div id="turnosEstado" class="status muted">Cargando turnos publicados...</div>
        <div id="turnosList" class="turnos-list"></div>
      </div>

      <!-- Mi agenda -->
      <div class="card card-agenda">
        <h2>Mi agenda</h2>
        <p id="agendaEstado" class="status" style="color:#e5e7eb;">
          Aún no tienes turnos aceptados.
        </p>
        <div id="agendaContenido"></div>
      </div>
    </div>

    <footer>
      Versión interna • RADIZ Logística de Mensajería
    </footer>
  </div>
</div>

<!-- MODAL: Mi perfil (resumen de contrato) -->
<div class="modal-backdrop" id="modalPerfil">
  <div class="modal">
    <div class="modal-header">
      <h3>Mi perfil</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalPerfil')">&times;</button>
    </div>
    <div id="perfilContenido">
      <p class="status muted">Cargando información de tu contrato...</p>
    </div>
  </div>
</div>

<!-- MODAL: Detalle turno -->
<div class="modal-backdrop" id="modalDetalleTurno">
  <div class="modal">
    <div class="modal-header">
      <h3 id="detalleTitulo">Detalle del turno</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalDetalleTurno')">&times;</button>
    </div>

    <div class="detalle-img" onclick="abrirModal('modalImagenTurno')">
      Fachada del punto<br/>
      <small>(toca para ampliar)</small>
    </div>

    <div id="detalleContenido"></div>

    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalDetalleTurno')">
        Cerrar
      </button>
      <button type="button" class="btn btn-primary" onclick="abrirConfirmacionTurnoDesdeDetalle()">
        Aceptar turno
      </button>
    </div>
  </div>
</div>

<!-- MODAL: Imagen ampliada -->
<div class="modal-backdrop" id="modalImagenTurno">
  <div class="modal">
    <div class="modal-header">
      <h3>Fachada del punto</h3>
      <button class="modal-close" type="button" onclick="cerrarModal('modalImagenTurno')">&times;</button>
    </div>
    <div class="detalle-img" style="height:240px;cursor:default;">
      Imagen de referencia<br/>
      <small>(placeholder RADIZ)</small>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalImagenTurno')">Volver</button>
    </div>
  </div>
</div>

<!-- MODAL: Confirmar aceptación de turno -->
<div class="modal-backdrop" id="modalConfirmarTurno">
  <div class="modal">
    <div class="modal-header">
      <h3>Confirmar aceptación de turno</h3>
      <button class="modal-close" type="button" onclick="cerrarConfirmacionTurno()">&times;</button>
    </div>
    <p>
      ¿Está seguro de aceptar el turno?
      Recuerde que es un compromiso laboral legal que cumple con toda la normativa vigente.
      En caso de incumplimiento se cargará a su cuenta los valores de penalización.
    </p>
    <div class="check-row">
      <input type="checkbox" id="chkTerminos" onchange="actualizarEstadoConfirmar()">
      <label for="chkTerminos">
        Acepto términos y condiciones del servicio de mensajería.
      </label>
    </div>
    <p id="confirmarTurnoMsg" class="status"></p>
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" onclick="cerrarConfirmacionTurno()">
        Cancelar
      </button>
      <button type="button" class="btn btn-secondary" onclick="verTerminosTurno()">
        Términos y condiciones
      </button>
      <button type="button" id="btnConfirmarTurno" class="btn btn-primary" onclick="confirmarAceptarTurno()" disabled>
        Confirmar
      </button>
    </div>
  </div>
</div>

<!-- MODAL: Términos y condiciones (con volver) -->
<div class="modal-backdrop" id="modalTerminosTurno">
  <div class="modal">
    <div class="modal-header">
      <h3>Términos y condiciones</h3>
      <button class="modal-close" type="button" onclick="volverAConfirmacionTurno()">&times;</button>
    </div>

    <div class="iframe-box">
      <iframe id="iframeTerminos" src="terminos_y_condiciones_turnos.pdf"></iframe>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" onclick="volverAConfirmacionTurno()">
        ← Volver a confirmar
      </button>
      <button type="button" class="btn btn-secondary" onclick="window.open('terminos_y_condiciones_turnos.pdf','_blank')">
        Abrir en nueva pestaña
      </button>
    </div>
  </div>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxNiAZCMVvaagzFjYQgIsQkGEWJPui9baIHcO_-JjeJ6HvDYdDU5BdH8R6zzD3zDUw/exec';

  let idContratoActual = null;
  let contratoActual = null;

  let turnoDetalle = null;        // turno seleccionado en modal detalle
  let turnoSeleccionado = null;   // turno seleccionado para confirmación
  let ultimaAceptacion = null;    // para simular agenda
  let agendaEstados = {};         // estados por día (PENDIENTE / EN_SITIO / COMPLETADO)

  document.addEventListener('DOMContentLoaded', function(){
    idContratoActual = obtenerIdContratoDeUrl();

    if(!idContratoActual){
      const badge = document.getElementById('badgeContrato');
      if(badge){
        badge.style.display='inline-block';
        badge.textContent='ID no definido';
      }
      const perfil = document.getElementById('perfilContenido');
      if(perfil){
        perfil.innerHTML = '<p class="status error">No se encontró el ID del contrato en la URL.</p>';
      }
    }else{
      const badge = document.getElementById('badgeContrato');
      if(badge){
        badge.style.display='inline-block';
        badge.textContent='Contrato '+idContratoActual;
      }
      cargarContratoYPerfil(idContratoActual);
    }

    cargarTurnosDisponibles();
  });

  function obtenerIdContratoDeUrl(){
    const params = new URLSearchParams(window.location.search);
    const id = (params.get('id') || '').trim().toUpperCase();
    return id || null;
  }

  function toggleMenu(){
    const panel = document.getElementById('menuPanel');
    if(!panel) return;
    panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
  }

  function abrirModal(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.style.display='flex';
    const panel = document.getElementById('menuPanel');
    if(panel) panel.style.display='none';
  }

  function cerrarModal(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.style.display='none';
  }

  /* ---- Confirmación: cerrar con reset (solo cuando el usuario cancela/cierra) ---- */
  function cerrarConfirmacionTurno(){
    const el = document.getElementById('modalConfirmarTurno');
    if(el) el.style.display = 'none';

    turnoSeleccionado = null;

    const chk = document.getElementById('chkTerminos');
    if(chk) chk.checked = false;

    const msg = document.getElementById('confirmarTurnoMsg');
    if(msg){
      msg.className = 'status';
      msg.textContent = '';
    }

    actualizarEstadoConfirmar();
  }

  function ocultarModal(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.style.display='none';
  }

  function formatearFechaCorta(v){
    if(!v) return '';
    const d = new Date(v);
    if(isNaN(d.getTime())) return v;
    return d.toLocaleDateString('es-CO',{ day:'2-digit',month:'2-digit',year:'numeric' });
  }

  function formatearHora(h){
    return h || '';
  }

  function formatearNumeroCOP(n){
    const num = Number(n);
    if(isNaN(num)) return n || '';
    return num.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
  }

  function primerNombre(nombre){
    const txt = String(nombre || '').trim();
    if(!txt) return '';
    return txt.split(/\s+/)[0];
  }

  /* ------- Cargar contrato para "Mi perfil" + saludo ------- */
  async function cargarContratoYPerfil(id){
    const perfil = document.getElementById('perfilContenido');
    if(perfil){
      perfil.innerHTML = '<p class="status muted">Cargando información de tu contrato...</p>';
    }

    try{
      const resp = await fetch(API_URL + '?id=' + encodeURIComponent(id));
      const data = await resp.json();

      if(!data.ok){
        if(perfil){
          perfil.innerHTML = '<p class="status error">' + (data.error || 'No se encontró información para este ID.') + '</p>';
        }
        return;
      }

      const c = data.contrato || {};
      contratoActual = c;

      // Saludo: primer nombre desde Web Service (contrato)
      const nombreBruto =
        c['NOMBRE MENSAJERO'] ||
        c['MENSAJERO'] ||
        c['NOMBRE'] ||
        c['ID CLIENTE'] ||
        '';
      const pNom = primerNombre(nombreBruto) || 'Mensajero';
      const elNom = document.getElementById('nombreMensajero');
      if(elNom) elNom.textContent = pNom;

      const placa = c['ID VEHÍCULO'] || c['ID VEHICULO'] || '';
      const inicio = c['INICIO'] || '';
      const ciudad = c['CIUDAD'] || '';
      const estado = (c['ESTADO'] || '').toString().toUpperCase();
      const tarifa = c['TARIFA SEMANAL'] || '';
      const km = c['KILOMETRAJE'] || c['KILOMETRAJE ACTUAL'] || '';

      let html = '';
      html += '<p><strong>ID contrato:</strong> ' + (c['ID CONTRATO'] || '') + '</p>';
      html += '<p><strong>Placa / vehículo:</strong> ' + placa + '</p>';
      html += '<p><strong>Inicio:</strong> ' + formatearFechaCorta(inicio) + '</p>';
      html += '<p><strong>Ciudad:</strong> ' + (ciudad || 'Bogotá') + '</p>';
      if(tarifa){
        html += '<p><strong>Tarifa semanal:</strong> ' + formatearNumeroCOP(tarifa) + '</p>';
      }
      if(km){
        html += '<p><strong>Kilometraje actual:</strong> ' + km + ' km</p>';
      }
      html += '<p><strong>Estado:</strong> ' +
        (estado ? '<span style="padding:2px 8px;border-radius:999px;background:'+
          (estado === 'ACTIVO' ? '#dcfce7;color:#166534' : '#fee2e2;color:#b91c1c')+
          ';">' + estado + '</span>' : 'SIN ESTADO') +
        '</p>';

      if(perfil) perfil.innerHTML = html;

    }catch(e){
      console.error(e);
      if(perfil){
        perfil.innerHTML = '<p class="status error">Error al cargar la información del contrato.</p>';
      }
    }
  }

  /* ------- Cargar turnos publicados (lista compacta + modal detalle) ------- */
  async function cargarTurnosDisponibles(){
    const estado = document.getElementById('turnosEstado');
    const cont = document.getElementById('turnosList');
    if(cont) cont.innerHTML = '';

    if(estado){
      estado.className = 'status muted';
      estado.textContent = 'Cargando turnos publicados...';
    }

    try{
      const resp = await fetch(API_URL + '?accion=get_turnos_publicados');
      const data = await resp.json();

      const turnos = Array.isArray(data.turnos) ? data.turnos : [];

      if(!data.ok || turnos.length === 0){
        if(estado){
          estado.className = 'status error';
          estado.textContent = 'No hay turnos disponibles en este momento.';
        }
        return;
      }

      if(estado){
        estado.className = 'status ok';
        estado.textContent = 'Turnos activos encontrados: ' + turnos.length;
      }

      if(!cont) return;

      turnos.forEach(function(t){
        const idTurno =
          t.id_turno || t.idTurno || t.ID_TURNO || t['ID TURNO'] || t.codigo || t.codigo_turno || 'TURNO';

        const cliente =
          t.empresa || t.cliente || t.CLIENTE || t.punto || t['PUNTO DE ENTREGA'] || 'Cruz Verde';

        const sucursal = t.sucursal || t['SUCURSAL'] || '';
        const direccion = t.direccion || t.DIRECCION || t['DIRECCIÓN'] || '';
        const fecha = t.fecha || t.FECHA || '';
        const hora = t.hora || t.HORA || t.inicio || t.INICIO || '';
        const ciudad = t.ciudad || t.CIUDAD || 'Bogotá';

        const dias =
          t.dias || t.DIAS || t.duracion_dias || t.DURACION_DIAS || 3;

        const pagoEstimado =
          t.valorTurno || t.valor || t.VALOR || t.pago || t.PAGO || '';

        const correoCliente =
          t.correoCliente || t.correo || t.email || '';

        const turnoObj = {
          idTurno: String(idTurno),
          cliente: String(cliente),
          sucursal: String(sucursal || ''),
          direccion: String(direccion || ''),
          fecha: fecha || '',
          hora: String(hora || ''),
          ciudad: String(ciudad || 'Bogotá'),
          dias: Number(dias || 3),
          valor: pagoEstimado,
          correoCliente: String(correoCliente || ''),
          requisitos: String(t.requisitos || t.REQUISITOS || ''),
          descripcion: String(t.descripcion || t.DESCRIPCION || t['DESCRIPCIÓN'] || ''),
          paradas: String(t.paradas || t.PARADAS || ''),
          zonificacion: String(t.zonificacion || t.ZONIFICACION || t['ZONIFICACIÓN'] || '')
        };

        const card = document.createElement('div');
        card.className = 'turno-card';

        const fechaTxt = formatearFechaCorta(turnoObj.fecha) || 'Por definir';
        const horaTxt = formatearHora(turnoObj.hora) || 'Por definir';

        card.innerHTML = `
          <div class="turno-logo-wrapper" title="Toca para ver la fachada">
            Ver fachada
            <small>(ampliar)</small>
          </div>
          <div class="turno-content">
            <div class="turno-header-line">
              <div class="turno-titulo">
                <span class="dot-available"></span>
                ${turnoObj.cliente}
              </div>
              <div class="pill-idturno">${turnoObj.idTurno}</div>
            </div>

            <div class="turno-mini">
              <span><strong>Día:</strong> ${fechaTxt}</span>
              <span><strong>Hora:</strong> ${horaTxt}</span>
            </div>

            <div class="turno-valor">
              ${pagoEstimado ? formatearNumeroCOP(pagoEstimado) : 'Valor por confirmar'}
            </div>
          </div>
        `;

        card.addEventListener('click', function(){
          abrirDetalleTurno(turnoObj);
        });

        cont.appendChild(card);
      });

    }catch(e){
      console.error(e);
      if(estado){
        estado.className = 'status error';
        estado.textContent = 'Error al cargar los turnos publicados.';
      }
    }
  }

  function abrirDetalleTurno(turno){
    turnoDetalle = turno;

    const titulo = document.getElementById('detalleTitulo');
    const cont = document.getElementById('detalleContenido');

    if(titulo){
      titulo.textContent = (turno.cliente || 'Cruz Verde') + ' • ' + (turno.idTurno || 'TURNO');
    }

    const textoDias = (turno.dias || 3) + ' día' + (Number(turno.dias) === 1 ? '' : 's') +
      ' consecutivo' + (Number(turno.dias) === 1 ? '' : 's');

    let html = '';
    if(turno.sucursal){
      html += `<p><strong>Sucursal:</strong> ${turno.sucursal}</p>`;
    }
    html += `<p><strong>Dirección:</strong> ${turno.direccion || 'Por definir'}</p>`;
    html += `<p><strong>Fecha de inicio:</strong> ${formatearFechaCorta(turno.fecha) || 'Por definir'}</p>`;
    html += `<p><strong>Duración:</strong> ${textoDias}</p>`;
    html += `<p><strong>Horario:</strong> ${formatearHora(turno.hora) || 'Por definir'}</p>`;
    if(turno.valor){
      html += `<p><strong>Valor estimado:</strong> ${formatearNumeroCOP(turno.valor)}</p>`;
    }
    if(turno.zonificacion){
      html += `<p><strong>Zonificación:</strong> ${turno.zonificacion}</p>`;
    }
    if(turno.paradas){
      html += `<p><strong>Paradas:</strong> ${turno.paradas}</p>`;
    }
    if(turno.descripcion){
      html += `<p><strong>Descripción:</strong> ${turno.descripcion}</p>`;
    }
    if(turno.requisitos){
      html += `<p><strong>Requisitos:</strong> ${turno.requisitos}</p>`;
    }

    if(cont) cont.innerHTML = html || '<p class="status muted">Información del turno por confirmar.</p>';

    abrirModal('modalDetalleTurno');
  }

  function abrirConfirmacionTurnoDesdeDetalle(){
    if(!turnoDetalle) return;
    turnoSeleccionado = turnoDetalle;
    abrirConfirmacionTurno();
  }

  function abrirConfirmacionTurno(){
    const msg = document.getElementById('confirmarTurnoMsg');
    if(msg){
      msg.className = 'status';
      msg.textContent = '';
    }
    const chk = document.getElementById('chkTerminos');
    if(chk) chk.checked = false;

    actualizarEstadoConfirmar();

    abrirModal('modalConfirmarTurno');
  }

  function verTerminosTurno(){
    // Ocultamos confirmación (sin reset) y abrimos modal de términos con volver
    ocultarModal('modalConfirmarTurno');
    abrirModal('modalTerminosTurno');
  }

  function volverAConfirmacionTurno(){
    cerrarModal('modalTerminosTurno');
    abrirModal('modalConfirmarTurno');
    actualizarEstadoConfirmar();
  }

  function actualizarEstadoConfirmar(){
    const chk = document.getElementById('chkTerminos');
    const btn = document.getElementById('btnConfirmarTurno');
    if(!btn) return;
    btn.disabled = !(chk && chk.checked);
  }

  async function confirmarAceptarTurno(){
    const msg = document.getElementById('confirmarTurnoMsg');
    const chk = document.getElementById('chkTerminos');

    if(!turnoSeleccionado){
      if(msg){
        msg.className = 'status error';
        msg.textContent = 'No se encontró el turno seleccionado.';
      }
      return;
    }

    if(!idContratoActual){
      if(msg){
        msg.className = 'status error';
        msg.textContent = 'No se encontró tu contrato. Vuelve a ingresar desde el portal principal.';
      }
      return;
    }

    if(!chk || !chk.checked){
      if(msg){
        msg.className = 'status error';
        msg.textContent = 'Debes aceptar los términos y condiciones antes de confirmar.';
      }
      return;
    }

    if(msg){
      msg.className = 'status muted';
      msg.textContent = 'Enviando solicitud de turno...';
    }

    try{
      const formData = new URLSearchParams();
      formData.append('accion','solicitar_turno');
      formData.append('idContrato', idContratoActual);
      formData.append('idTurno', turnoSeleccionado.idTurno || '');
      formData.append('cliente', turnoSeleccionado.cliente || '');
      formData.append('direccion', turnoSeleccionado.direccion || '');
      formData.append('fecha', turnoSeleccionado.fecha || '');
      formData.append('hora', turnoSeleccionado.hora || '');
      formData.append('ciudad', turnoSeleccionado.ciudad || '');
      formData.append('dias', String(turnoSeleccionado.dias || 3));
      formData.append('correoCliente', turnoSeleccionado.correoCliente || '');

      const resp = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: formData.toString()
      });
      const data = await resp.json();

      if(!data.ok){
        if(msg){
          msg.className = 'status error';
          msg.textContent = data.error || 'No fue posible registrar la aceptación del turno.';
        }
        return;
      }

      if(msg){
        msg.className = 'status ok';
        msg.textContent = 'Solicitud enviada. Recibirás la confirmación de asignación por WhatsApp.';
      }

      // Simular que el turno queda en "Mi agenda" durante los días solicitados (máx 3 en vista)
      ultimaAceptacion = {
        turno: turnoSeleccionado,
        fechaBase: turnoSeleccionado.fecha || new Date().toISOString()
      };
      agendaEstados = {}; // reset estados
      actualizarAgendaDesdeUltimaAceptacion();

      setTimeout(function(){
        cerrarConfirmacionTurno();
        cerrarModal('modalDetalleTurno');
      }, 650);

    }catch(e){
      console.error(e);
      if(msg){
        msg.className = 'status error';
        msg.textContent = 'Error al enviar la solicitud. Intenta de nuevo.';
      }
    }
  }

  function actualizarAgendaDesdeUltimaAceptacion(){
    const cont = document.getElementById('agendaContenido');
    const estado = document.getElementById('agendaEstado');
    if(!cont || !estado) return;

    if(!ultimaAceptacion){
      estado.style.color = '#e5e7eb';
      estado.textContent = 'Aún no tienes turnos aceptados.';
      cont.innerHTML = '';
      return;
    }

    const t = ultimaAceptacion.turno;
    const dias = Number(t.dias || 3);

    let base = new Date(ultimaAceptacion.fechaBase);
    if(isNaN(base.getTime())) base = new Date();

    let html = '';
    const maxVista = Math.min(dias, 3);

    for(let i=0;i<maxVista;i++){
      const d = new Date(base.getTime());
      d.setDate(base.getDate() + i);

      const fechaTexto = d.toLocaleDateString('es-CO',{
        weekday:'short',day:'2-digit',month:'short',year:'numeric'
      });

      const key = 'DIA_' + i;
      const st = agendaEstados[key] || 'PENDIENTE';

      const chipClass =
        st === 'EN_SITIO' ? 'ensitio' :
        st === 'COMPLETADO' ? 'completado' :
        'pendiente';

      html += `
        <div class="agenda-dia" data-key="${key}">
          <div class="agenda-fecha">${fechaTexto}</div>
          <div class="agenda-turno">Turno ${t.idTurno || 'TURNO'}</div>

          <div class="agenda-detalle">
            <strong>Cliente:</strong> ${t.cliente || 'Cruz Verde'}
          </div>
          <div class="agenda-detalle">
            <strong>Representante:</strong> Miguel Orozco
          </div>
          <div class="agenda-detalle">
            <strong>Dirección:</strong> ${t.direccion || 'Dirección por definir'}
          </div>
          <div class="agenda-detalle">
            <strong>Hora de llegada:</strong> ${formatearHora(t.hora) || '08:00 a.m.'}
          </div>

          <div class="agenda-estado-row">
            <span class="estado-chip ${chipClass}" id="chip_${key}">
              ${st === 'EN_SITIO' ? 'EN SITIO' : (st === 'COMPLETADO' ? 'COMPLETADO' : 'PENDIENTE')}
            </span>

            <div class="mini-switch ${chipClass}" id="sw_${key}" onclick="toggleEstadoAgenda('${key}', '${t.idTurno || ''}')">
              <div class="knob"></div>
            </div>
          </div>
        </div>
      `;
    }

    estado.style.color = '#bbf7d0';
    estado.textContent = 'Tu próximo turno activo:';
    cont.innerHTML = html;
  }

  async function toggleEstadoAgenda(key, idTurno){
    if(!ultimaAceptacion || !ultimaAceptacion.turno) return;

    const actual = agendaEstados[key] || 'PENDIENTE';
    if(actual === 'COMPLETADO') return;

    const siguiente = (actual === 'PENDIENTE') ? 'EN_SITIO' : 'COMPLETADO';

    // UI optimista: bloquea si va a completado
    const chip = document.getElementById('chip_' + key);
    const sw = document.getElementById('sw_' + key);

    if(chip){
      chip.textContent = (siguiente === 'EN_SITIO') ? 'EN SITIO' : 'COMPLETADO';
      chip.className = 'estado-chip ' + (siguiente === 'EN_SITIO' ? 'ensitio' : 'completado');
    }
    if(sw){
      sw.className = 'mini-switch ' + (siguiente === 'EN_SITIO' ? 'ensitio' : 'completado');
    }

    // Notificar backend
    try{
      const t = ultimaAceptacion.turno;

      const formData = new URLSearchParams();
      formData.append('accion','actualizar_estado_turno');
      formData.append('idContrato', idContratoActual || '');
      formData.append('idTurno', idTurno || '');
      formData.append('estado', siguiente); // EN_SITIO / COMPLETADO
      formData.append('fechaHora', new Date().toISOString());

      // datos informativos para el correo
      formData.append('cliente', t.cliente || 'Cruz Verde');
      formData.append('direccion', t.direccion || '');
      formData.append('fecha', t.fecha || '');
      formData.append('hora', t.hora || '');
      formData.append('ciudad', t.ciudad || 'Bogotá');
      formData.append('dias', String(t.dias || 3));
      formData.append('correoCliente', t.correoCliente || '');

      const resp = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: formData.toString()
      });

      const data = await resp.json();
      if(!data.ok){
        // si falla, revertimos UI al estado anterior
        agendaEstados[key] = actual;

        if(chip){
          const cls =
            actual === 'EN_SITIO' ? 'ensitio' :
            actual === 'COMPLETADO' ? 'completado' :
            'pendiente';
          chip.textContent = (actual === 'EN_SITIO') ? 'EN SITIO' : (actual === 'COMPLETADO' ? 'COMPLETADO' : 'PENDIENTE');
          chip.className = 'estado-chip ' + cls;
        }
        if(sw){
          const cls =
            actual === 'EN_SITIO' ? 'ensitio' :
            actual === 'COMPLETADO' ? 'completado' :
            'pendiente';
          sw.className = 'mini-switch ' + cls;
        }
        alert(data.error || 'No fue posible actualizar el estado.');
        return;
      }

      // confirma en memoria
      agendaEstados[key] = siguiente;

    }catch(e){
      console.error(e);
      // revertir UI
      agendaEstados[key] = actual;

      if(chip){
        const cls =
          actual === 'EN_SITIO' ? 'ensitio' :
          actual === 'COMPLETADO' ? 'completado' :
          'pendiente';
        chip.textContent = (actual === 'EN_SITIO') ? 'EN SITIO' : (actual === 'COMPLETADO' ? 'COMPLETADO' : 'PENDIENTE');
        chip.className = 'estado-chip ' + cls;
      }
      if(sw){
        const cls =
          actual === 'EN_SITIO' ? 'ensitio' :
          actual === 'COMPLETADO' ? 'completado' :
          'pendiente';
        sw.className = 'mini-switch ' + cls;
      }

      alert('Error de conexión al actualizar el estado.');
    }
  }
</script>
</body>
</html>
