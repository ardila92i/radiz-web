<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>RADIZ LOGÍSTICA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    *{box-sizing:border-box}

    body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#0f172a;
      color:#111827;
    }

    .page{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:32px 16px;
    }

    .container{
      width:100%;
      max-width:1080px;
      background:#f5f6f8;
      border-radius:24px;
      box-shadow:0 18px 45px rgba(15,23,42,.4);
      padding:24px 28px 28px;
      position:relative;
    }

    /* Logo */
    .logo-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:10px;
    }
    .logo-top img{
      max-width:210px;
      max-height:80px;
      object-fit:contain;
    }
    .badge-version{
      padding:4px 10px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:600;
      background:#e5e7eb;
      color:#4b5563;
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    /* Header principal */
    .header-main{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap:18px;
      margin-bottom:18px;
    }
    .header-title h1{
      margin:0 0 4px;
      font-size:1.8rem;
      letter-spacing:.03em;
      color:#111827;
    }
    .header-title p{
      margin:0;
      font-size:.9rem;
      color:#4b5563;
    }

    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      font-size:.85rem;
    }
    .pill-contrato{
      padding:6px 12px;
      border-radius:999px;
      background:#1e293b;
      color:#e5e7eb;
      font-weight:600;
      font-size:.8rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill-contrato span{
      font-size:.8rem;
      text-transform:uppercase;
      opacity:.8;
    }
    .tag-ciudad{
      font-size:.8rem;
      padding:3px 8px;
      border-radius:999px;
      background:#e0f2fe;
      color:#1d4ed8;
      font-weight:500;
    }

    /* Layout dos columnas en desktop */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.1fr);
      gap:20px;
    }

    .card{
      position:relative;
      border-radius:18px;
      border:1px solid #e5e7eb;
      padding:16px 18px;
      background:#ffffff;
      font-size:.9rem;
      transition:border-color .15s,box-shadow .15s,transform .1s,background .15s;
    }
    .card:hover{
      border-color:#2563eb;
      box-shadow:0 16px 34px rgba(37,99,235,.16);
      background:#f9fbff;
      transform:translateY(-1px);
    }
    .card h2{
      margin:0 0 8px;
      font-size:1.05rem;
      font-weight:700;
      color:#111827;
    }
    .card p{
      margin:3px 0;
      color:#111827;
      font-size:.9rem;
    }

    .card-small{
      padding:12px 14px;
      font-size:.85rem;
    }

    .subtitle{
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-weight:600;
      color:#6b7280;
      margin-bottom:4px;
    }

    /* Bloque "Mi vehículo" */
    .grid-mini{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
      margin-top:8px;
    }
    .stat{
      padding:8px 10px;
      border-radius:12px;
      background:#f3f4f6;
      font-size:.8rem;
    }
    .stat-label{
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#6b7280;
      margin-bottom:2px;
    }
    .stat-value{
      font-weight:600;
      color:#111827;
    }

    /* Filtros turnos */
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      margin-bottom:10px;
    }
    .filters-group{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .filters label{
      font-size:.8rem;
      font-weight:600;
      color:#4b5563;
    }
    select,input[type="date"]{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid #d1d5db;
      font-size:.85rem;
      outline:none;
      background:#f9fafb;
    }
    select:focus,input[type="date"]:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.18);
      background:#ffffff;
    }

    /* Lista de turnos */
    .turnos-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .turnos-header-title{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dot-live{
      width:10px;
      height:10px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 6px rgba(34,197,94,.25);
    }
    .turnos-header span{
      font-weight:600;
      font-size:.95rem;
    }
    .pill-contador{
      font-size:.8rem;
      padding:3px 8px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
    }

    .turnos-list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:6px;
    }

    .turno-card{
      border-radius:16px;
      border:1px solid #e5e7eb;
      padding:12px 14px;
      background:#ffffff;
      display:grid;
      grid-template-columns:minmax(0,2.3fr) minmax(0,1.3fr);
      gap:10px;
      transition:border-color .15s,box-shadow .15s,transform .1s,background .15s;
    }
    .turno-card:hover{
      border-color:#2563eb;
      box-shadow:0 16px 32px rgba(37,99,235,.15);
      background:#f9fbff;
      transform:translateY(-1px);
    }

    .turno-main h3{
      margin:0 0 2px;
      font-size:1rem;
      font-weight:700;
      color:#111827;
    }
    .turno-main .empresa{
      font-size:.85rem;
      color:#4b5563;
      margin-bottom:4px;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:4px;
      font-size:.75rem;
    }
    .chip{
      padding:2px 8px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
      font-weight:500;
    }
    .chip-urgente{
      background:#fee2e2;
      color:#b91c1c;
    }
    .chip-tipo{
      background:#dbeafe;
      color:#1d4ed8;
    }

    .turno-detalle{
      font-size:.8rem;
      color:#4b5563;
    }

    .turno-side{
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:6px;
      align-items:flex-end;
      font-size:.85rem;
    }
    .monto-principal{
      font-size:1rem;
      font-weight:700;
      color:#111827;
    }
    .monto-principal span{
      font-size:.8rem;
      font-weight:500;
      color:#4b5563;
    }
    .monto-bono{
      font-size:.8rem;
      color:#16a34a;
      font-weight:600;
    }
    .monto-total{
      font-size:.8rem;
      color:#111827;
    }

    .status-bar{
      font-size:.8rem;
      margin-top:4px;
      min-height:1.2em;
      color:#6b7280;
    }
    .status-bar.error{color:#b91c1c}
    .status-bar.ok{color:#065f46}

    /* Botones */
    button{
      padding:9px 18px;
      border-radius:999px;
      border:none;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      background:#2563eb;
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      box-shadow:0 10px 24px rgba(37,99,235,.45);
      transition:transform .1s,box-shadow .1s,background .1s;
      white-space:nowrap;
    }
    button:hover{
      transform:translateY(-1px);
      background:#1d4ed8;
      box-shadow:0 14px 32px rgba(37,99,235,.55);
    }
    button:disabled{
      opacity:.65;
      cursor:default;
      box-shadow:none;
      transform:none;
    }

    .btn-aceptar{
      min-width:150px;
    }
    .btn-secundario{
      background:#e5e7eb;
      color:#111827;
      box-shadow:none;
    }
    .btn-secundario:hover{
      background:#e0e7ff;
      box-shadow:none;
    }

    /* Card derecha: resumen rápido */
    .list-compact{
      list-style:none;
      padding-left:0;
      margin:6px 0;
      font-size:.85rem;
      color:#4b5563;
    }
    .list-compact li{
      margin-bottom:4px;
    }

    footer{
      margin-top:14px;
      font-size:.75rem;
      color:#9ca3af;
      text-align:center;
    }

    /* Responsivo */
    @media(max-width:900px){
      .layout{
        grid-template-columns:1fr;
      }
      .turno-card{
        grid-template-columns:1fr;
      }
      .header-right{
        align-items:flex-start;
      }
    }

    @media(max-width:640px){
      .container{
        padding:20px 16px 22px;
        border-radius:18px;
      }
      .header-main{
        flex-direction:column;
      }
      .logo-top{
        flex-direction:column;
        align-items:flex-start;
      }
      .turno-side{
        align-items:flex-start;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="container">
    <!-- Logo + versión -->
    <div class="logo-top">
      <img src="../logoradiz.png" alt="Logo RADIZ">
      <span class="badge-version">Logística · MVP 1</span>
    </div>

    <!-- Header -->
    <div class="header-main">
      <div class="header-title">
        <h1>Panel de turnos</h1>
        <p>Elige los servicios de mensajería que mejor se ajustan a tu vehículo y a tu ciudad.</p>
      </div>
      <div class="header-right">
        <div class="pill-contrato">
          <span>Contrato</span>
          <strong id="tagContrato">—</strong>
        </div>
        <div class="tag-ciudad" id="tagCiudad">Ciudad no definida</div>
      </div>
    </div>

    <div class="layout">
      <!-- Columna izquierda: Mi vehículo + turnos disponibles -->
      <div>
        <!-- Card: Mi vehículo / resumen rápido -->
        <section class="card card-small" id="cardVehiculo">
          <div class="subtitle">Mi vehículo</div>
          <h2>Resumen de tu contrato</h2>
          <div class="grid-mini">
            <div class="stat">
              <div class="stat-label">Placa / ID</div>
              <div class="stat-value" id="vehPlaca">—</div>
            </div>
            <div class="stat">
              <div class="stat-label">Tarifa semanal</div>
              <div class="stat-value" id="vehTarifa">—</div>
            </div>
            <div class="stat">
              <div class="stat-label">Estado</div>
              <div class="stat-value" id="vehEstado">—</div>
            </div>
            <div class="stat">
              <div class="stat-label">Ciudad base</div>
              <div class="stat-value" id="vehCiudad">—</div>
            </div>
          </div>
        </section>

        <!-- Card: Turnos disponibles -->
        <section class="card" style="margin-top:14px;">
          <div class="turnos-header">
            <div class="turnos-header-title">
              <span class="dot-live"></span>
              <span>Turnos disponibles</span>
            </div>
            <span class="pill-contador" id="turnosContador">0 turnos</span>
          </div>

          <!-- Filtros sencillos -->
          <div class="filters">
            <div class="filters-group">
              <label for="filtroCiudad">Ciudad</label>
              <select id="filtroCiudad">
                <option value="">Todas</option>
                <option value="Bogotá">Bogotá</option>
                <option value="Chía">Chía</option>
                <option value="Cajicá">Cajicá</option>
              </select>
            </div>
            <div class="filters-group">
              <label for="filtroFecha">Fecha</label>
              <input type="date" id="filtroFecha">
            </div>
            <button type="button" class="btn-secundario" onclick="aplicarFiltros()">Filtrar</button>
          </div>

          <div id="estadoTurnos" class="status-bar"></div>

          <div class="turnos-list" id="listaTurnos">
            <!-- Aquí se pintan las tarjetas de turnos -->
          </div>
        </section>
      </div>

      <!-- Columna derecha: Mi agenda -->
      <div>
        <section class="card card-small">
          <div class="subtitle">Mi agenda</div>
          <h2>Turnos asignados (próximamente)</h2>
          <p style="font-size:.85rem;color:#4b5563;margin-bottom:6px;">
            En esta sección verás los turnos que aceptes, con su estado y resumen de recaudo.
          </p>
          <ul class="list-compact">
            <li>• Estado de cada turno (Pendiente, En curso, Finalizado).</li>
            <li>• Resumen de pagos por empresa.</li>
            <li>• Historial de servicios realizados.</li>
          </ul>
          <p style="font-size:.8rem;color:#6b7280;margin-top:8px;">
            En la versión MVP sólo activamos la aceptación de turnos.
            El panel de agenda y recaudos se conectará en la siguiente etapa.
          </p>
        </section>

        <section class="card card-small" style="margin-top:14px;">
          <div class="subtitle">Recomendaciones</div>
          <h2>Antes de aceptar un turno</h2>
          <ul class="list-compact">
            <li>Verifica que la ciudad y horarios se ajusten a tu disponibilidad.</li>
            <li>Confirma que tu moto cumple los requisitos (cilindraje, baúl, SOAT, revisión).</li>
            <li>Ten saldo en tu celular para datos y WhatsApp durante todo el servicio.</li>
          </ul>
        </section>
      </div>
    </div>

    <footer>Versión interna · RADIZ Logística</footer>
  </div>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxNiAZCMVvaagzFjYQgIsQkGEWJPui9baIHcO_-JjeJ6HvDYdDU5BdH8R6zzD3zDUw/exec';
  let idContratoGlobal = null;
  let turnosData = [];

  document.addEventListener('DOMContentLoaded', function(){
    const params = new URLSearchParams(window.location.search);
    idContratoGlobal = (params.get('id') || '').trim().toUpperCase();

    const tagContrato = document.getElementById('tagContrato');
    if (idContratoGlobal) {
      tagContrato.textContent = idContratoGlobal;
      // Guardamos en localStorage para futuras sesiones
      try {
        localStorage.setItem('radiz_contrato_logistica', idContratoGlobal);
      } catch (e) {}
    } else {
      // Intentar recuperar de localStorage
      try {
        const saved = localStorage.getItem('radiz_contrato_logistica') || '';
        if (saved) {
          idContratoGlobal = saved.toUpperCase();
          tagContrato.textContent = idContratoGlobal;
        }
      } catch (e) {}
    }

    if (!idContratoGlobal) {
      tagContrato.textContent = 'Sin ID';
      alert('No se encontró el ID de contrato. Regresa al portal principal e inicia sesión de nuevo.');
    }

    cargarResumenContrato();
    cargarTurnosPublicados();
  });

  // --- Resumen de contrato usando el mismo doGet?id= ---
  async function cargarResumenContrato(){
    if (!idContratoGlobal) return;

    const estadoTurnos = document.getElementById('estadoTurnos');
    try {
      const resp = await fetch(API_URL + '?id=' + encodeURIComponent(idContratoGlobal));
      const data = await resp.json();

      if (!data.ok) {
        return;
      }
      const c = data.contrato || {};
      const vehiculos = data.vehiculos || [];

      const placa = (c['ID VEHÍCULO'] || c['ID VEHICULO'] || '');
      const tarifa = c['TARIFA SEMANAL'] || '';
      const estado = (c['ESTADO'] || '').toString().toUpperCase() || 'SIN ESTADO';

      // Intentamos ciudad desde hoja VEHÍCULOS o campo CIUDAD
      let ciudad = c['CIUDAD'] || '';
      if (!ciudad && vehiculos && vehiculos.length) {
        const v = vehiculos.find(function(row){
          return String(row['ID CONTRATO'] || '').toString().trim().toUpperCase() === idContratoGlobal;
        });
        if (v) ciudad = v['CIUDAD'] || '';
      }

      document.getElementById('vehPlaca').textContent = placa || 'No definido';
      document.getElementById('vehTarifa').textContent = formatearCOP(tarifa);
      document.getElementById('vehEstado').textContent = estado;
      document.getElementById('vehCiudad').textContent = ciudad || '—';
      document.getElementById('tagCiudad').textContent = ciudad || 'Ciudad no definida';
    } catch (e) {
      console.error(e);
      if (estadoTurnos && !estadoTurnos.textContent) {
        estadoTurnos.className = 'status-bar error';
        estadoTurnos.textContent = 'No se pudo cargar el resumen del contrato.';
      }
    }
  }

  // --- Cargar turnos publicados ---
  async function cargarTurnosPublicados(){
    const estadoTurnos = document.getElementById('estadoTurnos');
    const lista = document.getElementById('listaTurnos');
    const contador = document.getElementById('turnosContador');

    estadoTurnos.className = 'status-bar';
    estadoTurnos.textContent = 'Cargando turnos disponibles...';

    try{
      const resp = await fetch(API_URL + '?accion=get_turnos_publicados');
      const data = await resp.json();

      if (!data.ok){
        estadoTurnos.className = 'status-bar error';
        estadoTurnos.textContent = data.error || 'No se pudieron cargar los turnos.';
        return;
      }

      turnosData = Array.isArray(data.turnos) ? data.turnos : [];
      pintarTurnos(turnosData);

      contador.textContent = turnosData.length === 1
        ? '1 turno disponible'
        : turnosData.length + ' turnos disponibles';

      if (turnosData.length === 0){
        estadoTurnos.className = 'status-bar';
        estadoTurnos.textContent = 'Por ahora no hay turnos publicados. Intenta más tarde.';
      }else{
        estadoTurnos.className = 'status-bar ok';
        estadoTurnos.textContent = 'Elige un turno y confírmalo para continuar.';
      }
    }catch(e){
      console.error(e);
      estadoTurnos.className = 'status-bar error';
      estadoTurnos.textContent = 'Error al cargar los turnos. Revisa tu conexión e intenta de nuevo.';
    }
  }

  function pintarTurnos(listaOrigen){
    const lista = document.getElementById('listaTurnos');
    lista.innerHTML = '';

    if (!listaOrigen || !listaOrigen.length){
      lista.innerHTML = '<p style="font-size:.85rem;color:#6b7280;">No hay turnos que coincidan con los filtros seleccionados.</p>';
      return;
    }

    listaOrigen.forEach(function(t){
      const idTurno = t.idTurno || '';
      const empresa = t.empresa || '';
      const ciudad = t.ciudad || '';
      const zonificacion = t.zonificacion || '';
      const tipo = t.tipo || '';
      const tipoPaqueteria = t.tipoPaqueteria || '';
      const descripcion = t.descripcion || '';
      const paradas = t.paradas != null ? t.paradas : '';
      const fechaISO = t.fecha || '';
      const inicio = t.inicio || '';
      const cierre = t.cierre || '';
      const valorTurno = Number(t.valorTurno || 0);
      const bonificacion = Number(t.bonificacion || 0);
      const total = valorTurno + bonificacion;
      const requisitos = t.requisitos || '';

      const fechaFormateada = formatearFecha(fechaISO);

      const card = document.createElement('article');
      card.className = 'turno-card';

      const main = document.createElement('div');
      main.className = 'turno-main';

      const h3 = document.createElement('h3');
      h3.textContent = 'Turno ' + idTurno;
      main.appendChild(h3);

      const emp = document.createElement('div');
      emp.className = 'empresa';
      emp.textContent = empresa;
      main.appendChild(emp);

      const chips = document.createElement('div');
      chips.className = 'chips';

      if (ciudad){
        const chipCiudad = document.createElement('span');
        chipCiudad.className = 'chip';
        chipCiudad.textContent = ciudad + (zonificacion ? ' · ' + zonificacion : '');
        chips.appendChild(chipCiudad);
      }

      if (tipoPaqueteria){
        const chipTipo = document.createElement('span');
        chipTipo.className = 'chip chip-tipo';
        chipTipo.textContent = tipoPaqueteria;
        chips.appendChild(chipTipo);
      }

      if (tipo){
        const chipModo = document.createElement('span');
        chipModo.className = 'chip';
        chipModo.textContent = tipo;
        chips.appendChild(chipModo);
      }

      if (paradas){
        const chipParadas = document.createElement('span');
        chipParadas.className = 'chip';
        chipParadas.textContent = paradas + ' paradas';
        chips.appendChild(chipParadas);
      }

      main.appendChild(chips);

      const detalle = document.createElement('div');
      detalle.className = 'turno-detalle';
      detalle.textContent =
        (fechaFormateada ? fechaFormateada + ' · ' : '') +
        (inicio ? inicio : '') +
        (cierre ? ' - ' + cierre : '');
      main.appendChild(detalle);

      if (descripcion){
        const descP = document.createElement('p');
        descP.style.marginTop = '4px';
        descP.style.fontSize = '.85rem';
        descP.style.color = '#4b5563';
        descP.textContent = descripcion;
        main.appendChild(descP);
      }

      if (requisitos){
        const reqP = document.createElement('p');
        reqP.style.marginTop = '4px';
        reqP.style.fontSize = '.8rem';
        reqP.style.color = '#6b7280';
        reqP.textContent = 'Requisitos: ' + requisitos;
        main.appendChild(reqP);
      }

      const side = document.createElement('div');
      side.className = 'turno-side';

      const montos = document.createElement('div');
      const mPrincipal = document.createElement('div');
      mPrincipal.className = 'monto-principal';
      mPrincipal.innerHTML = formatearCOP(valorTurno) + ' <span>turno</span>';

      const mBono = document.createElement('div');
      mBono.className = 'monto-bono';
      if (bonificacion > 0){
        mBono.textContent = '+ ' + formatearCOP(bonificacion) + ' bono';
      }else{
        mBono.textContent = 'Sin bonificación';
        mBono.style.color = '#6b7280';
      }

      const mTotal = document.createElement('div');
      mTotal.className = 'monto-total';
      mTotal.textContent = 'Total estimado: ' + formatearCOP(total);

      montos.appendChild(mPrincipal);
      montos.appendChild(mBono);
      montos.appendChild(mTotal);
      side.appendChild(montos);

      const btnRow = document.createElement('div');
      btnRow.style.display = 'flex';
      btnRow.style.flexWrap = 'wrap';
      btnRow.style.gap = '6px';

      const btnAceptar = document.createElement('button');
      btnAceptar.type = 'button';
      btnAceptar.className = 'btn-aceptar';
      btnAceptar.textContent = 'Aceptar turno';
      btnAceptar.onclick = function(){
        aceptarTurno(idTurno, btnAceptar);
      };

      const btnInfo = document.createElement('button');
      btnInfo.type = 'button';
      btnInfo.className = 'btn-secundario';
      btnInfo.textContent = 'Ver en WhatsApp';
      btnInfo.onclick = function(){
        compartirTurnoWhatsapp(idTurno);
      };

      btnRow.appendChild(btnAceptar);
      btnRow.appendChild(btnInfo);

      side.appendChild(btnRow);

      card.appendChild(main);
      card.appendChild(side);
      lista.appendChild(card);
    });
  }

  function aplicarFiltros(){
    const ciudadSel = document.getElementById('filtroCiudad').value;
    const fechaSel = document.getElementById('filtroFecha').value;

    const filtrados = turnosData.filter(function(t){
      let ok = true;
      if (ciudadSel){
        ok = ok && (t.ciudad === ciudadSel);
      }
      if (fechaSel){
        const fechaISO = (t.fecha || '').substring(0,10);
        ok = ok && (fechaISO === fechaSel);
      }
      return ok;
    });

    pintarTurnos(filtrados);
    const contador = document.getElementById('turnosContador');
    contador.textContent = filtrados.length === 1
      ? '1 turno disponible'
      : filtrados.length + ' turnos disponibles';
  }

  function formatearCOP(valor){
    const num = Number(valor);
    if (isNaN(num)) return '—';
    return num.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
  }

  function formatearFecha(fechaISO){
    if (!fechaISO) return '';
    try{
      const d = new Date(fechaISO);
      if (isNaN(d.getTime())) return fechaISO;
      return d.toLocaleDateString('es-CO');
    }catch(e){
      return fechaISO;
    }
  }

  // --- Aceptar turno (usa accion=asignar_turno en Apps Script) ---
  async function aceptarTurno(idTurno, boton){
    if (!idContratoGlobal){
      alert('No encontramos tu contrato. Regresa al portal principal e inicia sesión de nuevo.');
      return;
    }

    const confirmar = confirm('¿Aceptar el turno ' + idTurno + ' con el contrato ' + idContratoGlobal + '?');
    if (!confirmar) return;

    boton.disabled = true;
    const estadoTurnos = document.getElementById('estadoTurnos');
    estadoTurnos.className = 'status-bar';
    estadoTurnos.textContent = 'Registrando tu aceptación...';

    try{
      const formData = new URLSearchParams();
      formData.append('accion','asignar_turno');
      formData.append('idTurno',idTurno);
      formData.append('idContrato',idContratoGlobal);

      const resp = await fetch(API_URL,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:formData.toString()
      });
      const data = await resp.json();

      if (data.ok){
        estadoTurnos.className = 'status-bar ok';
        estadoTurnos.textContent = 'Turno aceptado correctamente. Pronto verás el detalle en tu agenda.';
        boton.textContent = 'Turno aceptado';
      }else{
        estadoTurnos.className = 'status-bar error';
        estadoTurnos.textContent = data.error || 'No fue posible registrar la aceptación del turno.';
        boton.disabled = false;
      }
    }catch(e){
      console.error(e);
      estadoTurnos.className = 'status-bar error';
      estadoTurnos.textContent = 'Error de conexión al registrar el turno.';
      boton.disabled = false;
    }
  }

  // --- Compartir turno por WhatsApp (apoyo operativo) ---
  function compartirTurnoWhatsapp(idTurno){
    const turno = (turnosData || []).find(function(t){ return t.idTurno === idTurno; });
    let texto = 'Hola, quiero más información del turno ' + idTurno;
    if (turno){
      const ciudad = turno.ciudad || '';
      const empresa = turno.empresa || '';
      const fecha = formatearFecha(turno.fecha || '');
      texto += ' (' + (empresa || '') + (ciudad ? ', ' + ciudad : '') + (fecha ? ', ' + fecha : '') + ').';
    }
    const url = 'https://wa.me/573159406263?text=' + encodeURIComponent(texto);
    window.open(url,'_blank');
  }
</script>
</body>
</html>
